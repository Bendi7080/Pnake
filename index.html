<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PNAKE: LEGENDS ULTIMATE</title>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        /* –ë–ê–ó–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –≠–ö–†–ê–ù–ê */
        body { 
            margin: 0; 
            background: #000; 
            overflow: hidden; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            touch-action: none; 
            color: white; 
            -webkit-user-select: none;
        }

        #game-container { 
            width: 100vw; 
            height: 100vh; 
            display: block; 
        }

        /* –†–û–ó–û–í–´–ô –ò–ù–¢–ï–†–§–ï–ô–° (–¢–í–û–ô –î–ò–ó–ê–ô–ù) */
        .ui-screen { 
            position: absolute; 
            inset: 0; 
            background: radial-gradient(circle at center, #1a0a1a 0%, #000 100%); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            transition: opacity 0.5s ease;
        }

        .auth-card { 
            background: rgba(255, 255, 255, 0.03); 
            padding: 40px; 
            border-radius: 35px; 
            border: 1px solid rgba(255, 182, 193, 0.3); 
            text-align: center; 
            box-shadow: 0 0 40px rgba(255, 105, 180, 0.15); 
            backdrop-filter: blur(10px);
            width: 280px;
        }

        h1 { 
            color: #ffb6c1; 
            margin: 0 0 25px 0; 
            letter-spacing: 7px; 
            font-size: 36px;
            text-shadow: 0 0 15px rgba(255, 182, 193, 0.5);
        }

        /* –ü–û–õ–Ø –í–í–û–î–ê */
        input { 
            display: block; 
            width: 100%; 
            padding: 15px; 
            margin: 12px 0; 
            border-radius: 12px; 
            border: 1px solid #333; 
            background: rgba(0,0,0,0.5); 
            color: white; 
            outline: none; 
            box-sizing: border-box; 
            font-size: 16px;
            transition: 0.3s;
        }

        input:focus { 
            border-color: #ffb6c1; 
            box-shadow: 0 0 12px rgba(255, 182, 193, 0.3); 
        }

        /* –ì–õ–ê–í–ù–ê–Ø –ö–ù–û–ü–ö–ê */
        button { 
            width: 100%; 
            padding: 16px; 
            border-radius: 30px; 
            border: none; 
            background: linear-gradient(45deg, #ffb6c1, #ff69b4); 
            color: white; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 18px; 
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
            transition: 0.2s;
        }

        button:active { transform: scale(0.96); }

        .hidden { opacity: 0; pointer-events: none; visibility: hidden; }
    </style>
</head>
<body>

    <div id="auth-screen" class="ui-screen">
        <div class="auth-card">
            <h1>PNAKE</h1>
            <input type="text" id="nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" autocomplete="off">
            <input type="password" id="pass" placeholder="–ü–ê–†–û–õ–¨">
            <button id="login-btn">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="game-container"></div>

    <script>
        // –§–ò–ö–° –ö–õ–ê–í–ò–ê–¢–£–†–´ (—á—Ç–æ–±—ã —ç–∫—Ä–∞–Ω –Ω–µ —É–ª–µ—Ç–∞–ª)
        window.addEventListener('focusout', () => { window.scrollTo(0, 0); });
        
        // –ó–î–ï–°–¨ –ë–£–î–£–¢ –°–õ–ï–î–£–Æ–©–ò–ï –†–ê–ó–î–ï–õ–´...
        /**
 * 2.1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø (–î–ê–ù–ù–´–ï –ò–ó –ö–û–ù–°–û–õ–ò)
 */
const firebaseConfig = {
    apiKey: "AIzaSyCr28iNiurXgoZwbxOfast8R26ZiwVAR5Y",
    authDomain: "pnake3.firebaseapp.com",
    databaseURL: "https://pnake3-default-rtdb.firebaseio.com", //
    projectId: "pnake3",
    storageBucket: "pnake3.firebasestorage.app",
    messagingSenderId: "796701048320",
    appId: "1:796701048320:web:d88d06ada6e6e15a52e2e5"
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/**
 * 2.2. –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ú–ï–ù–ï–î–ñ–ï–† –°–û–°–¢–û–Ø–ù–ò–Ø (APP ENGINE)
 */
const App = 
    checkDailyReward: function() {
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;
        // –ï—Å–ª–∏ –±–æ–Ω—É—Å–∞ –Ω–µ –±—ã–ª–æ –∏–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 24 —á–∞—Å–æ–≤
        if (!this.user.lastBonus || (now - this.user.lastBonus) > oneDay) {
            this.user.coins += 50;
            this.user.lastBonus = now;
            this.save();
            return true;
        }
        return false;
    }
};
    user: null, // –ó–¥–µ—Å—å –±—É–¥—É—Ç –ª–µ–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
    
    // –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
    defaultData: {
        coins: 100,
        level: 1,
        xp: 0,
        highScore: 0,
        selectedSkin: 'classic',
        inventory: ['classic'],
        lastLogin: Date.now()
    },

    /**
     * –ú–ï–¢–û–î –°–û–•–†–ê–ù–ï–ù–ò–Ø: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ Firebase
     */
    save: function() {
        if (this.user && this.user.nick) {
            db.ref('users/' + this.user.nick).update(this.user)
                .then(() => console.log("Data synced with Cloud"))
                .catch((e) => console.error("Sync error:", e));
        }
    },

    /**
     * –ú–ï–¢–û–î –û–ë–ù–û–í–õ–ï–ù–ò–Ø XP: –õ–æ–≥–∏–∫–∞ —É—Ä–æ–≤–Ω–µ–π
     */
    addXP: function(amount) {
        if (!this.user) return;
        this.user.xp += amount;
        
        // –§–æ—Ä–º—É–ª–∞ —É—Ä–æ–≤–Ω—è: –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å —Ç—Ä–µ–±—É–µ—Ç –Ω–∞ 100 XP –±–æ–ª—å—à–µ
        let nextLevelXP = this.user.level * 100;
        if (this.user.xp >= nextLevelXP) {
            this.user.level++;
            this.user.xp = 0;
            return true; // –í–µ—Ä–Ω–µ—Ç true, –µ—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—Å–∏–ª—Å—è (–¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏)
        }
        return false;
    }
};

/**
 * 2.3. –ú–û–ù–ò–¢–û–†–ò–ù–ì –°–û–ï–î–ò–ù–ï–ù–ò–Ø
 */
db.ref(".info/connected").on("value", (snap) => {
    if (snap.val() === true) {
        console.log("Database status: ONLINE");
    } else {
        console.warn("Database status: OFFLINE");
    }
});
        /**
 * 3.1. –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–õ–ò–ö–ê –ü–û –ö–ù–û–ü–ö–ï "–í–û–ô–¢–ò"
 */
document.getElementById('login-btn').onclick = async function() {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ç–≤–æ–∏—Ö ID
    const nick = document.getElementById('nick').value.trim();
    const pass = document.getElementById('pass').value.trim();
    const btn = this;

    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ—Ç—É
    if (!nick || !pass) {
        alert("–≠–π! –ê –∫—Ç–æ –≤–≤–æ–¥–∏—Ç—å –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å –±—É–¥–µ—Ç?");
        return;
    }

    // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –∑–∞–≥—Ä—É–∑–∫–∏
    btn.innerText = "–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø...";
    btn.disabled = true;

    try {
        // –°—Ç—É—á–∏–º—Å—è –≤ —Ç–≤–æ—é –±–∞–∑—É pnake3
        const userRef = db.ref('users/' + nick);
        const snapshot = await userRef.get();

        if (!snapshot.exists()) {
            // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ù–û–í–û–ì–û –ò–ì–†–û–ö–ê
            if (confirm(`–ù–∏–∫ "${nick}" —Å–≤–æ–±–æ–¥–µ–Ω. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ª–µ–≥–µ–Ω–¥—É?`)) {
                const newUser = {
                    ...App.defaultData, // –ë–µ—Ä–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –†–∞–∑–¥–µ–ª–∞ 2
                    nick: nick,
                    password: pass,
                };
                
                await userRef.set(newUser);
                alert("–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –ñ–º–∏ –≤–æ–π—Ç–∏ –µ—â–µ —Ä–∞–∑.");
            }
        } else {
            // –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û –ò–ì–†–û–ö–ê
            const userData = snapshot.val();
            
            if (userData.password === pass) {
                // –ü–ê–†–û–õ–¨ –í–ï–†–ï–ù
                console.log("–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–ª—è:", nick);
                App.user = userData;
                
                // –≠—Ñ—Ñ–µ–∫—Ç–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —ç–∫—Ä–∞–Ω–∞ –≤—Ö–æ–¥–∞
                document.getElementById('auth-screen').classList.add('hidden');
                
                // –ó–ê–ü–£–°–ö –ò–ì–†–û–í–û–ì–û –î–í–ò–ñ–ö–ê (–ø–µ—Ä–µ—Ö–æ–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)
                if (window.game && window.game.scene) {
                    window.game.scene.start('MenuScene', 'BootScene');
                }
            } else {
                // –û–®–ò–ë–ö–ê –ü–ê–†–û–õ–Ø
                alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
            }
        }
    } catch (error) {
        console.error("Firebase Error:", error);
        alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –±–∞–∑–æ–π: " + error.message);
    } finally {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        btn.innerText = "–í–û–ô–¢–ò";
        btn.disabled = false;
    }
};

/**
 * 3.2. –ê–í–¢–û-–§–û–ö–£–° –ü–†–ò –ù–ê–ñ–ê–¢–ò–ò ENTER
 */
document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('login-btn').click();
    }
});
        /**
 * 4.1. –°–¶–ï–ù–ê –ì–õ–ê–í–ù–û–ì–û –ú–ï–ù–Æ (MENU SCENE)
 */
class MenuScene extends Phaser.Scene {
    constructor() {
        super('MenuScene');
    }

    create() {
        if (App.checkDailyReward()) {
    alert("üéÅ –ï–ñ–ï–î–ù–ï–í–ù–´–ô –ë–û–ù–£–°: +50 –∑–º–µ–Ω–µ—Ç!");
}
        const { width, height } = this.scale;

        // –§–æ–Ω –º–µ–Ω—é (–Ω–µ–æ–Ω–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ)
        this.add.rectangle(width/2, height/2, width, height, 0x000000);
        
        // –†–ê–ó–î–ï–õ 4.2: –ó–ê–ì–û–õ–û–í–û–ö –ò –ü–†–ò–í–ï–¢–°–¢–í–ò–ï
        this.add.text(width/2, 100, "PNAKE LEGENDS", { 
            fontSize: '38px', 
            fill: '#ffb6c1', 
            fontStyle: 'bold',
            stroke: '#ff69b4',
            strokeThickness: 2
        }).setOrigin(0.5);

        this.add.text(width/2, 160, `–î–û–ë–†–û –ü–û–ñ–ê–õ–û–í–ê–¢–¨, ${App.user.nick}`, { 
            fontSize: '18px', 
            fill: '#ffffff',
            letterSpacing: 2
        }).setOrigin(0.5);

        // –†–ê–ó–î–ï–õ 4.3: –ö–ê–†–¢–û–ß–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò (–î–ê–ù–ù–´–ï –ò–ó FIREBASE)
        const statsY = 300;
        // –†–∞–º–∫–∞ –¥–ª—è —Å—Ç–∞—Ç–æ–≤
        this.add.rectangle(width/2, statsY, 280, 160, 0xffffff, 0.03)
            .setStrokeStyle(1, 0xffb6c1, 0.3);

        const style = { fontSize: '20px', fill: '#ffffff', fontStyle: '500' };
        
        this.add.text(width/2 - 100, statsY - 40, "–£–†–û–í–ï–ù–¨:", style).setOrigin(0, 0.5);
        this.add.text(width/2 + 100, statsY - 40, App.user.level, { ...style, fill: '#ffb6c1' }).setOrigin(1, 0.5);

        this.add.text(width/2 - 100, statsY, "–ú–û–ù–ï–¢–´:", style).setOrigin(0, 0.5);
        this.add.text(width/2 + 100, statsY, App.user.coins, { ...style, fill: '#ffd700' }).setOrigin(1, 0.5);

        this.add.text(width/2 - 100, statsY + 40, "–†–ï–ö–û–†–î:", style).setOrigin(0, 0.5);
        this.add.text(width/2 + 100, statsY + 40, App.user.highScore || 0, style).setOrigin(1, 0.5);

        // –†–ê–ó–î–ï–õ 4.4: –ö–ù–û–ü–ö–ê –ó–ê–ü–£–°–ö–ê –ò–ì–†–´
        let playBtn = this.add.container(width/2, height - 150);
        
        let btnBg = this.add.rectangle(0, 0, 240, 70, 0xffb6c1)
            .setInteractive({ useHandCursor: true });
        
        let btnText = this.add.text(0, 0, "–ù–ê–ß–ê–¢–¨ –ú–ò–°–°–ò–Æ", { 
            fontSize: '22px', 
            color: '#000', 
            fontStyle: 'bold' 
        }).setOrigin(0.5);

        playBtn.add([btnBg, btnText]);

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
        btnBg.on('pointerdown', () => {
            btnBg.setFillStyle(0xff69b4);
            this.tweens.add({
                targets: playBtn,
                scale: 0.95,
                duration: 100,
                onComplete: () => {
                    this.scene.start('GameScene');
                }
            });
        });

        // –≠—Ñ—Ñ–µ–∫—Ç –ø–∞—Ä–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏
        this.tweens.add({
            targets: playBtn,
            y: height - 155,
            duration: 1500,
            yoyo: true,
            loop: -1,
            ease: 'Sine.easeInOut'
        });
    }
}
  /**
 * 5.1. –û–°–ù–û–í–ù–ê–Ø –ò–ì–†–û–í–ê–Ø –°–¶–ï–ù–ê (GAME SCENE)
 */
class GameScene extends Phaser.Scene {
    constructor() {
        super('GameScene');
    }

    create() {
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è
        this.cellSize = 20; // –†–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏
        this.cols = 18;     // –®–∏—Ä–∏–Ω–∞ –≤ –∫–ª–µ—Ç–∫–∞—Ö
        this.rows = 32;     // –í—ã—Å–æ—Ç–∞ –≤ –∫–ª–µ—Ç–∫–∞—Ö
        
        // –†–ê–ó–î–ï–õ 5.2: –°–û–°–¢–û–Ø–ù–ò–ï –ó–ú–ï–ô–ö–ò
        this.snake = [
            {x: 9, y: 15}, // –ì–æ–ª–æ–≤–∞
            {x: 9, y: 16}, // –¢–µ–ª–æ
            {x: 9, y: 17}  // –•–≤–æ—Å—Ç
        ];
        
        this.direction = {x: 0, y: -1};     // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–≤–≤–µ—Ä—Ö)
        this.nextDirection = {x: 0, y: -1}; // –ë—É—Ñ–µ—Ä –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–µ–∑–∫–∏—Ö —Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤
        
        // –†–ê–ó–î–ï–õ 5.3: –ï–î–ê –ò –û–ß–ö–ò
        this.food = this.getNewFoodPosition();
        this.score = 0;
        
        // –ì—Ä—É–ø–ø—ã –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        this.snakeGraphics = this.add.group();
        this.foodGraphic = this.add.circle(0, 0, 8, 0x00ff00).setStrokeStyle(2, 0xffffff);
        
        // –†–ê–ó–î–ï–õ 5.4: –ò–ù–¢–ï–†–§–ï–ô–° –í –ò–ì–†–ï (HUD)
        this.scoreText = this.add.text(20, 20, `SCORE: 0`, { 
            fontSize: '18px', 
            fill: '#ffb6c1',
            fontStyle: 'bold' 
        });

        // –†–ê–ó–î–ï–õ 5.5: –£–ü–†–ê–í–õ–ï–ù–ò–ï (–°–í–ê–ô–ü-–°–ò–°–¢–ï–ú–ê)
        this.setupInput();

        // –†–ê–ó–î–ï–õ 5.6: –ò–ì–†–û–í–û–ô –¢–ê–ô–ú–ï–† (–°–ö–û–†–û–°–¢–¨)
        // –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è –∏–≥—Ä–æ–∫–∞
        const gameSpeed = Math.max(150 - (App.user.level * 2), 80);
        
        this.moveTimer = this.time.addEvent({
            delay: gameSpeed,
            callback: this.updateGame,
            callbackScope: this,
            loop: true
        });
    }

    /**
     * 5.7. –õ–û–ì–ò–ö–ê –ö–ê–ñ–î–û–ì–û –®–ê–ì–ê (TICK)
     */
    updateGame() {
        this.direction = this.nextDirection;
        
        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –≥–æ–ª–æ–≤—É
        const newHead = {
            x: this.snake[0].x + this.direction.x,
            y: this.snake[0].y + this.direction.y
        };

        // –†–ê–ó–î–ï–õ 5.8: –ü–†–û–í–ï–†–ö–ê –°–ú–ï–†–¢–ò (–°–¢–ï–ù–´ –ò –•–í–û–°–¢)
        if (this.isCollision(newHead)) {
            return this.gameOver();
        }

        this.snake.unshift(newHead);

        // –†–ê–ó–î–ï–õ 5.9: –ü–†–û–í–ï–†–ö–ê –ï–î–´
        if (newHead.x === this.food.x && newHead.y === this.food.y) {
            this.handleEating();
        } else {
            this.snake.pop(); // –£–¥–∞–ª—è–µ–º —Ö–≤–æ—Å—Ç, –µ—Å–ª–∏ –Ω–µ –ø–æ–µ–ª–∏
        }

        this.renderSnake();
    }

    /**
     * 5.10. –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–ï–î–ê–ù–ò–Ø
     */
    handleEating() {
        this.score += 10;
        this.scoreText.setText(`SCORE: ${this.score}`);
        
        // –ù–∞—á–∏—Å–ª—è–µ–º –≤–∞–ª—é—Ç—É –∏ –æ–ø—ã—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
        App.user.coins += 2;
        const leveledUp = App.addXP(15);
        
        if (leveledUp) {
            this.cameras.main.flash(500, 255, 182, 193); // –†–æ–∑–æ–≤–∞—è –≤—Å–ø—ã—à–∫–∞ –ø—Ä–∏ –ª–≤–ª-–∞–ø–µ
        }

        this.food = this.getNewFoodPosition();
        
        // –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –ø–æ–µ–¥–∞–Ω–∏–∏
        this.cameras.main.shake(100, 0.005);
    }

    isCollision(head) {
        // –°—Ç–µ–Ω—ã
        if (head.x < 0 || head.x >= this.cols || head.y < 0 || head.y >= this.rows) return true;
        // –•–≤–æ—Å—Ç
        for (let i = 1; i < this.snake.length; i++) {
            if (head.x === this.snake[i].x && head.y === this.snake[i].y) return true;
        }
        return false;
    }

    getNewFoodPosition() {
        let newPos;
        while (!newPos || this.snake.some(p => p.x === newPos.x && p.y === newPos.y)) {
            newPos = {
                x: Phaser.Math.Between(1, this.cols - 2),
                y: Phaser.Math.Between(2, this.rows - 2)
            };
        }
        return newPos;
    }

    renderSnake() {
        this.snakeGraphics.clear(true, true);
        this.snake.forEach((part, index) => {
            const isHead = index === 0;
            const color = isHead ? 0xffb6c1 : 0xff69b4;
            const rect = this.add.rectangle(
                part.x * this.cellSize, 
                part.y * this.cellSize, 
                this.cellSize - 2, 
                this.cellSize - 2, 
                color
            ).setOrigin(0);
            this.snakeGraphics.add(rect);
        });
        
        this.foodGraphic.setPosition(
            this.food.x * this.cellSize + this.cellSize/2, 
            this.food.y * this.cellSize + this.cellSize/2
        );
    }

    setupInput() {
        this.input.on('pointerdown', (pointer) => {
            const dx = pointer.x - (this.scale.width / 2);
            const dy = pointer.y - (this.scale.height / 2);

            if (Math.abs(dx) > Math.abs(dy)) {
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
                if (dx > 0 && this.direction.x === 0) this.nextDirection = {x: 1, y: 0};
                else if (dx < 0 && this.direction.x === 0) this.nextDirection = {x: -1, y: 0};
            } else {
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ
                if (dy > 0 && this.direction.y === 0) this.nextDirection = {x: 0, y: 1};
                else if (dy < 0 && this.direction.y === 0) this.nextDirection = {x: 0, y: -1};
            }
        });
    }

    gameOver() {
        this.moveTimer.remove();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª—É—á—à–∏–π —Å—á–µ—Ç
        if (this.score > (App.user.highScore || 0)) {
            App.user.highScore = this.score;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—ë –≤ Firebase –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
        App.save();
        
        this.cameras.main.fade(500, 0, 0, 0);
        this.time.delayedCall(500, () => {
            this.scene.start('MenuScene');
        });
    }
}
     /**
 * 6.1. –°–¶–ï–ù–ê –ú–ê–ì–ê–ó–ò–ù–ê (SHOP SCENE)
 */
class ShopScene extends Phaser.Scene {
    constructor() {
        super('ShopScene');
        // –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–∫–∏–Ω—ã
        this.skinList = [
            { id: 'classic', name: '–ö–õ–ê–°–°–ò–ö', cost: 0, head: 0xffb6c1, body: 0xff69b4 },
            { id: 'neon', name: '–ù–ï–û–ù', cost: 500, head: 0x00ffff, body: 0x0088ff },
            { id: 'gold', name: '–ó–û–õ–û–¢–û', cost: 1500, head: 0xffd700, body: 0xff8c00 },
            { id: 'emerald', name: '–ò–ó–£–ú–†–£–î', cost: 2500, head: 0x50c878, body: 0x006400 }
        ];
    }

    create() {
        const { width, height } = this.scale;
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        this.add.text(width/2, 60, "SNAKE SHOP", { fontSize: '32px', fill: '#ffb6c1', fontStyle: 'bold' }).setOrigin(0.5);
        this.add.text(width/2, 100, `–ë–ê–õ–ê–ù–°: ${App.user.coins} ü™ô`, { fontSize: '20px', fill: '#ffd700' }).setOrigin(0.5);
create() {
        const { width, height } = this.scale;

        // 1. –ó–ê–ì–û–õ–û–í–û–ö
        this.add.text(width/2, 80, "PNAKE LEGENDS", { 
            fontSize: '38px', fill: '#ffb6c1', fontStyle: 'bold' 
        }).setOrigin(0.5);

        // 2. –ë–õ–û–ö –°–¢–ê–¢–ò–°–¢–ò–ö–ò (–£–†–û–í–ï–ù–¨ –ò –ú–û–ù–ï–¢–´)
        const statsBox = this.add.container(width/2, 220);
        statsBox.add(this.add.rectangle(0, 0, 260, 120, 0xffffff, 0.05).setStrokeStyle(1, 0xffb6c1, 0.2));
        statsBox.add(this.add.text(0, -25, `–£–†–û–í–ï–ù–¨: ${App.user.level}`, { fontSize: '20px' }).setOrigin(0.5));
        statsBox.add(this.add.text(0, 25, `–ú–û–ù–ï–¢–´: ${App.user.coins} ü™ô`, { fontSize: '20px', fill: '#ffd700' }).setOrigin(0.5));

        // 3. –ö–ù–û–ü–ö–ê "–ò–ì–†–ê–¢–¨" (–¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø)
        let playBtn = this.add.container(width/2, 400);
        let pBg = this.add.rectangle(0, 0, 220, 65, 0xffb6c1).setInteractive({ useHandCursor: true });
        let pTxt = this.add.text(0, 0, "–ò–ì–†–ê–¢–¨", { fontSize: '24px', color: '#000', fontStyle: 'bold' }).setOrigin(0.5);
        playBtn.add([pBg, pTxt]);
        
        pBg.on('pointerdown', () => {
            this.tweens.add({ targets: playBtn, scale: 0.9, duration: 100, yoyo: true, 
                onComplete: () => this.scene.start('GameScene') 
            });
        });

        // 4. –í–û–¢ –û–ù–ê ‚Äî –ö–ù–û–ü–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê (–ß–£–¢–¨ –ù–ò–ñ–ï)
        let shopBtn = this.add.container(width/2, 500);
        let sBg = this.add.rectangle(0, 0, 220, 55, 0x333333).setInteractive({ useHandCursor: true });
        sBg.setStrokeStyle(2, 0xffb6c1); // –†–æ–∑–æ–≤–∞—è –æ–±–≤–æ–¥–∫–∞
        let sTxt = this.add.text(0, 0, "–ú–ê–ì–ê–ó–ò–ù üõí", { fontSize: '18px', color: '#ffb6c1' }).setOrigin(0.5);
        shopBtn.add([sBg, sTxt]);

        sBg.on('pointerdown', () => {
            this.tweens.add({ targets: shopBtn, scale: 0.9, duration: 100, yoyo: true, 
                onComplete: () => this.scene.start('ShopScene') 
            });
        });

        // –ü–ª–∞–≤–Ω–æ–µ –ø–∞—Ä–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
        this.tweens.add({
            targets: [playBtn, shopBtn],
            y: '+=5',
            duration: 2000,
            yoyo: true,
            loop: -1,
            ease: 'Sine.easeInOut'
        });
    }
        // –†–ê–ó–î–ï–õ 6.2: –û–¢–†–ò–°–û–í–ö–ê –°–ü–ò–°–ö–ê –¢–û–í–ê–†–û–í
        this.skinList.forEach((skin, i) => {
            const y = 200 + (i * 90);
            const isOwned = App.user.inventory.includes(skin.id);
            const isSelected = App.user.selectedSkin === skin.id;

            // –§–æ–Ω –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–∫–∏–Ω–∞
            const card = this.add.rectangle(width/2, y, 300, 70, 0xffffff, 0.05).setInteractive();
            card.setStrokeStyle(1, isSelected ? 0xffb6c1 : 0x333333);

            // –í–∏–∑—É–∞–ª —Å–∫–∏–Ω–∞ (–ø—Ä–µ–≤—å—é)
            this.add.rectangle(width/2 - 120, y, 20, 20, skin.head);
            this.add.rectangle(width/2 - 100, y, 20, 20, skin.body);

            // –ù–∞–∑–≤–∞–Ω–∏–µ
            this.add.text(width/2 - 70, y, skin.name, { fontSize: '18px', fill: '#fff' }).setOrigin(0, 0.5);

            // –ö–Ω–æ–ø–∫–∞ –ö—É–ø–∏—Ç—å/–í—ã–±—Ä–∞—Ç—å
            let btnLabel = isOwned ? (isSelected ? "–í–´–ë–†–ê–ù–û" : "–í–´–ë–†–ê–¢–¨") : `${skin.cost} ü™ô`;
            let btnColor = isOwned ? (isSelected ? "#ffb6c1" : "#ffffff") : "#ffd700";

            const actionBtn = this.add.text(width/2 + 130, y, btnLabel, { 
                fontSize: '16px', 
                fill: btnColor,
                fontStyle: 'bold'
            }).setOrigin(1, 0.5).setInteractive();

            actionBtn.on('pointerdown', () => this.handleAction(skin));
        });

        // –ö–Ω–æ–ø–∫–∞ –ù–ê–ó–ê–î
        const backBtn = this.add.text(width/2, height - 50, "–ù–ê–ó–ê–î –í –ú–ï–ù–Æ", { fill: '#ffb6c1' }).setOrigin(0.5).setInteractive();
        backBtn.on('pointerdown', () => this.scene.start('MenuScene'));
    }

    /**
     * 6.3. –õ–û–ì–ò–ö–ê –ü–û–ö–£–ü–ö–ò –ò –í–´–ë–û–†–ê
     */
    handleAction(skin) {
        const isOwned = App.user.inventory.includes(skin.id);

        if (isOwned) {
            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å ‚Äî –≤—ã–±–∏—Ä–∞–µ–º
            App.user.selectedSkin = skin.id;
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –∫—É–ø–∏—Ç—å
            if (App.user.coins >= skin.cost) {
                App.user.coins -= skin.cost;
                App.user.inventory.push(skin.id);
                App.user.selectedSkin = skin.id;
                alert(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –°–∫–∏–Ω "${skin.name}" —Ç–µ–ø–µ—Ä—å —Ç–≤–æ–π!`);
            } else {
                alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç! –ò–¥–∏ –∏–≥—Ä–∞–π –µ—â–µ.");
                return;
            }
        }

        App.save(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Firebase
        this.scene.restart(); // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω –º–∞–≥–∞–∑–∏–Ω–∞
    }
}   
        /**
 * –†–ê–ó–î–ï–õ 4: –°–¶–ï–ù–ê –¢–ê–ë–õ–ò–¶–´ –õ–ò–î–ï–†–û–í
 */
class LeaderboardScene extends Phaser.Scene {
    constructor() {
        super('LeaderboardScene');
    }

    create() {
        const { width, height } = this.scale;

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
        this.add.text(width / 2, 60, "TOP LEGENDS", { 
            fontSize: '32px', 
            fill: '#ffb6c1', 
            fontStyle: 'bold' 
        }).setOrigin(0.5);

        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞
        const listY = 150;
        
        // –ó–∞–ø—Ä–æ—Å –≤ Firebase: –±–µ—Ä–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–∫–æ—Ä–¥—É –∏ –±–µ—Ä–µ–º —Ç–æ–ø-5
        db.ref('users').orderByChild('highScore').limitToLast(5).once('value', (snapshot) => {
            let players = [];
            snapshot.forEach((child) => {
                players.push(child.val());
            });
            
            // Firebase –≤—ã–¥–∞–µ—Ç –æ—Ç –º–µ–Ω—å—à–µ–≥–æ –∫ –±–æ–ª—å—à–µ–º—É, –ø–æ—ç—Ç–æ–º—É –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
            players.reverse();

            // –†–∏—Å—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            players.forEach((player, index) => {
                const yPos = listY + (index * 60);
                
                // –†–∞–º–∫–∞ —Å—Ç—Ä–æ–∫–∏
                this.add.rectangle(width / 2, yPos, 300, 50, 0xffffff, 0.05)
                    .setStrokeStyle(1, 0xffb6c1, 0.2);

                // –ù–æ–º–µ—Ä (1, 2, 3...)
                this.add.text(width / 2 - 130, yPos, `#${index + 1}`, { fontSize: '20px', fill: '#ff69b4' }).setOrigin(0, 0.5);

                // –ù–∏–∫ –∏–≥—Ä–æ–∫–∞
                this.add.text(width / 2 - 80, yPos, player.nick.toUpperCase(), { fontSize: '18px', fill: '#fff' }).setOrigin(0, 0.5);

                // –†–µ–∫–æ—Ä–¥
                this.add.text(width / 2 + 130, yPos, player.highScore || 0, { fontSize: '20px', fill: '#ffd700', fontStyle: 'bold' }).setOrigin(1, 0.5);
            });
        });

        // –ö–Ω–æ–ø–∫–∞ –ù–ê–ó–ê–î
        const backBtn = this.add.container(width / 2, height - 80);
        const bBg = this.add.rectangle(0, 0, 200, 50, 0xffb6c1, 0.2).setInteractive().setStrokeStyle(2, 0xffb6c1);
        const bTxt = this.add.text(0, 0, "–í –ú–ï–ù–Æ", { fontSize: '18px', fill: '#ffb6c1' }).setOrigin(0.5);
        backBtn.add([bBg, bTxt]);

        bBg.on('pointerdown', () => this.scene.start('MenuScene'));
        let leadBtn = this.add.text(width/2, 560, "–†–ï–ö–û–†–î–´ –ú–ò–†–ê", { fill: '#ffffff' }).setOrigin(0.5).setInteractive();
leadBtn.on('pointerdown', () => this.scene.start('LeaderboardScene'));
    }
}
        // –ü–†–û–í–ï–†–ö–ê –ù–ê –ê–î–ú–ò–ù–ê (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∏–∫–∞ Bendi7080)
if (App.user.nick === "Bendi7080") {
    let adminBtn = this.add.text(this.scale.width - 20, 20, "‚öôÔ∏è", { 
        fontSize: '30px' 
    }).setOrigin(1, 0).setInteractive();

    adminBtn.on('pointerdown', () => {
        // –ó–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∞ –ø–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º –≤ –ø–∞–Ω–µ–ª—å
        let pass = prompt("–í–í–ï–î–ò –ü–ê–†–û–õ–¨ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê:");
        if (pass === "BestEhsona") {
            this.scene.start('AdminScene');
        } else {
            alert("–î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–ï–ù!");
        }
    });
}
        /**
 * –†–ê–ó–î–ï–õ 5: –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ (ADMIN PANEL)
 */
// –ü—Ä–æ–≤–µ—Ä—å —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ –≤–Ω–∏–∑—É —Å–≤–æ–µ–≥–æ –∫–æ–¥–∞!
    class AdminScene extends Phaser.Scene {
    constructor() {
        super('AdminScene');
    }

    create() {
        const { width, height } = this.scale;

        this.add.text(width / 2, 50, "ADMIN PANEL", { 
            fontSize: '28px', fill: '#ffb6c1', fontStyle: 'bold' 
        }).setOrigin(0.5);

        // –ö–ù–û–ü–ö–ê 1: –î–û–ë–ê–í–ò–¢–¨ –ú–û–ù–ï–¢–´
        this.createAdminBtn(150, "–î–û–ë–ê–í–ò–¢–¨ +1000 ü™ô", () => {
            App.user.coins += 1000;
            App.save();
            alert("–ó–∞—á–∏—Å–ª–µ–Ω–æ 1000 –º–æ–Ω–µ—Ç!");
        });

        // –ö–ù–û–ü–ö–ê 2: –ü–û–í–´–°–ò–¢–¨ –£–†–û–í–ï–ù–¨
        this.createAdminBtn(230, "–ü–û–í–´–°–ò–¢–¨ LVL +1", () => {
            App.user.level += 1;
            App.save();
            alert("–£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω!");
        });

        // –ö–ù–û–ü–ö–ê 3: –û–ë–ù–£–õ–ò–¢–¨ –í–°–ï–• (–û–ü–ê–°–ù–û!)
        this.createAdminBtn(310, "–°–ë–†–û–°–ò–¢–¨ –†–ï–ö–û–†–î–´", () => {
            if(confirm("–£–¥–∞–ª–∏—Ç—å —Ä–µ–∫–æ—Ä–¥—ã –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤?")) {
                db.ref('users').once('value', (snap) => {
                    snap.forEach((child) => {
                        child.ref.update({ highScore: 0 });
                    });
                });
                alert("–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ –æ—á–∏—â–µ–Ω–∞!");
            }
        });

        // –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î
        let back = this.add.text(width / 2, height - 60, "–í–´–•–û–î", { fill: '#ffb6c1' }).setOrigin(0.5).setInteractive();
        back.on('pointerdown', () => this.scene.start('MenuScene'));
    }

    createAdminBtn(y, text, action) {
        let btn = this.add.container(this.scale.width / 2, y);
        let bg = this.add.rectangle(0, 0, 260, 50, 0x333333).setInteractive().setStrokeStyle(1, 0xffb6c1);
        let txt = this.add.text(0, 0, text, { fontSize: '18px' }).setOrigin(0.5);
        btn.add([bg, txt]);
        bg.on('pointerdown', action);
    }
}
        class BootScene extends Phaser.Scene {
    constructor() { super('BootScene'); }
    preload() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–≤—É–∫–æ–≤ –∏–∑ –æ—Ç–∫—Ä—ã—Ç–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Phaser
        this.load.audio('eat', 'https://labs.phaser.io/assets/audio/SoundEffects/p-ping.mp3');
        this.load.audio('levelUp', 'https://labs.phaser.io/assets/audio/SoundEffects/key.wav');
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä—ã –¥–ª—è –∏—Å–∫—Ä
        this.load.image('spark', 'https://labs.phaser.io/assets/particles/blue.png');
    }
    create() { this.scene.start('MenuScene'); }
}
    </script>
</body>
</html>
