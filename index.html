<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PNAKE LEGENDS: ULTIMATE</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; user-select: none; }
        #game-container { width: 100vw; height: 100vh; }
        .ui-screen { position: absolute; inset: 0; background: radial-gradient(circle at center, #1a0a1a 0%, #000 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .card { background: rgba(255, 255, 255, 0.05); padding: 30px; border-radius: 25px; border: 2px solid #ffb6c1; text-align: center; width: 300px; backdrop-filter: blur(10px); }
        input { display: block; width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #333; background: #000; color: #fff; box-sizing: border-box; outline: none; }
        button { width: 100%; padding: 14px; border-radius: 25px; border: none; background: linear-gradient(45deg, #ffb6c1, #ff69b4); color: white; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; transition: 0.3s; }
        button:active { transform: scale(0.95); }
        .hidden { display: none !important; }
        /* –°—Ç–∏–ª–∏ —á–∞—Ç–∞ */
        #chat-ui { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 340px; background: rgba(0,0,0,0.7); border-radius: 15px; border: 1px solid #ffb6c1; padding: 10px; z-index: 500; }
        #chat-messages { height: 100px; overflow-y: auto; font-size: 12px; margin-bottom: 5px; text-align: left; }
        #chat-input { background: #000; border: 1px solid #444; color: #fff; padding: 5px; width: 70%; border-radius: 5px; }
        #chat-send { width: 25%; padding: 5px; font-size: 12px; margin: 0; display: inline-block; }
    </style>
</head>
<body>

    <div id="auth-screen" class="ui-screen">
        <div class="card">
            <h1 style="color:#ffb6c1; margin-bottom: 20px; letter-spacing: 5px;">PNAKE</h1>
            <input type="text" id="nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" maxlength="12">
            <input type="password" id="pass" placeholder="–ü–ê–†–û–õ–¨">
            <button id="login-btn">–í–û–ô–¢–ò / –°–û–ó–î–ê–¢–¨</button>
        </div>
    </div>

    <div id="chat-ui" class="hidden">
        <div id="chat-messages"></div>
        <input type="text" id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="chat-send">–û–¢–ü–†–ê–í–ò–¢–¨</button>
    </div>

    <div id="game-container"></div>

<script>
/** 1. –ë–ê–ó–ê –î–ê–ù–ù–´–• **/
const firebaseConfig = {
    apiKey: "AIzaSyCr28iNiurXgoZwbxOfast8R26ZiwVAR5Y",
    authDomain: "pnake3.firebaseapp.com",
    databaseURL: "https://pnake3-default-rtdb.firebaseio.com",
    projectId: "pnake3",
    appId: "1:796701048320:web:d88d06ada6e6e15a52e2e5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const App = {
    user: null,
    controls: 'touch', // 'touch' –∏–ª–∏ 'buttons'
    save: function() { if(this.user) db.ref('users/' + this.user.nick).update(this.user); }
};

/** 2. –õ–û–ì–ò–ö–ê –í–•–û–î–ê **/
document.getElementById('login-btn').onclick = async function() {
    const nick = document.getElementById('nick').value.trim();
    const pass = document.getElementById('pass').value.trim();

    if(nick === "Bendi7080" && pass !== "BestEhsona") return alert("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!");
    if(!nick || !pass) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");

    const ref = db.ref('users/' + nick);
    const snap = await ref.once('value');
    
    if(!snap.exists()) {
        App.user = { nick, password: pass, coins: 100, highScore: 0, level: 1, skin: 'classic', inventory: ['classic'] };
        await ref.set(App.user);
    } else {
        const data = snap.val();
        if(data.password !== pass) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
        App.user = data;
    }

    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('chat-ui').classList.remove('hidden');
    initChat();
    game.scene.start('MenuScene');
};

/** 3. –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ß–ê–¢ **/
function initChat() {
    const chatRef = db.ref('chat').limitToLast(20);
    chatRef.on('child_added', (snap) => {
        const msg = snap.val();
        const div = document.createElement('div');
        div.innerHTML = `<b style="color:#ffb6c1">${msg.user}:</b> ${msg.text}`;
        const container = document.getElementById('chat-messages');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    });

    document.getElementById('chat-send').onclick = () => {
        const text = document.getElementById('chat-input').value;
        if(text.trim()) {
            db.ref('chat').push({ user: App.user.nick, text: text });
            document.getElementById('chat-input').value = '';
        }
    };
}

/** 4. –ò–ì–†–û–í–´–ï –°–¶–ï–ù–´ **/
class MenuScene extends Phaser.Scene {
    constructor() { super('MenuScene'); }
    create() {
        const { width, height } = this.scale;
        this.add.text(width/2, 80, "PNAKE LEGENDS", { fontSize: '32px', fill: '#ffb6c1', fontStyle: 'bold' }).setOrigin(0.5);
        
        const info = this.add.text(width/2, 160, `–ò–ì–†–û–ö: ${App.user.nick}\n–ú–û–ù–ï–¢–´: ${App.user.coins} ü™ô`, { align: 'center', fontSize: '18px' }).setOrigin(0.5);

        const btn = (y, txt, sc) => {
            let g = this.add.container(width/2, y);
            let r = this.add.rectangle(0,0, 240, 50, 0xffffff, 0.1).setStrokeStyle(2, 0xffb6c1).setInteractive();
            g.add([r, this.add.text(0,0, txt, {fontSize:'20px'}).setOrigin(0.5)]);
            r.on('pointerdown', () => this.scene.start(sc));
        };

        btn(280, "–ò–ì–†–ê–¢–¨", 'GameScene');
        btn(350, "–ú–ê–ì–ê–ó–ò–ù", 'ShopScene');
        btn(420, "–õ–ò–î–ï–†–´", 'LeaderboardScene');
        btn(490, "–ù–ê–°–¢–†–û–ô–ö–ò", 'SettingsScene');

        if(App.user.nick === "Bendi7080") {
            let adm = this.add.text(width-40, 40, "‚öôÔ∏è", {fontSize:'30px'}).setInteractive();
            adm.on('pointerdown', () => { App.user.coins += 5000; App.save(); alert("–ê–¥–º–∏–Ω-–±–æ–Ω—É—Å –ø–æ–ª—É—á–µ–Ω!"); this.scene.restart(); });
        }
    }
}
/** 4. –ò–ì–†–û–í–ê–Ø –ú–ï–•–ê–ù–ò–ö–ê (–ó–ú–ï–ô–ö–ê) **/
class GameScene extends Phaser.Scene {
    constructor() { super('GameScene'); }

    create() {
        const { width, height } = this.scale;
        document.getElementById('chat-ui').style.opacity = "0.3"; 

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—è
        this.gridSize = 20;
        this.score = 0;
        
        // –°–æ–∑–¥–∞–µ–º –∑–º–µ–π–∫—É (–≥–æ–ª–æ–≤–∞ + —Ç–µ–ª–æ)
        this.snake = [
            {x: 10, y: 15},
            {x: 10, y: 16},
            {x: 10, y: 17}
        ];
        
        this.dir = {x: 0, y: -1}; // –ù–∞—á–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –≤–≤–µ—Ä—Ö
        this.nextDir = {x: 0, y: -1};
        
        // –ï–¥–∞
        this.spawnFood();

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        this.snakeGroup = this.add.group();
        this.apple = this.add.circle(0, 0, 8, 0xff0000).setStrokeStyle(2, 0xffffff);
        
        // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—á–µ—Ç–∞
        this.scoreText = this.add.text(10, 40, `–°–ß–ï–¢: 0`, { fontSize: '20px', fill: '#ffb6c1' });

        // –¢–∞–π–º–µ—Ä –¥–≤–∏–∂–µ–Ω–∏—è (—Å–∫–æ—Ä–æ—Å—Ç—å –∑–º–µ–π–∫–∏)
        this.moveTimer = this.time.addEvent({
            delay: 150, 
            callback: this.updateSnake,
            callbackScope: this,
            loop: true
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¢–ê–ü–ê–ú–ò (–¥–µ–ª–∏–º —ç–∫—Ä–∞–Ω –Ω–∞ 4 –∑–æ–Ω—ã)
        this.input.on('pointerdown', (p) => {
            const centerX = width / 2;
            const centerY = height / 2;

            if (Math.abs(p.x - centerX) > Math.abs(p.y - centerY)) {
                // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                if (p.x > centerX && this.dir.x === 0) this.nextDir = {x: 1, y: 0};
                else if (p.x < centerX && this.dir.x === 0) this.nextDir = {x: -1, y: 0};
            } else {
                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                if (p.y > centerY && this.dir.y === 0) this.nextDir = {x: 0, y: 1};
                else if (p.y < centerY && this.dir.y === 0) this.nextDir = {x: 0, y: -1};
            }
        });

        // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
        let exitBtn = this.add.text(width - 70, 20, "–í–´–•–û–î", { fill: '#ff4444', fontSize: '18px', fontWeight: 'bold' }).setInteractive();
        exitBtn.on('pointerdown', () => {
            document.getElementById('chat-ui').style.opacity = "1";
            this.scene.start('MenuScene');
        });
    }

    spawnFood() {
        this.food = {
            x: Phaser.Math.Between(1, 17),
            y: Phaser.Math.Between(4, 28)
        };
    }

    updateSnake() {
        this.dir = this.nextDir;
        let head = { x: this.snake[0].x + this.dir.x, y: this.snake[0].y + this.dir.y };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ —Å—Ç–µ–Ω–∞–º–∏
        if (head.x < 0 || head.x >= 18 || head.y < 3 || head.y >= 32) {
            return this.gameOver();
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å —Å–æ–±–æ–π
        if (this.snake.some(part => part.x === head.x && part.y === head.y)) {
            return this.gameOver();
        }

        this.snake.unshift(head);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å—ä–µ–ª–∏ –ª–∏ –µ–¥—É
        if (head.x === this.food.x && head.y === this.food.y) {
            this.score += 10;
            this.scoreText.setText(`–°–ß–ï–¢: ${this.score}`);
            App.user.coins += 2; // –î–∞–µ–º –º–æ–Ω–µ—Ç—ã –∑–∞ –µ–¥—É
            this.spawnFood();
            // –≠—Ñ—Ñ–µ–∫—Ç –≤—Å–ø—ã—à–∫–∏ –ø—Ä–∏ –µ–¥–µ
            this.cameras.main.flash(100, 255, 182, 193, 0.2);
        } else {
            this.snake.pop();
        }

        this.draw();
    }

    draw() {
        this.snakeGroup.clear(true, true);
        this.snake.forEach((p, i) => {
            let color = (i === 0) ? 0xff69b4 : 0xffb6c1; // –ì–æ–ª–æ–≤–∞ —è—Ä—á–µ
            let part = this.add.rectangle(p.x * 20 + 10, p.y * 20 + 10, 18, 18, color);
            this.snakeGroup.add(part);
        });
        this.apple.setPosition(this.food.x * 20 + 10, this.food.y * 20 + 10);
    }

    gameOver() {
        if (this.score > App.user.highScore) {
            App.user.highScore = this.score;
        }
        App.save();
        document.getElementById('chat-ui').style.opacity = "1";
        alert(`–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê! –í–ê–® –°–ß–ï–¢: ${this.score}`);
        this.scene.start('MenuScene');
    }
}

/** 5. –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ê–î–ú–ò–ù–ö–ê (–î–õ–Ø SAMIRA) **/
class AdminScene extends Phaser.Scene {
    constructor() { super('AdminScene'); }
    create() {
        const { width, height } = this.scale;
        this.add.text(width/2, 100, "–ü–ê–ù–ï–õ–¨ SAMIRA", { fontSize: '28px', fill: '#ffb6c1' }).setOrigin(0.5);

        let btn = this.add.rectangle(width/2, 250, 250, 60, 0x333333).setStrokeStyle(2, 0xffb6c1).setInteractive();
        this.add.text(width/2, 250, "–ß–ò–¢: +5000 –ú–û–ù–ï–¢").setOrigin(0.5);

        btn.on('pointerdown', () => {
            App.user.coins += 5000;
            App.save();
            alert("–ú–û–ù–ï–¢–´ –î–û–ë–ê–í–õ–ï–ù–´, –•–û–ó–Ø–ô–ö–ê!");
            this.scene.start('MenuScene');
        });

        this.add.text(width/

class ShopScene extends Phaser.Scene {
    constructor() { super('ShopScene'); }
    create() {
        const { width } = this.scale;
        this.add.text(width/2, 50, "–ú–ê–ì–ê–ó–ò–ù –°–ö–ò–ù–û–í", {fontSize:'24px'}).setOrigin(0.5);
        this.add.text(width/2, 100, `–¢–í–û–ô –ë–ê–õ–ê–ù–°: ${App.user.coins} ü™ô`).setOrigin(0.5);

        const skins = [
            {id:'classic', name:'–ö–õ–ê–°–°–ò–ö', cost:0},
            {id:'neon', name:'–ù–ï–û–ù', cost:500},
            {id:'gold', name:'–ó–û–õ–û–¢–û', cost:2000}
        ];

        skins.forEach((s, i) => {
            let btn = this.add.text(width/2, 200 + i*60, `${s.name} - ${s.cost} ü™ô`, {fontSize:'20px'}).setOrigin(0.5).setInteractive();
            btn.on('pointerdown', () => {
                if(App.user.inventory.includes(s.id)) {
                    App.user.skin = s.id;
                    alert("–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ!");
                } else if(App.user.coins >= s.cost) {
                    App.user.coins -= s.cost;
                    App.user.inventory.push(s.id);
                    App.save();
                    alert("–ö—É–ø–ª–µ–Ω–æ!");
                }
            });
        });

        this.add.text(width/2, 550, "–ù–ê–ó–ê–î").setOrigin(0.5).setInteractive().on('pointerdown', () => this.scene.start('MenuScene'));
    }
}

class LeaderboardScene extends Phaser.Scene {
    constructor() { super('LeaderboardScene'); }
    create() {
        this.add.text(180, 50, "–õ–ò–î–ï–†–´", {fontSize:'28px', fill:'#ffb6c1'}).setOrigin(0.5);
        db.ref('users').orderByChild('highScore').limitToLast(5).once('value', s => {
            let arr = []; s.forEach(c => arr.push(c.val()));
            arr.reverse().forEach((p, i) => {
                this.add.text(180, 150 + i*50, `${i+1}. ${p.nick} - ${p.highScore}`, {fontSize:'18px'}).setOrigin(0.5);
            });
        });
        this.add.text(180, 550, "–ù–ê–ó–ê–î").setOrigin(0.5).setInteractive().on('pointerdown', () => this.scene.start('MenuScene'));
    }
}

class SettingsScene extends Phaser.Scene {
    constructor() { super('SettingsScene'); }
    create() {
        this.add.text(180, 100, "–ù–ê–°–¢–†–û–ô–ö–ò", {fontSize:'24px'}).setOrigin(0.5);
        let t = this.add.text(180, 250, `–£–ü–†–ê–í–õ–ï–ù–ò–ï: ${App.controls.toUpperCase()}`, {fontSize:'20px'}).setOrigin(0.5).setInteractive();
        t.on('pointerdown', () => {
            App.controls = (App.controls === 'touch') ? 'buttons' : 'touch';
            t.setText(`–£–ü–†–ê–í–õ–ï–ù–ò–ï: ${App.controls.toUpperCase()}`);
        });
        this.add.text(180, 500, "–ù–ê–ó–ê–î").setOrigin(0.5).setInteractive().on('pointerdown', () => this.scene.start('MenuScene'));
    }
}

const config = { type: Phaser.AUTO, width: 360, height: 640, parent: 'game-container', backgroundColor: '#000', scene: [MenuScene, GameScene, ShopScene, LeaderboardScene, SettingsScene] };
const game = new Phaser.Game(config);
</script>
</body>
</html>
