<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PNAKE: STABLE NEON</title>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #2d0b1e; overflow: hidden; font-family: 'Arial', sans-serif; user-select: none; }
        
        /* –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –≤—Ö–æ–¥–∞ */
        .ui-screen { 
            position: absolute; inset: 0; 
            background: radial-gradient(circle, #4a0e2e 0%, #1a020f 100%); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; 
        }
        .card { 
            background: rgba(0, 0, 0, 0.6); 
            padding: 30px; border-radius: 20px; 
            border: 2px solid #ff69b4; 
            box-shadow: 0 0 20px #ff69b466;
            text-align: center; width: 280px; backdrop-filter: blur(10px); 
        }
        h1 { color: #ffb6c1; margin: 0 0 15px 0; font-size: 36px; letter-spacing: 2px; }
        
        input { 
            display: block; width: 100%; padding: 12px; margin: 10px 0; 
            border-radius: 10px; border: 1px solid #ff69b4; 
            background: #111; color: #fff; box-sizing: border-box; 
            font-size: 16px; outline: none; text-align: center;
        }
        
        button { 
            width: 100%; padding: 14px; border-radius: 25px; border: none; 
            background: #ff1493; color: white; font-weight: bold; font-size: 18px; 
            cursor: pointer; margin-top: 10px; transition: 0.2s;
        }
        button:active { transform: scale(0.95); background: #ff69b4; }
        
        #status-msg { margin-top: 10px; color: #aaa; font-size: 12px; min-height: 20px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- UI –í–•–û–î–ê -->
    <div id="auth-screen" class="ui-screen">
        <div class="card">
            <h1>PNAKE</h1>
            <input type="text" id="nick" placeholder="–¢–≤–æ–π –ù–∏–∫">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="login-btn">–ò–ì–†–ê–¢–¨</button>
            <div id="status-msg">–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é</div>
        </div>
        <br>
        <button onclick="localStorage.clear(); location.reload()" style="width: auto; padding: 8px 15px; font-size: 12px; background: #333;">üîÑ –°–±—Ä–æ—Å (–µ—Å–ª–∏ –∑–∞–≤–∏—Å–ª–æ)</button>
    </div>

    <div id="game-container"></div>

<script>
/** 1. –ù–ê–°–¢–†–û–ô–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–• **/
const firebaseConfig = {
    apiKey: "AIzaSyCr28iNiurXgoZwbxOfast8R26ZiwVAR5Y",
    authDomain: "pnake3.firebaseapp.com",
    databaseURL: "https://pnake3-default-rtdb.firebaseio.com",
    projectId: "pnake3",
    appId: "1:796701048320:web:d88d06ada6e6e15a52e2e5"
};

let db;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
} catch (err) {
    document.getElementById('status-msg').innerText = "–û—à–∏–±–∫–∞ Firebase: " + err.message;
}

// –î–∞–Ω–Ω—ã–µ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞
const SHOP_ITEMS = {
    snakes: [
        {id: 'pink', name: '–†–æ–∑–æ–≤—ã–π', price: 0, color: 0xff69b4},
        {id: 'blue', name: '–°–∏–Ω–∏–π', price: 20, color: 0x00ffff},
        {id: 'yellow', name: '–ñ–µ–ª—Ç—ã–π', price: 20, color: 0xffff00},
        {id: 'red', name: '–ö—Ä–∞—Å–Ω—ã–π', price: 20, color: 0xff0000},
        {id: 'orange', name: '–û—Ä–∞–Ω–∂', price: 20, color: 0xffa500},
        {id: 'black', name: '–ß–µ—Ä–Ω—ã–π', price: 50, color: 0x333333},
        {id: 'white', name: '–ë–µ–ª—ã–π', price: 50, color: 0xffffff},
        {id: 'gray', name: '–°–µ—Ä—ã–π', price: 50, color: 0x888888},
        {id: 'gold', name: '–ó–æ–ª–æ—Ç–æ–π', price: 100, color: 0xffd700},
        {id: 'silver', name: '–°–µ—Ä–µ–±—Ä–æ', price: 100, color: 0xc0c0c0},
        {id: 'rainbow', name: '–†–ê–î–£–ì–ê', price: 500, color: 'rainbow'}
    ],
    food: [
        {id: 'apple', name: '–Ø–±–ª–æ–∫–æ', price: 0, icon: 'üçé'},
        {id: 'banana', name: '–ë–∞–Ω–∞–Ω', price: 50, icon: 'üçå'},
        {id: 'peach', name: '–ü–µ—Ä—Å–∏–∫', price: 50, icon: 'üçë'},
        {id: 'orange_f', name: '–ê–ø–µ–ª—å—Å–∏–Ω', price: 50, icon: 'üçä'},
        {id: 'pear', name: '–ì—Ä—É—à–∞', price: 50, icon: 'üçê'},
        {id: 'pineapple', name: '–ê–Ω–∞–Ω–∞—Å', price: 50, icon: 'üçç'},
        {id: 'strawberry', name: '–ö–ª—É–±–Ω–∏–∫–∞', price: 100, icon: 'üçì'},
        {id: 'watermelon', name: '–ê—Ä–±—É–∑', price: 100, icon: 'üçâ'},
        {id: 'grapes', name: '–í–∏–Ω–æ–≥—Ä–∞–¥', price: 100, icon: 'üçá'},
        {id: 'dragon', name: '–î—Ä–∞–∫–æ–Ω', price: 250, icon: 'üê≤'},
        {id: 'rainbow_f', name: '–†–ê–î–£–ì–ê', price: 250, icon: 'üåà'}
    ]
};

const App = {
    user: null,
    save: function() { 
        if(this.user && db) db.ref('users/' + this.user.nick).update(this.user); 
    }
};

/** 2. –ë–ï–ó–û–ü–ê–°–ù–´–ô –í–•–û–î **/
document.getElementById('login-btn').addEventListener('click', async () => {
    const nick = document.getElementById('nick').value.trim();
    const pass = document.getElementById('pass').value.trim();
    const status = document.getElementById('status-msg');
    
    if(!nick || !pass) return status.innerText = "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å!";
    
    // –ê–¥–º–∏–Ω –ø—Ä–æ–≤–µ—Ä–∫–∞
    if(nick === "Samira" && pass !== "BestEhsona") {
        return status.innerText = "–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –ê–¥–º–∏–Ω–∞!";
    }

    status.innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
    
    try {
        const ref = db.ref('users/' + nick);
        
        // –°—Ç–∞–≤–∏–º —Ç–∞–π–º–µ—Ä –Ω–∞ —Å–ª—É—á–∞–π –ø–ª–æ—Ö–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (3 —Å–µ–∫—É–Ω–¥—ã)
        const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 3000));
        const fetch = ref.once('value');
        
        const snap = await Promise.race([fetch, timeout]).catch(err => {
            // –ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Ç—É–ø–∏—Ç, —Å–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –∏–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–ª–∞
            console.log("–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç");
            return null; 
        });

        if(!snap || !snap.exists()) {
            status.innerText = "–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è...";
            App.user = { 
                nick, password: pass, coins: 100, highScore: 0, 
                skinSnake: 'pink', skinFood: 'apple', 
                inventorySnake: ['pink'], inventoryFood: ['apple']
            };
            if(snap !== null) await ref.set(App.user); // –°–æ—Ö—Ä–∞–Ω—è–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑—å
        } else {
            status.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";
            const data = snap.val();
            if(data.password !== pass) return status.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!";
            
            // –õ–ï–ß–ï–ù–ò–ï –î–ê–ù–ù–´–•: –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã–π –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –∏–º–µ–µ—Ç –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
            if(!data.inventorySnake) data.inventorySnake = ['pink'];
            if(!data.inventoryFood) data.inventoryFood = ['apple'];
            if(!data.skinSnake) data.skinSnake = 'pink';
            if(!data.coins) data.coins = 100;
            
            App.user = data;
        }

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        status.innerText = "–ó–∞–ø—É—Å–∫...";
        document.getElementById('auth-screen').classList.add('hidden');
        if(!game.scene.isActive('MenuScene')) game.scene.start('MenuScene');

    } catch(e) {
        console.error(e);
        status.innerText = "–°–±–æ–π —Å–µ—Ç–∏. –ò–≥—Ä–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω.";
        // –ê–≤–∞—Ä–∏–π–Ω—ã–π –∑–∞–ø—É—Å–∫
        App.user = { nick: nick, coins: 100, inventorySnake:['pink'], skinSnake:'pink', inventoryFood:['apple'], skinFood:'apple' };
        document.getElementById('auth-screen').classList.add('hidden');
        game.scene.start('MenuScene');
    }
});

/** 3. –ò–ì–†–û–í–û–ô –î–í–ò–ñ–û–ö **/

// –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ
class MenuScene extends Phaser.Scene {
    constructor() { super('MenuScene'); }
    create() {
        const { width, height } = this.scale;
        
        this.add.rectangle(0, 0, width, height, 0x2d0b1e).setOrigin(0);
        
        this.add.text(width/2, 80, "PNAKE", { fontSize: '40px', color: '#ff69b4', fontStyle: 'bold' }).setOrigin(0.5);
        this.add.text(width/2, 120, "NEON EDITION", { fontSize: '20px', color: '#00ffff' }).setOrigin(0.5);

        this.add.text(width/2, 180, `–ò–≥—Ä–æ–∫: ${App.user.nick}`, { fontSize: '20px' }).setOrigin(0.5);
        this.add.text(width/2, 210, `–ú–æ–Ω–µ—Ç—ã: ${App.user.coins} ü™ô`, { fontSize: '20px', color: '#ffd700' }).setOrigin(0.5);

        this.createBtn(width/2, 300, "–ò–ì–†–ê–¢–¨ ‚ñ∂", 0xff1493, () => this.scene.start('GameScene'));
        this.createBtn(width/2, 370, "–ú–ê–ì–ê–ó–ò–ù üõí", 0x9400d3, () => this.scene.start('ShopScene'));
        this.createBtn(width/2, 440, "–†–ï–ö–û–†–î–´ üèÜ", 0x00ced1, () => this.scene.start('LeaderboardScene'));

        // –ê–¥–º–∏–Ω
        if(App.user.nick === "Samira") {
            let adm = this.add.text(width-40, 40, "‚öôÔ∏è", { fontSize: '30px' }).setInteractive();
            adm.on('pointerdown', () => {
                App.user.coins += 5000;
                App.save();
                alert("–ë–æ–Ω—É—Å –ê–¥–º–∏–Ω–∞: +5000 –º–æ–Ω–µ—Ç!");
                this.scene.restart();
            });
        }
    }

    createBtn(x, y, txt, color, cb) {
        let bg = this.add.rectangle(x, y, 220, 50, color).setInteractive();
        bg.setStrokeStyle(2, 0xffffff);
        let t = this.add.text(x, y, txt, { fontSize: '20px', fontStyle: 'bold' }).setOrigin(0.5);
        bg.on('pointerdown', () => {
            this.tweens.add({ targets: [bg, t], scale: 0.9, yoyo: true, duration: 50, onComplete: cb });
        });
    }
}

// –ò–ì–†–ê
class GameScene extends Phaser.Scene {
    constructor() { super('GameScene'); }
    create() {
        const { width, height } = this.scale;
        this.add.rectangle(0,0, width, height, 0x330011).setOrigin(0);
        
        // –ì—Ä–∞–Ω–∏—Ü—ã
        let g = this.add.graphics();
        g.lineStyle(4, 0xffffff);
        g.strokeRect(2, 2, width-4, height-4);

        this.grid = 20;
        this.cols = Math.floor(width/this.grid);
        this.rows = Math.floor(height/this.grid);
        
        this.snake = [{x:10, y:15}, {x:10, y:16}];
        this.dir = {x:0, y:-1};
        this.nextDir = {x:0, y:-1};
        this.score = 0;

        // –î–∞–Ω–Ω—ã–µ —Å–∫–∏–Ω–æ–≤ (–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ)
        let sSkin = SHOP_ITEMS.snakes.find(s => s.id === App.user.skinSnake) || SHOP_ITEMS.snakes[0];
        let fSkin = SHOP_ITEMS.food.find(f => f.id === App.user.skinFood) || SHOP_ITEMS.food[0];
        
        this.snakeColor = sSkin.color;
        this.isRainbow = (sSkin.id === 'rainbow');
        this.foodIcon = fSkin.icon;

        this.spawnFood();

        this.snakeGroup = this.add.group();
        this.foodTxt = this.add.text(0,0, this.foodIcon, {fontSize:'18px'}).setOrigin(0.5);
        this.scoreTxt = this.add.text(15, 15, '0', {fontSize:'30px', fontStyle:'bold', color:'#fff5'});

        this.time.addEvent({ delay: 130, callback: this.tick, callbackScope: this, loop: true });

        this.input.on('pointerdown', (p) => {
            let cx = width/2, cy = height/2;
            if(Math.abs(p.x - cx) > Math.abs(p.y - cy)) {
                if(p.x > cx && this.dir.x === 0) this.nextDir = {x:1, y:0};
                else if(p.x < cx && this.dir.x === 0) this.nextDir = {x:-1, y:0};
            } else {
                if(p.y > cy && this.dir.y === 0) this.nextDir = {x:0, y:1};
                else if(p.y < cy && this.dir.y === 0) this.nextDir = {x:0, y:-1};
            }
        });
    }

    spawnFood() {
        let safe=false;
        while(!safe) {
            this.food = {x: Phaser.Math.Between(1, this.cols-2), y: Phaser.Math.Between(1, this.rows-2)};
            safe = !this.snake.some(p => p.x === this.food.x && p.y === this.food.y);
        }
    }

    tick() {
        this.dir = this.nextDir;
        let head = {x: this.snake[0].x + this.dir.x, y: this.snake[0].y + this.dir.y};

        if(head.x < 0 || head.x >= this.cols || head.y < 0 || head.y >= this.rows) return this.gameOver();
        if(this.snake.some(p => p.x === head.x && p.y === head.y)) return this.gameOver();

        this.snake.unshift(head);

        if(head.x === this.food.x && head.y === this.food.y) {
            this.score += 10;
            App.user.coins += 2;
            this.scoreTxt.setText(this.score);
            this.spawnFood();
        } else {
            this.snake.pop();
        }
        this.draw();
    }

    draw() {
        this.snakeGroup.clear(true, true);
        this.snake.forEach((p, i) => {
            let color = this.isRainbow ? Phaser.Display.Color.RandomRGB().color : this.snakeColor;
            let r = this.add.rectangle(p.x*this.grid+10, p.y*this.grid+10, 18, 18, color);
            r.setStrokeStyle(1, 0xffffff);
            this.snakeGroup.add(r);
        });
        this.foodTxt.setPosition(this.food.x*this.grid+10, this.food.y*this.grid+10);
    }

    gameOver() {
        if(this.score > (App.user.highScore || 0)) App.user.highScore = this.score;
        App.save();
        alert(`–°—á–µ—Ç: ${this.score}\n–ú–æ–Ω–µ—Ç—ã: +${Math.floor(this.score/5)}`);
        this.scene.start('MenuScene');
    }
}

// –ú–ê–ì–ê–ó–ò–ù
class ShopScene extends Phaser.Scene {
    constructor() { super('ShopScene'); }
    create() {
        const { width, height } = this.scale;
        this.mode = 'snakes';
        this.add.text(width/2, 40, "–ú–ê–ì–ê–ó–ò–ù", { fontSize: '30px', color: '#ff69b4' }).setOrigin(0.5);
        this.bal = this.add.text(width/2, 80, `${App.user.coins} ü™ô`, { fontSize: '24px', color: '#ffd700' }).setOrigin(0.5);

        let t1 = this.add.text(width/2-70, 120, "–ó–ú–ï–ô–ö–ò", {fontSize:'18px'}).setOrigin(0.5).setInteractive();
        let t2 = this.add.text(width/2+70, 120, "–ï–î–ê", {fontSize:'18px', color:'#888'}).setOrigin(0.5).setInteractive();

        t1.on('pointerdown', () => { this.mode='snakes'; t1.setColor('#fff'); t2.setColor('#888'); this.showList(); });
        t2.on('pointerdown', () => { this.mode='food'; t2.setColor('#fff'); t1.setColor('#888'); this.showList(); });

        this.cont = this.add.container(0, 150);
        this.showList();
        
        this.add.text(width/2, height-40, "–ù–ê–ó–ê–î", {fontSize:'24px', color:'#ff69b4'}).setOrigin(0.5).setInteractive().on('pointerdown', () => this.scene.start('MenuScene'));
    }

    showList() {
        this.cont.removeAll(true);
        const { width } = this.scale;
        const list = (this.mode === 'snakes') ? SHOP_ITEMS.snakes : SHOP_ITEMS.food;
        const inv = (this.mode === 'snakes') ? App.user.inventorySnake : App.user.inventoryFood;
        const cur = (this.mode === 'snakes') ? App.user.skinSnake : App.user.skinFood;

        list.forEach((item, i) => {
            const y = i * 65;
            const has = inv.includes(item.id);
            const eq = (cur === item.id);
            
            let bg = this.add.rectangle(width/2, y, 320, 55, 0xffffff, 0.1).setOrigin(0.5, 0);
            if(eq) bg.setStrokeStyle(2, 0x00ff00);
            
            this.cont.add(bg);
            this.cont.add(this.add.text(40, y+15, item.name, {fontSize:'18px'}));
            
            let btnTxt = has ? (eq ? "‚úî" : "–í–´–ë–†–ê–¢–¨") : `${item.price} ü™ô`;
            let btnC = has ? (eq ? '#0f0' : '#fff') : '#fd0';
            
            let btn = this.add.text(width-50, y+15, btnTxt, {fontSize:'18px', color:btnC}).setOrigin(1,0).setInteractive();
            btn.on('pointerdown', () => {
                if(has) {
                    if(this.mode === 'snakes') App.user.skinSnake = item.id; else App.user.skinFood = item.id;
                    App.save(); this.showList();
                } else if(App.user.coins >= item.price) {
                    App.user.coins -= item.price;
                    if(this.mode === 'snakes') App.user.inventorySnake.push(item.id); else App.user.inventoryFood.push(item.id);
                    App.save(); this.showList(); this.bal.setText(`${App.user.coins} ü™ô`);
                } else alert("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!");
            });
            this.cont.add(btn);
        });
    }
}

// –õ–ò–î–ï–†–´
class LeaderboardScene extends Phaser.Scene {
    constructor() { super('LeaderboardScene'); }
    create() {
        const { width } = this.scale;
        this.add.text(width/2, 50, "–¢–û–ü –ò–ì–†–û–ö–û–í", {fontSize:'28px', color:'#ff69b4'}).setOrigin(0.5);
        
        db.ref('users').orderByChild('highScore').limitToLast(10).once('value', s => {
            let d = []; s.forEach(c => d.push(c.val()));
            d.reverse().forEach((p, i) => {
                this.add.text(width/2, 120+i*40, `${i+1}. ${p.nick} : ${p.highScore}`, {fontSize:'20px'}).setOrigin(0.5);
            });
        });
        
        this.add.text(width/2, 600, "–ù–ê–ó–ê–î", {fontSize:'24px', color:'#ff69b4'}).setOrigin(0.5).setInteractive().on('pointerdown', () => this.scene.start('MenuScene'));
    }
}

const config = { type: Phaser.AUTO, width: 360, height: 640, parent: 'game-container', backgroundColor: '#2d0b1e', scene: [MenuScene, GameScene, ShopScene, LeaderboardScene] };
const game = new Phaser.Game(config);
</script>
</body>
</html>



