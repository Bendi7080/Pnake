
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PNAKE: LEGENDS</title>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        body { margin: 0; background: #050505; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; color: white; }
        
        /* UI –≠–∫—Ä–∞–Ω—ã */
        .ui-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100;
        }
        .hidden { display: none !important; }
        
        h1 { color: #ffb6c1; font-size: 36px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(255, 182, 193, 0.5); text-align: center;}
        input { padding: 15px; margin: 10px; width: 260px; border-radius: 8px; border: 2px solid #555; background: #222; color: #fff; font-size: 16px; outline: none; transition: 0.3s; }
        input:focus { border-color: #ffb6c1; }
        
        button {
            padding: 15px 40px; margin: 10px; border-radius: 30px; border: none;
            background: linear-gradient(90deg, #ffb6c1, #ff69b4); 
            color: #000; font-weight: bold; font-size: 18px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.4);
            transition: transform 0.1s; width: 280px;
        }
        button:active { transform: scale(0.95); }
        .secondary-btn { background: transparent; border: 2px solid #ffb6c1; color: #ffb6c1; box-shadow: none; }
        
        #game-container { width: 100vw; height: 100vh; display: block; }
    </style>
</head>
<body>

<div id="auth-screen" class="ui-screen">
    <h1>PNAKE: LEGENDS</h1>
    <input type="text" id="login-nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
    <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="doLogin()">–í–û–ô–¢–ò</button>
    <button class="secondary-btn" onclick="doRegister()">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
    <p id="msg" style="color: #ff5555; height: 20px; margin-top: 10px;"></p>
</div>

<div id="device-screen" class="ui-screen hidden">
    <h1>–ù–ê –ß–ï–ú –ò–ì–†–ê–ï–ú?</h1>
    <button onclick="startGameMode('mobile')">üì± –¢–ï–õ–ï–§–û–ù (–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ)</button>
    <button class="secondary-btn" onclick="startGameMode('pc')">üíª –ü–ö / –ü–õ–ê–ù–®–ï–¢</button>
</div>

<div id="game-container"></div>

<script>
// --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
const firebaseConfig = {
    apiKey: "AIzaSyCr28iNiurXgoZwbxOfast8R26ZiwVAR5Y", 
    authDomain: "pnake3.firebaseapp.com",
    databaseURL: "https://pnake3-default-rtdb.firebaseio.com/",
    projectId: "pnake3",
    storageBucket: "pnake3.appspot.com",
    messagingSenderId: "796701048320",
    appId: "1:796701048320:web:d88d06ada6e6e15a52e2e5"
};
try { firebase.initializeApp(firebaseConfig); } catch(e) {}
const db = firebase.database();

// –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
let state = {
    nick: null, pass: null, 
    coins: 0, best: 0, totalFood: 0, // totalFood - –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
    inventory: { body: ['#86b049'], food: ['üçé'], shape: ['square'] },
    equipped: { body: '#86b049', food: 'üçé', shape: 'square' },
    settings: { music: true, sound: true, bg: 0x111111, control: 'joystick' },
    usedCodes: []
};

let gameInstance = null;
let gameMode = 'mobile';

// --- –õ–û–ì–ò–ö–ê –í–•–û–î–ê ---
const authUI = document.getElementById('auth-screen');
const devUI = document.getElementById('device-screen');
const msg = document.getElementById('msg');

async function doLogin() {
    let n = document.getElementById('login-nick').value.trim();
    let p = document.getElementById('login-pass').value.trim();
    if(!n || !p) return msg.innerText = "–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!";

    msg.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";
    
    // –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ô –í–•–û–î –î–õ–Ø –ê–î–ú–ò–ù–ê (Bendi7080)
    if(n === "Bendi7080" && p === "BestEhsona") {
        await db.ref('users/' + n).update({ pass: p }); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å –≤ –±–∞–∑–µ
        return loadUserData(n);
    }

    try {
        let snap = await db.ref('users/' + n).get();
        if(snap.exists()) {
            let d = snap.val();
            if(d.pass === p) loadUserData(n);
            else msg.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!";
        } else { msg.innerText = "–¢–∞–∫–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç."; }
    } catch(e) { msg.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏."; }
}

async function doRegister() {
    let n = document.getElementById('login-nick').value.trim();
    let p = document.getElementById('login-pass').value.trim();
    if(!n || !p) return;
    
    let snap = await db.ref('users/' + n).get();
    if(snap.exists()) return msg.innerText = "–ù–∏–∫ –∑–∞–Ω—è—Ç!";
    
    state.nick = n; state.pass = p;
    save();
    showDeviceSelect();
}

async function loadUserData(n) {
    let snap = await db.ref('users/' + n).get();
    let d = snap.val();
    // –°–ª–∏—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—á—Ç–æ–±—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è –Ω–µ —Å—Ç–∏—Ä–∞–ª–∏ —Å—Ç–∞—Ä—ã–µ)
    state = { ...state, ...d };
    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—è totalFood
    if(!state.totalFood) state.totalFood = 0;
    
    showDeviceSelect();
}

function showDeviceSelect() {
    authUI.classList.add('hidden');
    devUI.classList.remove('hidden');
}

function startGameMode(mode) {
    gameMode = mode;
    devUI.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    // –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –º–æ–º–µ–Ω—Ç, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å DOM, –ø–æ—Ç–æ–º –∑–∞–ø—É—Å–∫–∞–µ–º Phaser
    setTimeout(launchPhaser, 100);
}

function save() {
    if(state.nick) db.ref('users/' + state.nick).set(state);
}

// --- –£–†–û–í–ù–ò –ò –¢–ò–¢–£–õ–´ ---
function getTitle() {
    if(state.nick === "Bendi7080") return "–•–û–ó–Ø–ò–ù –ó–ú–ï–ï–í";
    
    let f = state.totalFood || 0;
    if(f >= 500) return "–ö–û–†–û–õ–¨ –ó–ú–ï–ï–í";
    if(f >= 100) return "–•–ó–ú–ï–Ø";
    if(f >= 50) return "–ü–ó–ú–ï–Ø";
    if(f >= 20) return "–ó–ú–ï–Ø";
    return "–ï–î–ê –î–õ–Ø –ó–ú–ï–ô";
}

// --- PHASER –ò–ì–†–ê ---
function launchPhaser() {
    if(gameInstance) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

    const isPC = gameMode === 'pc';
    const config = {
        type: Phaser.AUTO,
        parent: 'game-container', // –í–∞–∂–Ω–æ!
        width: isPC ? 800 : 360,
        height: isPC ? 600 : 640,
        backgroundColor: '#000',
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
        scene: [MainScene]
    };
    gameInstance = new Phaser.Game(config);
}

class MainScene extends Phaser.Scene {
    constructor() { super('MainScene'); }

    preload() {
        this.load.audio('eat', 'https://labs.phaser.io/assets/audio/SoundEffects/p-ping.mp3');
        this.load.audio('bgm', 'https://labs.phaser.io/assets/audio/Dancer%20On%20The%20Edge.mp3');
    }

    create() {
        this.isGame = false;
        
        // –ú—É–∑—ã–∫–∞
        if(!this.music) {
            this.music = this.sound.add('bgm', {loop: true, volume: 0.2});
            if(state.settings.music) this.music.play();
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        this.cursors = this.input.keyboard.createCursorKeys();
        this.keys = this.input.keyboard.addKeys('W,A,S,D');

        this.showMenu();
    }

    // --- –ú–ï–ù–Æ ---
    showMenu() {
        this.isGame = false;
        this.children.removeAll();
        this.cameras.main.setBackgroundColor(state.settings.bg);
        
        let cx = this.cameras.main.centerX;
        let cy = this.cameras.main.centerY;
        let title = getTitle();
        let titleColor = state.nick === "Bendi7080" ? '#ff00ff' : '#ffd700';

        this.add.text(cx, cy - 180, "PNAKE", { fontSize: '64px', fill: '#ffb6c1', fontStyle: 'bold' }).setOrigin(0.5);
        this.add.text(cx, cy - 110, title, { fontSize: '24px', fill: titleColor, fontStyle: 'bold' }).setOrigin(0.5);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
        if(state.nick !== "Bendi7080") {
             let next = 20;
             if(state.totalFood >= 100) next = 500;
             else if(state.totalFood >= 50) next = 100;
             else if(state.totalFood >= 20) next = 50;
             
             if(state.totalFood < 500) {
                this.add.text(cx, cy - 80, `–°—ä–µ–¥–µ–Ω–æ: ${state.totalFood} / ${next}`, {fontSize:'16px', fill:'#aaa'}).setOrigin(0.5);
             }
        }

        this.btn(cx, cy + 10, "‚ñ∂ –ò–ì–†–ê–¢–¨", () => this.startGame());
        this.btn(cx, cy + 80, "‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò", () => this.showSettings());
        this.btn(cx - 85, cy + 150, "üõí –ú–ê–ì–ê–ó–ò–ù", () => this.showShop('body'), 0.45);
        this.btn(cx + 85, cy + 150, "üèÜ –¢–û–ü", () => this.showTop(), 0.45);
    }

    // --- –ò–ì–†–ê ---
    startGame() {
        this.children.removeAll();
        this.isGame = true;
        this.score = 0;
        
        // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ–ª—è
        let w = this.cameras.main.width;
        let h = this.cameras.main.height;
        let cols = Math.floor(w / 20);
        let rows = Math.floor(h / 20);

        // –°—Ç–µ–Ω—ã
        let g = this.add.graphics();
        g.lineStyle(4, 0xffffff);
        g.strokeRect(2, 2, w-4, h-4);

        this.grid = { w: cols, h: rows };
        this.snake = [{x: Math.floor(cols/2), y: Math.floor(rows/2)}];
        this.dir = {x:0, y:-1}; 
        this.nextDir = {x:0, y:-1};
        this.timer = 0;
        
        this.spawnFood();

        this.scoreText = this.add.text(w/2, 40, "0", {fontSize:'48px', fontStyle:'bold'}).setOrigin(0.5).setDepth(10);

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        if(gameMode === 'mobile') {
            if(state.settings.control === 'swipe') this.initSwipe();
            else this.createJoystick(w/2, h - 120);
        }
    }

    update(time) {
        if(!this.isGame) return;

        // –í–≤–æ–¥ (–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)
        if((this.cursors.left.isDown || this.keys.A.isDown) && this.dir.x !== 1) this.nextDir = {x:-1, y:0};
        else if((this.cursors.right.isDown || this.keys.D.isDown) && this.dir.x !== -1) this.nextDir = {x:1, y:0};
        else if((this.cursors.up.isDown || this.keys.W.isDown) && this.dir.y !== 1) this.nextDir = {x:0, y:-1};
        else if((this.cursors.down.isDown || this.keys.S.isDown) && this.dir.y !== -1) this.nextDir = {x:0, y:1};

        if(time < this.timer) return;
        this.timer = time + 100; // –°–∫–æ—Ä–æ—Å—Ç—å

        this.dir = this.nextDir;
        let head = { x: this.snake[0].x + this.dir.x, y: this.snake[0].y + this.dir.y };

        // –°–º–µ—Ä—Ç—å
        if(head.x < 0 || head.x >= this.grid.w || head.y < 0 || head.y >= this.grid.h || 
           this.snake.some(s => s.x === head.x && s.y === head.y)) {
            this.gameOver();
            return;
        }

        this.snake.unshift(head);

        // –ï–¥–∞
        if(head.x === this.food.x && head.y === this.food.y) {
            this.score++;
            state.coins += 10;
            state.totalFood = (state.totalFood || 0) + 1; // +1 –∫ –æ–ø—ã—Ç—É
            if(state.settings.sound) this.sound.play('eat');
            this.spawnFood();
            save(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Å—Ä–∞–∑—É
        } else {
            this.snake.pop();
        }

        this.drawGame();
    }

    spawnFood() {
        let valid = false;
        let x, y;
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞: –ï–¥–∞ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è –≤ –∑–º–µ–µ
        while(!valid) {
            x = Phaser.Math.Between(1, this.grid.w - 2);
            y = Phaser.Math.Between(1, this.grid.h - 2);
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ—Ç –ª–∏ —Ç—É—Ç –∑–º–µ–∏
            let collision = this.snake.some(s => s.x === x && s.y === y);
            if(!collision) valid = true;
        }
        this.food = {x, y};
    }

    drawGame() {
        if(this.objs) this.objs.forEach(o => o.destroy());
        this.objs = [];

        this.scoreText.setText(this.score);

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –µ–¥—ã
        let fx = this.food.x * 20 + 10;
        let fy = this.food.y * 20 + 10;
        this.objs.push(this.add.text(fx, fy, state.equipped.food, {fontSize:'20px'}).setOrigin(0.5));

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–º–µ–∏
        this.snake.forEach((p, i) => {
            let x = p.x * 20 + 10;
            let y = p.y * 20 + 10;
            let colStr = state.equipped.body;
            let color = colStr === 'rainbow' ? Phaser.Display.Color.HSVToRGB(Math.random(),1,1).color : Phaser.Display.Color.HexStringToColor(colStr).color;
            
            let s = state.equipped.shape;
            let o;
            
            // –§–æ—Ä–º—ã
            if(s==='circle') o=this.add.circle(x,y,9,color);
            else if(s==='triangle') o=this.add.triangle(x,y,0,10,10,-10,-10,-10,color);
            else if(s==='rhombus') o=this.add.rectangle(x,y,16,16,color).setRotation(0.785);
            else if(s==='line') o=this.add.rectangle(x,y,22,22,color);
            else o=this.add.rectangle(x,y,18,18,color);

            if(i===0) o.setStrokeStyle(2, 0xffffff);
            this.objs.push(o);
        });
    }

    gameOver() {
        // –õ–æ–≥–∏–∫–∞ —Ä–µ–∫–æ—Ä–¥–∞ (–¢–û–õ–¨–ö–û –ï–°–õ–ò –ù–û–í–´–ô –ë–û–õ–¨–®–ï –°–¢–ê–†–û–ì–û)
        if(this.score > state.best) {
            state.best = this.score;
            save(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥
        }
        alert(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –°—á–µ—Ç: ${this.score}\n–í—Å–µ–≥–æ —Å—ä–µ–¥–µ–Ω–æ: ${state.totalFood}`);
        this.showMenu();
    }

    // --- –ú–ê–ì–ê–ó–ò–ù –ò –¢–û–ü ---
    showShop(tab) {
        this.children.removeAll();
        let cx = this.cameras.main.centerX;
        
        let tabs = {body:"–¶–≤–µ—Ç–∞", food:"–ï–¥–∞", shape:"–§–æ—Ä–º—ã"};
        let i=0;
        for(let k in tabs) {
            let b = this.btn(cx - 100 + i*100, 50, tabs[k], ()=>this.showShop(k), 0.4);
            if(tab===k) b.setStrokeStyle(3, 0xffffff);
            i++;
        }

        let items = [];
        if(tab==='body') items = [{v:'#86b049',p:0},{v:'#ffd700',p:100},{v:'rainbow',p:300},{v:'#e91e63',p:500},{v:'#00ffff',p:50}];
        if(tab==='food') items = [{v:'üçé',p:0},{v:'üçî',p:50},{v:'üçï',p:100},{v:'üç£',p:200},{v:'üç∞',p:150}];
        if(tab==='shape') items = [{v:'square',p:0},{v:'circle',p:150},{v:'triangle',p:150},{v:'rhombus',p:150},{v:'line',p:500}];

        items.forEach((it, idx) => {
            let y = 120 + idx*55;
            let owned = state.inventory[tab].includes(it.v) || it.p === 0;
            let act = state.equipped[tab] === it.v;

            // –ò–∫–æ–Ω–∫–∞
            if(tab==='food') this.add.text(40, y, it.v, {fontSize:'24px'}).setOrigin(0.5);
            else if(tab==='body') this.add.rectangle(40, y, 20, 20, it.v==='rainbow'?0xffffff:Phaser.Display.Color.HexStringToColor(it.v).color);
            else {
                let c = 0xffffff;
                if(it.v==='square') this.add.rectangle(40,y,20,20,c);
                if(it.v==='circle') this.add.circle(40,y,10,c);
                if(it.v==='triangle') this.add.triangle(40,y,0,-10,10,10,-10,10,c);
                if(it.v==='rhombus') this.add.rectangle(40,y,18,18,c).setRotation(0.785);
            }

            this.add.text(80, y, tab==='shape'?it.v:(it.p+'üí∞'), {fontSize:'20px'}).setOrigin(0,0.5);
            
            this.btn(cx+80, y, act?"‚úì":(owned?"–í–´–ë–†–ê–¢–¨":"–ö–£–ü–ò–¢–¨"), () => {
                if(owned) { state.equipped[tab]=it.v; save(); this.showShop(tab); }
                else if(state.coins>=it.p) {
                    state.coins-=it.p; state.inventory[tab].push(it.v); save(); this.showShop(tab);
                }
            }, 0.5, act?0x00ff00:(owned?0x555555:0xffb6c1));
        });

        this.btn(cx, this.cameras.main.height-50, "–ù–ê–ó–ê–î", ()=>this.showMenu(), 0.7);
    }

    showTop() {
        this.children.removeAll();
        let cx = this.cameras.main.centerX;
        this.add.text(cx, 50, "–õ–£–ß–®–ò–ï –†–ï–ö–û–†–î–´", {fontSize:'28px', color:'#ffd700'}).setOrigin(0.5);
        
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –±–µ—Ä–µ–º –¢–û–õ–¨–ö–û –ø–æ–ª–µ best
        db.ref('users').orderByChild('best').limitToLast(10).once('value', snap => {
            let list = [];
            snap.forEach(c => list.push({n:c.key, s:c.val().best || 0}));
            list.sort((a,b) => b.s - a.s); // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É

            list.forEach((p, i) => {
                let col = p.n === state.nick ? '#00ffff' : '#ffffff';
                this.add.text(cx-100, 110+i*35, `${i+1}. ${p.n}`, {fontSize:'18px', fill:col});
                this.add.text(cx+100, 110+i*35, p.s, {fontSize:'18px', fill:'#ffd700'}).setOrigin(1,0);
            });
        });
        this.btn(cx, this.cameras.main.height-50, "–ù–ê–ó–ê–î", ()=>this.showMenu(), 0.7);
    }

    showSettings() {
        this.children.removeAll();
        let cx = this.cameras.main.centerX;
        this.add.text(cx, 50, "–ù–ê–°–¢–†–û–ô–ö–ò", {fontSize:'32px'}).setOrigin(0.5);
        
        this.btn(cx, 120, state.settings.music?"–ú–£–ó–´–ö–ê: –í–ö–õ":"–ú–£–ó–´–ö–ê: –í–´–ö–õ", ()=>{
            state.settings.music=!state.settings.music; 
            state.settings.music?this.music.play():this.music.stop(); save(); this.showSettings();
        }, 0.8);

        if(gameMode === 'mobile') {
             this.btn(cx, 190, state.settings.control==='joystick'?"–î–ñ–û–ô–°–¢–ò–ö":"–°–í–ê–ô–ü–´", ()=>{
                state.settings.control = state.settings.control==='joystick'?'swipe':'joystick';
                save(); this.showSettings();
            }, 0.8);
        }

        // –ö–û–î–´
        this.btn(cx, 300, "–í–í–ï–°–¢–ò –ö–û–î", ()=>{
            let c = prompt("–ö–æ–¥:");
            if(!c) return;
            if(state.usedCodes && state.usedCodes.includes(c)) { alert("–£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!"); return; }
            if(!state.usedCodes) state.usedCodes = [];

            if(c==="Snake") { state.coins+=100; alert("+100üí∞"); state.usedCodes.push(c); }
            else if(c==="Samira") { 
                state.coins+=500; 
                if(!state.inventory.body.includes('#e91e63')) state.inventory.body.push('#e91e63');
                alert("+500üí∞ –∏ —Ü–≤–µ—Ç –§—É–∫—Å–∏—è!"); state.usedCodes.push(c); 
            }
            else alert("–ù–µ–≤–µ—Ä–Ω–æ");
            save();
        }, 0.8);

        this.btn(cx, 500, "–ù–ê–ó–ê–î", ()=>this.showMenu(), 0.7);
    }

    // --- –£–¢–ò–õ–ò–¢–´ ---
    btn(x, y, txt, cb, sc=1, col=0x222222) {
        let r = this.add.rectangle(x, y, 240*sc, 60*sc, col).setInteractive().setStrokeStyle(2, 0xffb6c1);
        let t = this.add.text(x, y, txt, {fontSize:(20*sc)+'px', fill:col===0x222222?'#fff':'#000', fontStyle:'bold'}).setOrigin(0.5);
        r.on('pointerdown', ()=> { this.tweens.add({targets:[r,t], scale:0.9, yoyo:true, duration:50}); cb(); });
        return r;
    }

    createJoystick(x, y) {
        const b = (bx, by, t, dx, dy) => {
            let c = this.add.circle(bx, by, 35, 0x333333, 0.6).setInteractive().setStrokeStyle(2, 0xffffff);
            this.add.text(bx, by, t, {fontSize:'24px'}).setOrigin(0.5);
            c.on('pointerdown', ()=> { 
                 if((dx===1 && this.dir.x!==-1) || (dx===-1 && this.dir.x!==1) || 
                   (dy===1 && this.dir.y!==-1) || (dy===-1 && this.dir.y!==1)) 
                   this.nextDir = {x:dx, y:dy};
            });
        };
        b(x, y-50, '‚ñ≤', 0, -1); b(x, y+50, '‚ñº', 0, 1); b(x-50, y, '‚óÄ', -1, 0); b(x+50, y, '‚ñ∂', 1, 0);
    }
    
    initSwipe() {
        this.input.on('pointerup', p => {
            let dx = p.upX - p.downX, dy = p.upY - p.downY;
            if(Math.abs(dx)>Math.abs(dy)) {
                if(dx>0 && this.dir.x!==-1) this.nextDir={x:1,y:0};
                else if(dx<0 && this.dir.x!==1) this.nextDir={x:-1,y:0};
            } else {
                if(dy>0 && this.dir.y!==-1) this.nextDir={x:0,y:1};
                else if(dy<0 && this.dir.y!==1) this.nextDir={x:0,y:-1};
            }
        });
    }
}
</script>
</body>
</html>
