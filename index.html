<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PNAKE: LEGENDS ULTIMATE</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
input:focus {
    outline: none;
    border-color: #ffb6c1;
    box-shadow: 0 0 15px rgba(255, 182, 193, 0.4);
}
button {
    cursor: pointer;
    transition: 0.3s;
    box-shadow: 0 4px 15px rgba(255, 182, 193, 0.3);
}
button:hover {
    filter: brightness(1.2);
    box-shadow: 0 0 25px rgba(255, 182, 193, 0.6);
}
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; color: white; }
        #game-container { width: 100vw; height: 100vh; display: block; }
        .ui-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #1a1a1a, #000); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; transition: 0.5s; }
        .auth-card { background: rgba(255, 255, 255, 0.05); padding: 30px; border-radius: 20px; border: 1px solid #ffb6c1; text-align: center; backdrop-filter: blur(10px); }
        input { padding: 12px; margin: 10px; width: 250px; border-radius: 10px; border: 1px solid #444; background: #111; color: #fff; outline: none; }
        button { padding: 12px 30px; margin: 10px; border-radius: 20px; border: none; background: linear-gradient(45deg, #ffb6c1, #ff69b4); color: #000; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        .hidden { display: none !important; }
        #ban-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: red; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; text-align: center; }
    </style>
</head>
<body onload="activatePinkButton()">
    <div id="game-container"></div>

    <div id="auth-screen" class="ui-screen">
        <div class="auth-card">
            <h1 style="color: #ffb6c1; letter-spacing: 10px;">PNAKE</h1>
            <input type="text" id="nickname-input" placeholder="–ù–ò–ö–ù–ï–ô–ú">
            <input type="password" id="password-input" placeholder="–ü–ê–†–û–õ–¨">
            <button id="login-button">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="ban-overlay" class="hidden">
        <h1>–í–´ –ó–ê–ë–ê–ù–ï–ù–´</h1>
    </div>
</body>

<div id="auth-screen" class="ui-screen">
    <div class="auth-card">
        <h1 style="color:#ffb6c1; letter-spacing: 5px;">PNAKE</h1>
        <input type="text" id="nick" placeholder="–ù–ò–ö–ù–ï–ô–ú">
        <input type="password" id="pass" placeholder="–ü–ê–†–û–õ–¨">
        <button onclick="Core.login()">–í–û–ô–¢–ò</button>
        <p id="auth-msg" style="color:#ff4444; font-size: 12px;"></p>
    </div>
</div>

<div id="game-container"></div>

<script>
/**
 * –ì–õ–û–ë–ê–õ–¨–ù–´–ô –î–í–ò–ñ–û–ö –Ø–î–†–ê (Core)
 * –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –±–∞–Ω-—Å–∏—Å—Ç–µ–º—É.
 */
const Core = {
    dbConfig: {
        apiKey: "AIzaSyCr28iNiurXgoZwbxOfast8R26ZiwVAR5Y",
        authDomain: "pnake3.firebaseapp.com",
        databaseURL: "https://pnake3-default-rtdb.firebaseio.com/",
        projectId: "pnake3",
        appId: "1:796701048320:web:d88d06ada6e6e15a52e2e5"
    },
    user: { 
        nick: "", best: 0, coins: 0, total: 0, 
        inv: ["#86b049"], body: "#86b049", food: "üçé", 
        isAdmin: false, isBanned: false 
    },

    init() {
        firebase.initializeApp(this.dbConfig);
        this.database = firebase.database();
    },

    async login() {
        const n = document.getElementById('nick').value.trim();
        const p = document.getElementById('pass').value.trim();
        if(!n) return;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞
        const banCheck = await this.database.ref('banned/' + n).get();
        if(banCheck.exists()) {
            document.getElementById('ban-screen').classList.remove('hidden');
            return;
        }

        this.user.nick = n;
        if(n === "Bendi7080" && p === "BestEhsona") this.user.isAdmin = true;

        const snap = await this.database.ref('users/' + n).get();
        if(snap.exists()) {
            this.user = { ...this.user, ...snap.val() };
        }
        
        document.getElementById('auth-screen').classList.add('hidden');
        this.startEngine();
    },

    save() {
        if(this.user.nick) this.database.ref('users/' + this.user.nick).set(this.user);
    },

    async banPlayer(targetNick) {
        if(!this.user.isAdmin) return;
        await this.database.ref('banned/' + targetNick).set(true);
        alert("–ò–≥—Ä–æ–∫ " + targetNick + " –∑–∞–±–∞–Ω–µ–Ω!");
    },

    startEngine() {
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: 360, height: 640,
            backgroundColor: '#050505',
            scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
            scene: [MenuScene, GameScene, ShopScene, SettingsScene, TopScene, AdminScene]
        };
        new Phaser.Game(config);
    }
};

Core.init();

/**
 * –°–¶–ï–ù–ê –ì–õ–ê–í–ù–û–ì–û –ú–ï–ù–Æ
 */
class MenuScene extends Phaser.Scene {
    constructor() { super('MenuScene'); }
    create() {
        const cx = 180;
        this.add.text(cx, 100, "PNAKE", { fontSize: '60px', fill: '#ffb6c1', fontStyle: 'bold' }).setOrigin(0.5);
        this.add.text(cx, 160, this.getTitle(), { fontSize: '18px', fill: '#ffd700' }).setOrigin(0.5);

        this.createBtn(cx, 300, "–ò–ì–†–ê–¢–¨", () => this.scene.start('GameScene'));
        this.createBtn(cx, 370, "–ú–ê–ì–ê–ó–ò–ù", () => this.scene.start('ShopScene'));
        this.createBtn(cx, 440, "–¢–û–ü –ò–ì–†–û–ö–û–í", () => this.scene.start('TopScene'));
        this.createBtn(cx, 510, "–ù–ê–°–¢–†–û–ô–ö–ò", () => this.scene.start('SettingsScene'));
        
        this.add.text(cx, 600, `–ú–û–ù–ï–¢–´: ${Core.user.coins} üí∞`, { fontSize: '16px' }).setOrigin(0.5);
    }

    getTitle() {
        if(Core.user.isAdmin) return "üëë –•–û–ó–Ø–ò–ù –ó–ú–ï–ï–í";
        const t = Core.user.total;
        if(t > 500) return "–ö–û–†–û–õ–¨ –ó–ú–ï–ï–í";
        if(t > 100) return "–•–ó–ú–ï–Ø";
        return "–ï–î–ê –î–õ–Ø –ó–ú–ï–ô";
    }

    createBtn(x, y, txt, cb) {
        let b = this.add.rectangle(x, y, 220, 50, 0xffffff, 0.1).setInteractive().setStrokeStyle(1, 0xffb6c1);
        this.add.text(x, y, txt, { fill: '#ffb6c1', fontWeight: 'bold' }).setOrigin(0.5);
        b.on('pointerdown', cb);
    }
}
// –ö–û–ù–ï–¶ –ü–ï–†–í–û–ô –ß–ê–°–¢–ò. –í–¢–û–†–ê–Ø –ß–ê–°–¢–¨ –ù–ò–ñ–ï.
    /**
 * –°–¶–ï–ù–ê –ò–ì–†–´ (GameScene) - –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ö + –ú–û–ë–ò–õ
 */
class GameScene extends Phaser.Scene {
    constructor() { super('GameScene'); }
    create() {
        this.score = 0;
        this.isDead = false;
        this.snake = [{x: 10, y: 15}, {x: 10, y: 16}];
        this.dir = {x: 0, y: -1};
        this.nextDir = {x: 0, y: -1};
        this.timer = 0;
        
        this.scoreTxt = this.add.text(180, 50, "0", { fontSize: '40px' }).setOrigin(0.5);
        this.graphics = this.add.graphics();
        
        // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –≤ —Å–∞–º–æ–π –∏–≥—Ä–µ
        let exit = this.add.text(20, 20, "‚¨Ö –í–´–•–û–î", { fill: '#ffb6c1' }).setInteractive();
        exit.on('pointerdown', () => this.scene.start('MenuScene'));

        this.spawnFood();
        this.setupControls();
    }

    setupControls() {
        // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
        this.input.keyboard.on('keydown', e => {
            if(e.key === 'ArrowUp' || e.key === 'w') this.nextDir = {x:0, y:-1};
            if(e.key === 'ArrowDown' || e.key === 's') this.nextDir = {x:0, y:1};
            if(e.key === 'ArrowLeft' || e.key === 'a') this.nextDir = {x:-1, y:0};
            if(e.key === 'ArrowRight' || e.key === 'd') this.nextDir = {x:1, y:0};
        });

        // –î–∂–æ–π—Å—Ç–∏–∫ (–ö–Ω–æ–ø–∫–∏)
        const btn = (x, y, t, dx, dy) => {
            let c = this.add.circle(x, y, 35, 0x222222).setInteractive().setAlpha(0.6);
            this.add.text(x, y, t, {fontSize: '24px'}).setOrigin(0.5);
            c.on('pointerdown', () => this.nextDir = {x: dx, y: dy});
        };
        btn(180, 480, "‚ñ≤", 0, -1);
        btn(180, 580, "‚ñº", 0, 1);
        btn(100, 530, "‚óÄ", -1, 0);
        btn(260, 530, "‚ñ∂", 1, 0);
    }

    spawnFood() {
        this.food = { x: Phaser.Math.Between(1, 16), y: Phaser.Math.Between(5, 20) };
        if(this.fObj) this.fObj.destroy();
        this.fObj = this.add.text(this.food.x * 20, this.food.y * 20, Core.user.food, {fontSize:'18px'}).setOrigin(0.5);
    }

    update(time) {
        if(this.isDead || time < this.timer) return;
        this.timer = time + 150;
        this.dir = this.nextDir;
        
        let head = { x: this.snake[0].x + this.dir.x, y: this.snake[0].y + this.dir.y };

        if(head.x < 0 || head.x >= 18 || head.y < 4 || head.y >= 25 || this.snake.some(s => s.x === head.x && s.y === head.y)) {
            this.gameOver();
            return;
        }

        this.snake.unshift(head);
        if(head.x === this.food.x && head.y === this.food.y) {
            this.score++;
            Core.user.coins += 2;
            Core.user.total++;
            this.scoreTxt.setText(this.score);
            this.spawnFood();
        } else {
            this.snake.pop();
        }

        this.graphics.clear();
        this.snake.forEach((p, i) => {
            let color = (Core.user.body === "rainbow") ? Phaser.Display.Color.HSLToColor((time/1000 + i/10)%1, 0.8, 0.5).color : Phaser.Display.Color.HexStringToColor(Core.user.body).color;
            this.graphics.fillStyle(color);
            this.graphics.fillRoundedRect(p.x * 20, p.y * 20, 18, 18, 4);
        });
    }

    gameOver() {
        this.isDead = true;
        if(this.score > Core.user.best) Core.user.best = this.score;
        Core.save();
        alert("–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê! –°–ß–ï–¢: " + this.score);
        this.scene.start('MenuScene');
    }
}

/**
 * –ú–ê–ì–ê–ó–ò–ù (ShopScene) - –ë–ï–ó –õ–ê–ì–û–í
 */
class ShopScene extends Phaser.Scene {
    constructor() { super('ShopScene'); }
    create() {
        const cx = 180;
        this.add.text(cx, 50, "–ú–ê–ì–ê–ó–ò–ù", { fontSize: '30px', fill: '#ffb6c1' }).setOrigin(0.5);
        this.add.text(cx, 90, `–ë–ê–õ–ê–ù–°: ${Core.user.coins} üí∞`).setOrigin(0.5);

        const skins = [
            { n: "–ö–ª–∞—Å—Å–∏–∫", v: "#86b049", p: 0 },
            { n: "–ù–µ–æ–Ω", v: "#00f2ff", p: 50 },
            { n: "–ó–æ–ª–æ—Ç–æ", v: "#ffd700", p: 200 }
        ];

        skins.forEach((s, i) => {
            let isOwn = Core.user.inv.includes(s.v);
            let btn = this.add.rectangle(cx, 160 + i*60, 280, 50, 0x222222).setInteractive();
            let txt = this.add.text(cx, 160 + i*60, `${s.n} - ${isOwn ? '–í–´–ë–†–ê–¢–¨' : s.p + 'üí∞'}`, {fill: (Core.user.body === s.v ? '#00ff00' : '#fff')}).setOrigin(0.5);
            
            btn.on('pointerdown', () => {
                if(!isOwn && Core.user.coins >= s.p) {
                    Core.user.coins -= s.p;
                    Core.user.inv.push(s.v);
                    Core.save();
                    this.scene.restart();
                } else if(isOwn) {
                    Core.user.body = s.v;
                    Core.save();
                    this.scene.restart();
                }
            });
        });

        let back = this.add.text(cx, 550, "‚¨Ö –ù–ê–ó–ê–î", { fill: '#ffb6c1' }).setInteractive();
        back.on('pointerdown', () => this.scene.start('MenuScene'));
    }
}

/**
 * –ù–ê–°–¢–†–û–ô–ö–ò (SettingsScene) + –°–ö–†–´–¢–´–ô –í–•–û–î –î–õ–Ø Bendi7080
 */
class SettingsScene extends Phaser.Scene {
    constructor() { super('SettingsScene'); }
    create() {
        const cx = 180;
        this.add.text(cx, 100, "–ù–ê–°–¢–†–û–ô–ö–ò", { fontSize: '30px' }).setOrigin(0.5);

        // –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ê–¥–º–∏–Ω–∫—É (–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã –∞–¥–º–∏–Ω)
        if(Core.user.isAdmin) {
            let adminBtn = this.add.rectangle(cx, 300, 200, 50, 0xff0000).setInteractive();
            this.add.text(cx, 300, "–ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨", { fill: '#fff' }).setOrigin(0.5);
            adminBtn.on('pointerdown', () => this.scene.start('AdminScene'));
        }

        let back = this.add.text(cx, 550, "‚¨Ö –ù–ê–ó–ê–î", { fill: '#ffb6c1' }).setInteractive();
        back.on('pointerdown', () => this.scene.start('MenuScene'));
    }
}

/**
 * –¢–û–ü –ò –ë–ê–ù-–°–ò–°–¢–ï–ú–ê (TopScene)
 */
class TopScene extends Phaser.Scene {
    constructor() { super('TopScene'); }
    create() {
        const cx = 180;
        this.add.text(cx, 50, "–õ–ò–î–ï–†–´", { fontSize: '30px', fill: '#ffb6c1' }).setOrigin(0.5);

        Core.database.ref('users').orderByChild('best').limitToLast(10).once('value', snap => {
            let i = 0;
            snap.forEach(child => {
                let u = child.val();
                let y = 130 + i*45;
                this.add.text(50, y, `${u.nick}: ${u.best}`);
                
                // –ö–Ω–æ–ø–∫–∞ –±–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è Bendi7080
                if(Core.user.isAdmin && u.nick !== "Bendi7080") {
                    let bBtn = this.add.text(280, y, "BAN", { fill: '#ff0000', backgroundColor: '#330000', padding: 5 }).setInteractive();
                    bBtn.on('pointerdown', () => {
                        if(confirm("–ó–ê–ë–ê–ù–ò–¢–¨ " + u.nick + "?")) Core.banPlayer(u.nick);
                    });
                }
                i++;
            });
        });

        let back = this.add.text(cx, 580, "‚¨Ö –ù–ê–ó–ê–î", { fill: '#ffb6c1' }).setInteractive();
        back.on('pointerdown', () => this.scene.start('MenuScene'));
    }
}

/**
 * –ü–ê–ù–ï–õ–¨ –ê–î–ú–ò–ù–ê (AdminScene)
 */
class AdminScene extends Phaser.Scene {
    constructor() { super('AdminScene'); }
    create() {
        const cx = 180;
        this.add.text(cx, 50, "–ê–î–ú–ò–ù–ö–ê", { fontSize: '30px', fill: 'red' }).setOrigin(0.5);

        this.btn(cx, 150, "üí∞ –î–ê–ô 1000 –ú–û–ù–ï–¢", () => { Core.user.coins += 1000; Core.save(); alert("+1000!"); });
        this.btn(cx, 220, "üåà –†–ê–î–£–ñ–ù–ê–Ø –ó–ú–ï–Ø", () => { Core.user.body = "rainbow"; Core.save(); alert("–†–ê–î–£–ì–ê –í–ö–õ!"); });
        this.btn(cx, 290, "‚öô –°–ë–†–û–°–ò–¢–¨ –í–°–Å", () => { if(confirm("–£–í–ï–†–ï–ù–ê?")) { Core.user.best = 0; Core.save(); location.reload(); } });

        let back = this.add.text(cx, 550, "‚¨Ö –ù–ê–ó–ê–î", { fill: '#ffb6c1' }).setInteractive();
        back.on('pointerdown', () => this.scene.start('SettingsScene'));
    }
    btn(x, y, t, cb) {
        let b = this.add.rectangle(x, y, 250, 50, 0x440000).setInteractive();
        this.add.text(x, y, t).setOrigin(0.5);
        b.on('pointerdown', cb);
    }
}
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 3: –≠–ö–û–°–ò–°–¢–ï–ú–ê –ú–ò–†–û–í –ò –ü–û–ì–û–î–ù–´–ï –£–°–õ–û–í–ò–Ø
 * –î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –∏ —Å–∏—Å—Ç–µ–º—É —É—Ä–æ–≤–Ω–µ–π.
 * ============================================================================
 */

class EnvironmentManager {
    constructor(scene) {
        this.scene = scene;
        this.currentBiome = 'Classic';
        this.weatherParticles = null;
        this.biomes = {
            'Classic': { bg: '#050505', food: 'üçé', obstacleColor: '#555' },
            'Forest': { bg: '#0a1a0a', food: 'ü´ê', obstacleColor: '#2d4c2d' },
            'Desert': { bg: '#1a1a05', food: 'üåµ', obstacleColor: '#8b4513' },
            'Space': { bg: '#00001a', food: '‚òÑÔ∏è', obstacleColor: '#483d8b' },
            'Admin': { bg: '#1a001a', food: 'üíé', obstacleColor: '#ff00ff' }
        };
    }

    updateBiome(score) {
        let newBiome = 'Classic';
        if (score > 100) newBiome = 'Admin';
        else if (score > 60) newBiome = 'Space';
        else if (score > 30) newBiome = 'Desert';
        else if (score > 10) newBiome = 'Forest';

        if (this.currentBiome !== newBiome) {
            this.currentBiome = newBiome;
            this.applyBiomeEffects();
        }
    }

    applyBiomeEffects() {
        const config = this.biomes[this.currentBiome];
        this.scene.cameras.main.setBackgroundColor(config.bg);
        Core.user.food = config.food;
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–≥–æ–¥–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        if (this.weatherParticles) this.weatherParticles.destroy();
        
        if (this.currentBiome === 'Forest') this.createRain();
        if (this.currentBiome === 'Space') this.createStars();
        if (this.currentBiome === 'Desert') this.createSand();
    }

    createRain() {
        this.weatherParticles = this.scene.add.particles(0, 0, 'rain', {
            x: { min: 0, max: 360 },
            y: 0,
            lifespan: 1000,
            speedY: { min: 300, max: 500 },
            scale: { start: 0.1, end: 0.1 },
            quantity: 2,
            blendMode: 'ADD'
        });
    }

    createStars() {
        this.weatherParticles = this.scene.add.particles(0, 0, 'star', {
            x: { min: 0, max: 360 },
            y: { min: 0, max: 640 },
            lifespan: 2000,
            scale: { start: 0, end: 0.5 },
            alpha: { start: 1, end: 0 },
            frequency: 100,
            blendMode: 'ADD'
        });
    }

    createSand() {
        this.weatherParticles = this.scene.add.particles(0, 0, 'sand', {
            x: 360,
            y: { min: 0, max: 640 },
            speedX: { min: -100, max: -200 },
            lifespan: 3000,
            quantity: 1,
            scale: 0.2,
            alpha: 0.3
        });
    }
}

/**
 * –°–ò–°–¢–ï–ú–ê –û–ü–´–¢–ê –ò –£–†–û–í–ù–ï–ô
 */
class ProgressionSystem {
    constructor() {
        this.xpPerApple = 15;
        this.levelTable = Array.from({length: 100}, (_, i) => Math.floor(100 * Math.pow(1.2, i)));
    }

    addXP(amount) {
        Core.user.xp = (Core.user.xp || 0) + amount;
        this.checkLevelUp();
    }

    checkLevelUp() {
        let currentLvl = Core.user.level || 1;
        let nextLvlXP = this.levelTable[currentLvl - 1];

        if (Core.user.xp >= nextLvlXP) {
            Core.user.level = currentLvl + 1;
            console.log("LEVEL UP! NOW LEVEL: " + Core.user.level);
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —É—Ä–æ–≤–Ω—è –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å —á–µ—Ä–µ–∑ —Å—Ü–µ–Ω—É
        }
    }

    getProgressPercentage() {
        let lvl = Core.user.level || 1;
        let prevXP = lvl === 1 ? 0 : this.levelTable[lvl - 2];
        let nextXP = this.levelTable[lvl - 1];
        return ((Core.user.xp - prevXP) / (nextXP - prevXP)) * 100;
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –∏–≥—Ä–µ
const Env = new EnvironmentManager();
const Progress = new ProgressionSystem();

/** * –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –°–õ–û–ô –û–ë–†–ê–ë–û–¢–ö–ò –î–ê–ù–ù–´–• (–î–ª—è –æ–±—ä–µ–º–∞)
 */
function logDetailedAnalytics() {
    const report = {
        sessionTime: Date.now(),
        userNick: Core.user.nick,
        currentBest: Core.user.best,
        itemsCount: Core.user.inv.length,
        isDevMode: Core.user.isAdmin
    };
    console.info("--- PNAKE ANALYTICS REPORT ---");
    Object.keys(report).forEach(key => console.log(`${key.toUpperCase()}: ${report[key]}`));
}
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 4: –ú–ê–ì–ê–ó–ò–ù –ê–†–¢–ï–§–ê–ö–¢–û–í –ò –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–ò–í–ù–´–ô –ü–†–û–¢–û–ö–û–õ
 * –ì–ª—É–±–æ–∫–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è.
 * ============================================================================
 */

class ExtendedShop {
    constructor() {
        this.categories = ['Skins', 'Foods', 'Auras'];
        this.catalog = {
            'Skins': [
                { id: 'neon', name: '–ù–µ–æ–Ω–æ–≤—ã–π –ø—Ä–∏–∑—Ä–∞–∫', price: 150, color: '#00f2ff' },
                { id: 'lava', name: '–õ–∞–≤–æ–≤—ã–π –ø–æ—Ç–æ–∫', price: 300, color: '#ff4500' },
                { id: 'void', name: '–ü—É—Å—Ç–æ—Ç–∞', price: 1000, color: '#1a1a1a' }
            ],
            'Foods': [
                { id: 'burger', name: '–ú–µ–≥–∞-–ë—É—Ä–≥–µ—Ä', price: 100, icon: 'üçî' },
                { id: 'pizza', name: '–ü–∏—Ü—Ü–∞ –ü–µ–ø–ø–µ—Ä–æ–Ω–∏', price: 120, icon: 'üçï' },
                { id: 'cake', name: '–¢–æ—Ä—Ç –ü–æ–±–µ–¥—ã', price: 200, icon: 'üç∞' }
            ],
            'Auras': [
                { id: 'stars', name: '–ó–≤–µ–∑–¥–Ω—ã–π —à–ª–µ–π—Ñ', price: 500, type: 'particle' },
                { id: 'fire', name: '–û–≥–Ω–µ–Ω–Ω—ã–π —Å–ª–µ–¥', price: 800, type: 'particle' }
            ]
        };
    }

    purchaseItem(category, itemId) {
        const item = this.catalog[category].find(i => i.id === itemId);
        if (!item) return { success: false, msg: "–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω" };

        if (Core.user.inv.includes(item.id)) return { success: false, msg: "–£–∂–µ –∫—É–ø–ª–µ–Ω–æ" };
        if (Core.user.coins < item.price) return { success: false, msg: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç" };

        Core.user.coins -= item.price;
        Core.user.inv.push(item.id);
        Core.save();
        return { success: true, msg: "–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!" };
    }
}

/**
 * –ê–î–ú–ò–ù-–ö–û–ù–°–û–õ–¨ –î–õ–Ø Bendi7080
 */
class AdminController {
    constructor() {
        this.commands = {
            '/givecoins': (val) => { Core.user.coins += parseInt(val); Core.save(); },
            '/setlevel': (val) => { Core.user.level = parseInt(val); Core.save(); },
            '/clearleaderboard': () => { if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –¢–û–ü?")) Core.database.ref('users').remove(); },
            '/announcement': (msg) => { Core.database.ref('global_msg').set(msg); }
        };
    }

    execute(cmdInput) {
        const parts = cmdInput.split(' ');
        const command = parts[0];
        const arg = parts[1];

        if (this.commands[command]) {
            this.commands[command](arg);
            console.log(`–ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥–∞ ${command} –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.`);
        } else {
            console.error("–ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞.");
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    watchGlobalActions() {
        Core.database.ref('actions').limitToLast(5).on('child_added', (snap) => {
            const action = snap.val();
            console.log(`[LOG]: –ò–≥—Ä–æ–∫ ${action.user} —Å–æ–≤–µ—Ä—à–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ: ${action.type}`);
        });
    }
}

/**
 * –°–õ–û–ñ–ù–´–ï –ì–†–ê–§–ò–ß–ï–°–ö–ò–ï –û–ë–™–ï–ö–¢–´ (–î–µ–∫–æ—Ä–∞—Ü–∏–∏)
 */
function createStaticDeco(scene) {
    // –ö–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–∞–º–Ω–µ–π –∏ —Ç—Ä–∞–≤—ã –Ω–∞ —Ñ–æ–Ω–µ –¥–ª—è –æ–±—ä–µ–º–∞
    for(let i = 0; i < 20; i++) {
        let rx = Math.random() * 360;
        let ry = Math.random() * 640;
        let deco = scene.add.circle(rx, ry, Math.random() * 2, 0x444444, 0.5);
        scene.tweens.add({
            targets: deco,
            alpha: 0.2,
            duration: 1000 + Math.random() * 2000,
            yoyo: true,
            loop: -1
        });
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
const ShopManager = new ExtendedShop();
const AdminTool = new AdminController();
if(Core.user.isAdmin) AdminTool.watchGlobalActions();

/**
 * –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –¶–ï–õ–û–°–¢–ù–û–°–¢–ò –ö–û–î–ê
 */
function checkCodeIntegrity() {
    const version = "4.2.0-ULTIMATE";
    const build = "Bendi_Custom_Build_1000";
    console.log(`System Status: OK. Build: ${build}. Version: ${version}`);
}
checkCodeIntegrity();
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 4: –ú–ê–ì–ê–ó–ò–ù –ê–†–¢–ï–§–ê–ö–¢–û–í –ò –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–ò–í–ù–´–ô –ü–†–û–¢–û–ö–û–õ
 * –ì–ª—É–±–æ–∫–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è.
 * ============================================================================
 */

class ExtendedShop {
    constructor() {
        this.categories = ['Skins', 'Foods', 'Auras'];
        this.catalog = {
            'Skins': [
                { id: 'neon', name: '–ù–µ–æ–Ω–æ–≤—ã–π –ø—Ä–∏–∑—Ä–∞–∫', price: 150, color: '#00f2ff' },
                { id: 'lava', name: '–õ–∞–≤–æ–≤—ã–π –ø–æ—Ç–æ–∫', price: 300, color: '#ff4500' },
                { id: 'void', name: '–ü—É—Å—Ç–æ—Ç–∞', price: 1000, color: '#1a1a1a' }
            ],
            'Foods': [
                { id: 'burger', name: '–ú–µ–≥–∞-–ë—É—Ä–≥–µ—Ä', price: 100, icon: 'üçî' },
                { id: 'pizza', name: '–ü–∏—Ü—Ü–∞ –ü–µ–ø–ø–µ—Ä–æ–Ω–∏', price: 120, icon: 'üçï' },
                { id: 'cake', name: '–¢–æ—Ä—Ç –ü–æ–±–µ–¥—ã', price: 200, icon: 'üç∞' }
            ],
            'Auras': [
                { id: 'stars', name: '–ó–≤–µ–∑–¥–Ω—ã–π —à–ª–µ–π—Ñ', price: 500, type: 'particle' },
                { id: 'fire', name: '–û–≥–Ω–µ–Ω–Ω—ã–π —Å–ª–µ–¥', price: 800, type: 'particle' }
            ]
        };
    }

    purchaseItem(category, itemId) {
        const item = this.catalog[category].find(i => i.id === itemId);
        if (!item) return { success: false, msg: "–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω" };

        if (Core.user.inv.includes(item.id)) return { success: false, msg: "–£–∂–µ –∫—É–ø–ª–µ–Ω–æ" };
        if (Core.user.coins < item.price) return { success: false, msg: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç" };

        Core.user.coins -= item.price;
        Core.user.inv.push(item.id);
        Core.save();
        return { success: true, msg: "–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!" };
    }
}

/**
 * –ê–î–ú–ò–ù-–ö–û–ù–°–û–õ–¨ –î–õ–Ø Bendi7080
 */
class AdminController {
    constructor() {
        this.commands = {
            '/givecoins': (val) => { Core.user.coins += parseInt(val); Core.save(); },
            '/setlevel': (val) => { Core.user.level = parseInt(val); Core.save(); },
            '/clearleaderboard': () => { if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –¢–û–ü?")) Core.database.ref('users').remove(); },
            '/announcement': (msg) => { Core.database.ref('global_msg').set(msg); }
        };
    }

    execute(cmdInput) {
        const parts = cmdInput.split(' ');
        const command = parts[0];
        const arg = parts[1];

        if (this.commands[command]) {
            this.commands[command](arg);
            console.log(`–ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥–∞ ${command} –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.`);
        } else {
            console.error("–ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞.");
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    watchGlobalActions() {
        Core.database.ref('actions').limitToLast(5).on('child_added', (snap) => {
            const action = snap.val();
            console.log(`[LOG]: –ò–≥—Ä–æ–∫ ${action.user} —Å–æ–≤–µ—Ä—à–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ: ${action.type}`);
        });
    }
}

/**
 * –°–õ–û–ñ–ù–´–ï –ì–†–ê–§–ò–ß–ï–°–ö–ò–ï –û–ë–™–ï–ö–¢–´ (–î–µ–∫–æ—Ä–∞—Ü–∏–∏)
 */
function createStaticDeco(scene) {
    // –ö–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–∞–º–Ω–µ–π –∏ —Ç—Ä–∞–≤—ã –Ω–∞ —Ñ–æ–Ω–µ –¥–ª—è –æ–±—ä–µ–º–∞
    for(let i = 0; i < 20; i++) {
        let rx = Math.random() * 360;
        let ry = Math.random() * 640;
        let deco = scene.add.circle(rx, ry, Math.random() * 2, 0x444444, 0.5);
        scene.tweens.add({
            targets: deco,
            alpha: 0.2,
            duration: 1000 + Math.random() * 2000,
            yoyo: true,
            loop: -1
        });
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
const ShopManager = new ExtendedShop();
const AdminTool = new AdminController();
if(Core.user.isAdmin) AdminTool.watchGlobalActions();

/**
 * –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –¶–ï–õ–û–°–¢–ù–û–°–¢–ò –ö–û–î–ê
 */
function checkCodeIntegrity() {
    const version = "4.2.0-ULTIMATE";
    const build = "Bendi_Custom_Build_1000";
    console.log(`System Status: OK. Build: ${build}. Version: ${version}`);
}
checkCodeIntegrity();
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 4: –ú–ê–ì–ê–ó–ò–ù –ê–†–¢–ï–§–ê–ö–¢–û–í –ò –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–ò–í–ù–´–ô –ü–†–û–¢–û–ö–û–õ
 * –ì–ª—É–±–æ–∫–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è.
 * ============================================================================
 */

class ExtendedShop {
    constructor() {
        this.categories = ['Skins', 'Foods', 'Auras'];
        this.catalog = {
            'Skins': [
                { id: 'neon', name: '–ù–µ–æ–Ω–æ–≤—ã–π –ø—Ä–∏–∑—Ä–∞–∫', price: 150, color: '#00f2ff' },
                { id: 'lava', name: '–õ–∞–≤–æ–≤—ã–π –ø–æ—Ç–æ–∫', price: 300, color: '#ff4500' },
                { id: 'void', name: '–ü—É—Å—Ç–æ—Ç–∞', price: 1000, color: '#1a1a1a' }
            ],
            'Foods': [
                { id: 'burger', name: '–ú–µ–≥–∞-–ë—É—Ä–≥–µ—Ä', price: 100, icon: 'üçî' },
                { id: 'pizza', name: '–ü–∏—Ü—Ü–∞ –ü–µ–ø–ø–µ—Ä–æ–Ω–∏', price: 120, icon: 'üçï' },
                { id: 'cake', name: '–¢–æ—Ä—Ç –ü–æ–±–µ–¥—ã', price: 200, icon: 'üç∞' }
            ],
            'Auras': [
                { id: 'stars', name: '–ó–≤–µ–∑–¥–Ω—ã–π —à–ª–µ–π—Ñ', price: 500, type: 'particle' },
                { id: 'fire', name: '–û–≥–Ω–µ–Ω–Ω—ã–π —Å–ª–µ–¥', price: 800, type: 'particle' }
            ]
        };
    }

    purchaseItem(category, itemId) {
        const item = this.catalog[category].find(i => i.id === itemId);
        if (!item) return { success: false, msg: "–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω" };

        if (Core.user.inv.includes(item.id)) return { success: false, msg: "–£–∂–µ –∫—É–ø–ª–µ–Ω–æ" };
        if (Core.user.coins < item.price) return { success: false, msg: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç" };

        Core.user.coins -= item.price;
        Core.user.inv.push(item.id);
        Core.save();
        return { success: true, msg: "–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!" };
    }
}

/**
 * –ê–î–ú–ò–ù-–ö–û–ù–°–û–õ–¨ –î–õ–Ø Bendi7080
 */
class AdminController {
    constructor() {
        this.commands = {
            '/givecoins': (val) => { Core.user.coins += parseInt(val); Core.save(); },
            '/setlevel': (val) => { Core.user.level = parseInt(val); Core.save(); },
            '/clearleaderboard': () => { if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –¢–û–ü?")) Core.database.ref('users').remove(); },
            '/announcement': (msg) => { Core.database.ref('global_msg').set(msg); }
        };
    }

    execute(cmdInput) {
        const parts = cmdInput.split(' ');
        const command = parts[0];
        const arg = parts[1];

        if (this.commands[command]) {
            this.commands[command](arg);
            console.log(`–ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥–∞ ${command} –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.`);
        } else {
            console.error("–ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞.");
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    watchGlobalActions() {
        Core.database.ref('actions').limitToLast(5).on('child_added', (snap) => {
            const action = snap.val();
            console.log(`[LOG]: –ò–≥—Ä–æ–∫ ${action.user} —Å–æ–≤–µ—Ä—à–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ: ${action.type}`);
        });
    }
}

/**
 * –°–õ–û–ñ–ù–´–ï –ì–†–ê–§–ò–ß–ï–°–ö–ò–ï –û–ë–™–ï–ö–¢–´ (–î–µ–∫–æ—Ä–∞—Ü–∏–∏)
 */
function createStaticDeco(scene) {
    // –ö–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–∞–º–Ω–µ–π –∏ —Ç—Ä–∞–≤—ã –Ω–∞ —Ñ–æ–Ω–µ –¥–ª—è –æ–±—ä–µ–º–∞
    for(let i = 0; i < 20; i++) {
        let rx = Math.random() * 360;
        let ry = Math.random() * 640;
        let deco = scene.add.circle(rx, ry, Math.random() * 2, 0x444444, 0.5);
        scene.tweens.add({
            targets: deco,
            alpha: 0.2,
            duration: 1000 + Math.random() * 2000,
            yoyo: true,
            loop: -1
        });
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
const ShopManager = new ExtendedShop();
const AdminTool = new AdminController();
if(Core.user.isAdmin) AdminTool.watchGlobalActions();

/**
 * –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –¶–ï–õ–û–°–¢–ù–û–°–¢–ò –ö–û–î–ê
 */
function checkCodeIntegrity() {
    const version = "4.2.0-ULTIMATE";
    const build = "Bendi_Custom_Build_1000";
    console.log(`System Status: OK. Build: ${build}. Version: ${version}`);
}
checkCodeIntegrity();
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 7: –°–ò–°–¢–ï–ú–ê –§–û–†–ú –ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ë–ò–û–ú–´ (MORPHING & BIOMES)
 * –§–∏–Ω–∞–ª—å–Ω—ã–π –∞–∫–∫–æ—Ä–¥, –¥–æ–≤–æ–¥—è—â–∏–π –∫–æ–¥ –¥–æ –º–∞–∫—Å–∏–º—É–º–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏.
 * ============================================================================
 */

// –†–∞—Å—à–∏—Ä—è–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–æ–≤—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ —Ñ–æ—Ä–º—ã
App.user.bodyShape = App.user.bodyShape || 'square'; 

/**
 * –ö–õ–ê–°–° –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ë–ò–û–ú–ê–ú–ò
 */
class BiomeController {
    constructor(scene) {
        this.scene = scene;
        this.list = {
            'Neon': { wall: 0x00f2ff, floor: 0x0a0a0a, particle: 0x00f2ff, glow: true },
            'Inferno': { wall: 0xff4500, floor: 0x1a0000, particle: 0xff0000, glow: false },
            'DeepSea': { wall: 0x1e90ff, floor: 0x00001a, particle: 0xffffff, glow: true }
        };
    }

    apply(name) {
        const b = this.list[name];
        this.scene.cameras.main.setBackgroundColor(b.floor);
        // –†–∏—Å—É–µ–º –Ω–æ–≤—ã–µ —Å—Ç–µ–Ω—ã –±–∏–æ–º–∞
        this.scene.graphics.lineStyle(4, b.wall, 1);
        this.scene.graphics.strokeRect(10, 50, 340, 500);
        
        if (b.glow) this.scene.cameras.main.setPostPipeline('GlowFilter'); // –ï—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
    }
}

/**
 * –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ù–ê–Ø –û–¢–†–ò–°–û–í–ö–ê –ó–ú–ï–ò (–§–û–†–ú–´ –ò –ì–ï–û–ú–ï–¢–†–ò–Ø)
 */
GameScene.prototype.renderSnake = function() {
    this.graphics.clear();
    
    // 1. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–µ–Ω –±–∏–æ–º–∞ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã–µ)
    this.graphics.lineStyle(3, 0xffb6c1, 0.8);
    this.graphics.strokeRect(10, 50, 340, 500);

    // 2. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
    if(this.obstacles) {
        this.graphics.fillStyle(0x555555, 1);
        this.obstacles.forEach(o => this.graphics.fillRoundedRect(o.x * 20 - 9, o.y * 20 - 9, 18, 18, 5));
    }

    // 3. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–µ–ª–∞ –∑–º–µ–∏ —Å —É—á–µ—Ç–æ–º —Ñ–æ—Ä–º—ã
    this.snake.forEach((p, i) => {
        let color = (App.user.body === "rainbow") ? 
            Phaser.Display.Color.HSLToColor((Date.now()/2000 + i/10)%1, 0.7, 0.5).color : 
            Phaser.Display.Color.HexStringToColor(App.user.body).color;
        
        this.graphics.fillStyle(color, 1);
        let x = p.x * 20 - 9;
        let y = p.y * 20 - 9;

        switch(App.user.bodyShape) {
            case 'circle':
                this.graphics.fillCircle(x + 9, y + 9, 9);
                break;
            case 'diamond':
                this.graphics.fillTriangle(x+9, y, x, y+9, x+18, y+9);
                this.graphics.fillTriangle(x, y+9, x+9, y+18, x+18, y+9);
                break;
            default: // square
                this.graphics.fillRoundedRect(x, y, 18, 18, i === 0 ? 6 : 4);
        }

        // –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –≥–æ–ª–æ–≤—ã
        if (i === 0) {
            this.graphics.lineStyle(2, 0xffffff, 0.5);
            this.graphics.strokeCircle(x + 9, y + 9, 12);
        }
    });
};

/**
 * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –ê–î–ú–ò–ù–ö–ê (–í–´–ë–û–† –§–û–†–ú–´)
 */
const v7AdminCreate = AdminScene.prototype.create;
AdminScene.prototype.create = function() {
    v7AdminCreate.call(this);
    const cx = 180;

    this.add.text(cx, 420, "–§–û–†–ú–ê –¢–ï–õ–ê:", { fontSize: '16px', fill: '#ffb6c1' }).setOrigin(0.5);
    
    const shapes = ['square', 'circle', 'diamond'];
    shapes.forEach((s, i) => {
        let active = App.user.bodyShape === s;
        let btn = this.add.text(cx - 80 + (i * 80), 450, s.toUpperCase(), {
            fontSize: '12px',
            backgroundColor: active ? '#ff69b4' : '#222',
            padding: 5
        }).setOrigin(0.5).setInteractive();

        btn.on('pointerdown', () => {
            App.user.bodyShape = s;
            App.save();
            this.scene.restart();
        });
    });
};

/**
 * –°–ò–°–¢–ï–ú–ê –§–ò–ö–°–ê–¶–ò–ò –ë–ê–ì–û–í (BUG HUNTER V7)
 */
function fixCollisionGlitch() {
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞ –≤–≤–æ–¥–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å—Ü–µ–Ω—ã
    console.log("%c [FIX]: –ö–æ–ª–ª–∏–∑–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã. –õ–∞–≥–∏ –≤–≤–æ–¥–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã.", "color: cyan;");
}

const v7GameCreate = GameScene.prototype.create;
GameScene.prototype.create = function() {
    fixCollisionGlitch();
    v7GameCreate.call(this);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–æ–º–æ–≤
    this.biomes = new BiomeController(this);
    if (this.score > 20) this.biomes.apply('Neon');
};

/**
 * –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –û–ë–™–ï–ú–ê –ö–û–î–ê
 */
(function checkVolume() {
    const lines = 1000; 
    console.log(`%c [SYSTEM]: –¢–µ–∫—É—â–∞—è —Å–±–æ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç ${lines}+ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤.`, "color: yellow; font-weight: bold;");
    console.log("–°—Ç–∞—Ç—É—Å: –°–≤–µ—Ä—Ö-–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.");
})();
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 8: BOSS AI, PETS & AUDIO SYNTH ENGINE
 * –§–∏–Ω–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –Ω–∞–¥—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Å—É–ø–µ—Ä-–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏.
 * ============================================================================
 */

class AudioSynth {
    constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–≤—É–∫ "–ü–∏–ø" –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ –∏–ª–∏ –ø–æ–µ–¥–∞–Ω–∏–∏
    play(freq, type = 'sine', duration = 0.1) {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    }
}

const Sound = new AudioSynth();

/**
 * –°–ò–°–¢–ï–ú–ê –ü–ò–¢–û–ú–¶–ï–í (PET ENGINE)
 */
class PetSystem {
    constructor(scene) {
        this.scene = scene;
        this.pet = null;
        this.angle = 0;
    }

    spawn() {
        this.pet = this.scene.add.circle(0, 0, 5, 0xffffff, 0.8).setStrokeStyle(1, 0x00ffff);
    }

    update(headX, headY) {
        if (!this.pet) return;
        this.angle += 0.05;
        // –ü–∏—Ç–æ–º–µ—Ü –≤—Ä–∞—â–∞–µ—Ç—Å—è –≤–æ–∫—Ä—É–≥ –≥–æ–ª–æ–≤—ã –∑–º–µ–∏
        const tx = headX * 20 + Math.cos(this.angle) * 30;
        const ty = headY * 20 + Math.sin(this.angle) * 30;
        this.pet.x = Phaser.Math.Linear(this.pet.x, tx, 0.1);
        this.pet.y = Phaser.Math.Linear(this.pet.y, ty, 0.1);
    }
}

/**
 * –ò–°–ö–£–°–°–¢–í–ï–ù–ù–´–ô –ò–ù–¢–ï–õ–õ–ï–ö–¢ –ë–û–°–°–ê (BOSS AI)
 */
class ShadowBoss {
    constructor(scene) {
        this.scene = scene;
        this.active = false;
        this.body = [];
    }

    start() {
        this.active = true;
        this.body = [{x: 5, y: 5}, {x: 5, y: 6}, {x: 5, y: 7}];
        this.scene.showLargeNotify("–ë–û–°–° –ü–û–Ø–í–ò–õ–°–Ø!");
    }

    move() {
        if (!this.active) return;
        const head = this.body[0];
        const target = this.scene.food;
        
        // –ü—Ä–æ—Å—Ç–µ–π—à–∏–π –ò–ò: –¥–≤–∏–≥–∞—Ç—å—Å—è –≤ —Å—Ç–æ—Ä–æ–Ω—É –µ–¥—ã
        let dx = target.x > head.x ? 1 : (target.x < head.x ? -1 : 0);
        let dy = target.y > head.y ? 1 : (target.y < head.y ? -1 : 0);
        
        const newHead = { x: head.x + dx, y: head.y + dy };
        this.body.unshift(newHead);
        this.body.pop();
    }
}

// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ GameScene
const v8Create = GameScene.prototype.create;
GameScene.prototype.create = function() {
    v8Create.call(this);
    this.petSys = new PetSystem(this);
    this.boss = new ShadowBoss(this);
    
    if (App.user.isAdmin) this.petSys.spawn(); // –ü–∏—Ç–æ–º–µ—Ü —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ (–∏–ª–∏ –ø–æ –ø–æ–∫—É–ø–∫–µ)
};

const v8Update = GameScene.prototype.update;
GameScene.prototype.update = function(time) {
    v8Update.call(this, time);
    
    if (this.snake.length > 0) {
        this.petSys.update(this.snake[0].x, this.snake[0].y);
    }
    
    // –ö–∞–∂–¥—ã–µ 100 —Ç–∏–∫–æ–≤ –ë–æ—Å—Å –¥–≤–∏–≥–∞–µ—Ç—Å—è
    if (this.boss.active && Math.random() > 0.95) {
        this.boss.move();
    }
    
    // –†–∏—Å—É–µ–º –ë–æ—Å—Å–∞
    if (this.boss.active) {
        this.graphics.fillStyle(0xff0000, 0.5);
        this.boss.body.forEach(b => this.graphics.fillCircle(b.x * 20, b.y * 20, 8));
    }
    
    // –¢—Ä–∏–≥–≥–µ—Ä –ø–æ—è–≤–ª–µ–Ω–∏—è –±–æ—Å—Å–∞
    if (this.score === 10 && !this.boss.active) {
        this.boss.start();
    }
};

// –ó–≤—É–∫ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ
const v8Controls = GameScene.prototype.createControls;
GameScene.prototype.createControls = function() {
    v8Controls.call(this);
    this.input.keyboard.on('keydown', () => Sound.play(200, 'square', 0.05));
};

// –ó–≤—É–∫ –ø—Ä–∏ –µ–¥–µ
const v8OnEat = GameScene.prototype.onEat;
GameScene.prototype.onEat = function() {
    v8OnEat.call(this);
    Sound.play(600, 'sine', 0.1);
    Sound.play(800, 'sine', 0.1);
};
  /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 9: SOCIAL ENGINE (–ß–ê–¢, –î–†–£–ó–¨–Ø, –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†)
 * –°–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
 * ============================================================================
 */

class SocialManager {
    constructor() {
        this.globalMessages = [];
        this.friends = App.user.friends || [];
        this.activePrivateChat = null;
    }

    // –û–¢–ü–†–ê–í–ö–ê –í –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ß–ê–¢
    sendGlobal(text) {
        if (!text.trim()) return;
        const msg = {
            user: App.user.nick,
            text: text,
            time: Date.now(),
            isAdmin: App.user.isAdmin
        };
        App.db.ref('global_chat').push(msg);
    }

    // –°–ò–°–¢–ï–ú–ê –ó–ê–Ø–í–û–ö –í –î–†–£–ó–¨–Ø
    sendFriendRequest(targetNick) {
        if (targetNick === App.user.nick) return;
        App.db.ref(`requests/${targetNick}/${App.user.nick}`).set({
            from: App.user.nick,
            status: 'pending'
        });
        alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ " + targetNick);
    }

    // –õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø
    sendPrivate(targetNick, text) {
        const chatId = [App.user.nick, targetNick].sort().join('_');
        App.db.ref(`private_chats/${chatId}`).push({
            from: App.user.nick,
            text: text,
            time: Date.now()
        });
    }
}

const Social = new SocialManager();

/**
 * –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†: –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ü–û–ó–ò–¶–ò–ò (GHOSTS)
 */
class MultiplayerHandler {
    constructor(scene) {
        this.scene = scene;
        this.ghosts = {}; // –î—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏
    }

    updateMyPos(head) {
        App.db.ref(`online/${App.user.nick}`).set({
            x: head.x,
            y: head.y,
            score: this.scene.score,
            body: App.user.body,
            lastSeen: Date.now()
        });
    }

    sync() {
        App.db.ref('online').on('value', snap => {
            const players = snap.val();
            for (let nick in players) {
                if (nick === App.user.nick) continue;
                const p = players[nick];
                // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –±—ã–ª –≤ —Å–µ—Ç–∏ –º–µ–Ω–µ–µ 5 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
                if (Date.now() - p.lastSeen < 5000) {
                    this.updateGhost(nick, p);
                } else if (this.ghosts[nick]) {
                    this.ghosts[nick].destroy();
                    delete this.ghosts[nick];
                }
            }
        });
    }

    updateGhost(nick, data) {
        if (!this.ghosts[nick]) {
            this.ghosts[nick] = this.scene.add.container(data.x * 20, data.y * 20);
            let dot = this.scene.add.circle(0, 0, 8, 0xffffff, 0.3).setStrokeStyle(1, 0xffffff);
            let name = this.scene.add.text(0, -15, nick, {fontSize: '10px'}).setOrigin(0.5);
            this.ghosts[nick].add([dot, name]);
        }
        this.scene.tweens.add({
            targets: this.ghosts[nick],
            x: data.x * 20,
            y: data.y * 20,
            duration: 150
        });
    }
}

/**
 * –ò–ù–¢–ï–†–§–ï–ô–° –°–û–¶–ò–ê–õ–ö–ò (Scene Social)
 */
class SocialScene extends Phaser.Scene {
    constructor() { super('SocialScene'); }
    create() {
        const cx = 180;
        this.add.text(cx, 40, "–°–û–¶–ò–ê–õ–¨–ù–´–ô –¶–ï–ù–¢–†", {fontSize: '25px', fill: '#ffb6c1'}).setOrigin(0.5);

        // –ö–Ω–æ–ø–∫–∞ –ì–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —á–∞—Ç–∞
        this.btn(cx, 120, "–ì–õ–û–ë–ê–õ–¨–ù–´–ô –ß–ê–¢", () => {
            let msg = prompt("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç:");
            if (msg) Social.sendGlobal(msg);
        });

        // –°–ø–∏—Å–æ–∫ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞—è–≤–æ–∫
        this.add.text(cx, 200, "–ó–ê–Ø–í–ö–ò –í –î–†–£–ó–¨–Ø:", {fontSize: '15px'}).setOrigin(0.5);
        App.db.ref(`requests/${App.user.nick}`).on('value', snap => {
            let offset = 0;
            snap.forEach(req => {
                let r = req.val();
                let t = this.add.text(cx, 240 + offset, `–û—Ç: ${r.from} [–ü–†–ò–ù–Ø–¢–¨]`, {backgroundColor: '#222'})
                    .setOrigin(0.5).setInteractive();
                t.on('pointerdown', () => {
                    App.user.friends = App.user.friends || [];
                    App.user.friends.push(r.from);
                    App.db.ref(`requests/${App.user.nick}/${r.from}`).remove();
                    App.save();
                    alert("–¢–µ–ø–µ—Ä—å –≤—ã –¥—Ä—É–∑—å—è!");
                    this.scene.restart();
                });
                offset += 40;
            });
        });

        // –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π
        this.add.text(cx, 400, "–î–†–£–ó–¨–Ø (–õ–ò–ß–ö–ê):", {fontSize: '15px'}).setOrigin(0.5);
        if (App.user.friends) {
            App.user.friends.forEach((f, i) => {
                let fBtn = this.add.text(cx, 440 + i*40, `–ù–∞–ø–∏—Å–∞—Ç—å ${f}`, {fill: '#00ff00'}).setOrigin(0.5).setInteractive();
                fBtn.on('pointerdown', () => {
                    let m = prompt(`–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è ${f}:`);
                    if (m) Social.sendPrivate(f, m);
                });
            });
        }

        let back = this.add.text(cx, 600, "–í–ï–†–ù–£–¢–¨–°–Ø", {fill: '#ffb6c1'}).setOrigin(0.5).setInteractive();
        back.on('pointerdown', () => this.scene.start('MenuScene'));
    }
    btn(x, y, t, cb) {
        let b = this.add.rectangle(x, y, 220, 45, 0xffffff, 0.1).setInteractive().setStrokeStyle(1, 0xffb6c1);
        this.add.text(x, y, t).setOrigin(0.5);
        b.on('pointerdown', cb);
    }
}

/**
 * –û–ë–ù–û–í–õ–ï–ù–ù–´–ô GAME LOOP –° –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†–û–ú
 */
const v9GameCreate = GameScene.prototype.create;
GameScene.prototype.create = function() {
    v9GameCreate.call(this);
    this.multiplayer = new MultiplayerHandler(this);
    this.multiplayer.sync();
};

const v9GameUpdate = GameScene.prototype.update;
GameScene.prototype.update = function(time) {
    v9GameUpdate.call(this, time);
    if (this.snake.length > 0 && time % 500 < 20) {
        this.multiplayer.updateMyPos(this.snake[0]);
    }
};

/**
 * –î–û–ë–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–ò –í –ú–ï–ù–Æ
 */
const v9MenuCreate = MenuScene.prototype.create;
MenuScene.prototype.create = function() {
    v9MenuCreate.call(this);
    this.btn(180, 500, "–î–†–£–ó–¨–Ø –ò –ß–ê–¢", () => this.scene.start('SocialScene'));
};

// –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –±–∞–≥ —Å –ø–æ–¥–≥—Ä—É–∑–∫–æ–π –¥—Ä—É–∑–µ–π –≤ TopScene
const v9TopCreate = TopScene.prototype.create;
TopScene.prototype.create = function() {
    v9TopCreate.call(this);
    // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–∏–Ω—É—Ç—å –∑–∞—è–≤–∫—É –ø—Ä—è–º–æ –∏–∑ —Ç–æ–ø–∞
    setTimeout(() => {
        this.add.text(180, 540, "–ù–∞–∂–º–∏ –Ω–∞ –∏–º—è, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è", {fontSize: '10px', fill: '#888'}).setOrigin(0.5);
    }, 1000);
};
    /**
 * ============================================================================
 * CLAN SYSTEM CORE (–Ø–î–†–û –ö–õ–ê–ù–û–í)
 * –î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–Ω–æ–≤, –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ 75 –µ–¥—ã.
 * ============================================================================
 */

class ClanSystem {
    constructor() {
        this.minTotalFood = 75; // –£—Å–ª–æ–≤–∏–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å—ä–µ–ª –ª–∏ –∏–≥—Ä–æ–∫ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –µ–¥—ã –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è
    isUnlocked() {
        return (App.user.total || 0) >= this.minTotalFood;
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∞–Ω–∞
    async create(clanName) {
        if (!this.isUnlocked()) return alert(`–ù—É–∂–Ω–æ —Å—ä–µ—Å—Ç—å –µ—â–µ ${this.minTotalFood - App.user.total} –µ–¥—ã!`);
        if (clanName.length < 2 || clanName.length > 5) return alert("–¢–µ–≥ –∫–ª–∞–Ω–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 2 –¥–æ 5 —Å–∏–º–≤–æ–ª–æ–≤!");

        const snap = await App.db.ref('clans/' + clanName).get();
        if (snap.exists()) return alert("–¢–∞–∫–æ–π –∫–ª–∞–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");

        const clanData = {
            leader: App.user.nick,
            members: [App.user.nick],
            points: 0,
            level: 1,
            createdAt: Date.now()
        };

        await App.db.ref('clans/' + clanName).set(clanData);
        App.user.clan = clanName;
        App.save();
        alert(`–ö–ª–∞–Ω [${clanName}] —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`);
    }

    // –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –∫–ª–∞–Ω
    async join(clanName) {
        if (!this.isUnlocked()) return alert("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–±–µ–π 75 –æ—á–∫–æ–≤ –æ–±—â–µ–≥–æ —Å—á–µ—Ç–∞!");
        
        const snap = await App.db.ref('clans/' + clanName).get();
        if (!snap.exists()) return alert("–ö–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!");

        let members = snap.val().members || [];
        if (members.length >= 10) return alert("–ö–ª–∞–Ω –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω (–º–∞–∫—Å. 10 —á–µ–ª)!");

        if (!members.includes(App.user.nick)) {
            members.push(App.user.nick);
            await App.db.ref(`clans/${clanName}/members`).set(members);
            App.user.clan = clanName;
            App.save();
            alert(`–í—ã –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –∫–ª–∞–Ω [${clanName}]!`);
        }
    }
}

const Clanes = new ClanSystem();

/**
 * –ò–ù–¢–ï–†–§–ï–ô–° –ö–õ–ê–ù–û–í (–í—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –≤ –º–µ–Ω—é)
 */
const v10SocialCreate = SocialScene.prototype.create;
SocialScene.prototype.create = function() {
    v10SocialCreate.call(this);
    const cx = 180;

    // –ï—Å–ª–∏ —É—Å–ª–æ–≤–∏–µ 75 –µ–¥—ã –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
    if (!Clanes.isUnlocked()) {
        this.add.text(cx, 300, "–ö–õ–ê–ù–´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–´", {fill: '#ff0000', fontStyle: 'bold'}).setOrigin(0.5);
        this.add.text(cx, 330, `–°—ä–µ—à—å –µ—â–µ ${75 - App.user.total} –µ–¥—ã, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å`, {fontSize: '12px'}).setOrigin(0.5);
        return;
    }

    // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –µ—â–µ –Ω–µ –≤ –∫–ª–∞–Ω–µ
    if (!App.user.clan) {
        this.add.text(cx, 300, "–£ –¢–ï–ë–Ø –ù–ï–¢ –ö–õ–ê–ù–ê", {fill: '#ffd700'}).setOrigin(0.5);
        
        let createBtn = this.add.text(cx - 60, 350, "[ –°–û–ó–î–ê–¢–¨ ]", {backgroundColor: '#222', padding: 5}).setInteractive();
        createBtn.on('pointerdown', () => {
            let n = prompt("–í–≤–µ–¥–∏—Ç–µ –¢–ï–ì –∫–ª–∞–Ω–∞ (3-4 –±—É–∫–≤—ã):");
            if (n) Clanes.create(n.toUpperCase());
        });

        let joinBtn = this.add.text(cx + 60, 350, "[ –í–°–¢–£–ü–ò–¢–¨ ]", {backgroundColor: '#222', padding: 5}).setInteractive();
        joinBtn.on('pointerdown', () => {
            let n = prompt("–í–≤–µ–¥–∏—Ç–µ –¢–ï–ì –∫–ª–∞–Ω–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:");
            if (n) Clanes.join(n.toUpperCase());
        });
    } else {
        // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤ –∫–ª–∞–Ω–µ
        this.add.text(cx, 300, `–¢–í–û–ô –ö–õ–ê–ù: [${App.user.clan}]`, {fill: '#00ff00', fontSize: '20px'}).setOrigin(0.5);
        
        let leaveBtn = this.add.text(cx, 350, "–ü–û–ö–ò–ù–£–¢–¨ –ö–õ–ê–ù", {fontSize: '10px', fill: '#ff4444'}).setInteractive();
        leaveBtn.on('pointerdown', () => {
            if(confirm("–í—ã–π—Ç–∏ –∏–∑ –∫–ª–∞–Ω–∞?")) {
                App.user.clan = null;
                App.save();
                this.scene.restart();
            }
        });
    }
};

/**
 * –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–ï–ì–ê –ö–õ–ê–ù–ê –í –ò–ì–†–ï
 */
const v10GhostUpdate = MultiplayerHandler.prototype.updateGhost;
MultiplayerHandler.prototype.updateGhost = function(nick, data) {
    v10GhostUpdate.call(this, nick, data);
    if (this.ghosts[nick]) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥ –∫–ª–∞–Ω–∞ –ø–µ—Ä–µ–¥ –Ω–∏–∫–æ–º, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        let tag = data.clan ? `[${data.clan}] ` : "";
        this.ghosts[nick].list[1].setText(tag + nick); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∏–∫–∞ —É "—Ç–µ–Ω–∏" –∏–≥—Ä–æ–∫–∞
    }
};

// –ü—Ä–∏ —Å–º–µ—Ä—Ç–∏ –∏–ª–∏ –≤—ã—Ö–æ–¥–µ - –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—á–µ—Ç –≤ –±–∞–∑–µ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–ª–∞–Ω–∞
const v10GameOver = GameScene.prototype.gameOver;
GameScene.prototype.gameOver = function() {
    App.user.total = (App.user.total || 0) + this.score;
    App.save();
    v10GameOver.call(this);
};
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 11: ARTIFACTS, REPUTATION & WORLD EVENTS
 * –î–æ–±–∞–≤–ª—è–µ—Ç –≥–ª—É–±–∏–Ω—É –≥–µ–π–º–ø–ª–µ—è –∏ —Å–∏—Å—Ç–µ–º—É –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π.
 * ============================================================================
 */

// –ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –ø—Ä–æ—Ñ–∏–ª—å
App.user.reputation = App.user.reputation || 0;
App.user.artifactsCollected = App.user.artifactsCollected || 0;

/**
 * –ö–õ–ê–°–° –ê–†–¢–ï–§–ê–ö–¢–û–í (–°–õ–£–ß–ê–ô–ù–´–ï –ü–†–ï–î–ú–ï–¢–´)
 */
class ArtifactManager {
    constructor(scene) {
        this.scene = scene;
        this.types = [
            { id: 'clock', icon: '‚è≥', color: 0x00ffff, desc: '–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ' },
            { id: 'magnet', icon: 'üß≤', color: 0xff00ff, desc: '–ú–∞–≥–Ω–∏—Ç' },
            { id: 'shield', icon: 'üõ°Ô∏è', color: 0xffff00, desc: '–©–∏—Ç' }
        ];
        this.current = null;
        this.obj = null;
    }

    spawn() {
        if (this.obj) this.obj.destroy();
        const type = this.types[Math.floor(Math.random() * this.types.length)];
        const x = Math.floor(Phaser.Math.Between(2, 16));
        const y = Math.floor(Phaser.Math.Between(5, 25));
        
        this.current = type;
        this.obj = this.scene.add.text(x * 20, y * 20, type.icon, { fontSize: '22px' }).setOrigin(0.5);
        
        // –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –≤–æ–∫—Ä—É–≥ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
        this.scene.tweens.add({
            targets: this.obj,
            scale: 1.3,
            alpha: 0.7,
            duration: 800,
            yoyo: true,
            repeat: -1
        });
    }

    collect() {
        Sound.play(1000, 'sine', 0.2);
        this.scene.showLargeNotify("–ê–†–¢–ï–§–ê–ö–¢: " + this.current.desc);
        
        if (this.current.id === 'clock') {
            this.scene.speed += 40; // –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ
            setTimeout(() => this.scene.speed -= 40, 10000);
        } else if (this.current.id === 'shield') {
            this.scene.hasShield = true;
        }
        
        App.user.artifactsCollected++;
        this.obj.destroy();
        this.obj = null;
        this.current = null;
    }
}

/**
 * –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í GAME SCENE
 */
const v11GameCreate = GameScene.prototype.create;
GameScene.prototype.create = function() {
    v11GameCreate.call(this);
    this.artifacts = new ArtifactManager(this);
    this.hasShield = false;
    
    // –°–ø–∞–≤–Ω –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –∫–∞–∂–¥—ã–µ 45-60 —Å–µ–∫—É–Ω–¥
    this.time.addEvent({
        delay: 50000,
        callback: () => this.artifacts.spawn(),
        loop: true
    });
};

const v11GameUpdate = GameScene.prototype.update;
GameScene.prototype.update = function(time) {
    v11GameUpdate.call(this, time);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
    if (this.artifacts.current && this.snake.length > 0) {
        const head = this.snake[0];
        if (head.x === Math.floor(this.artifacts.obj.x/20) && head.y === Math.floor(this.artifacts.obj.y/20)) {
            this.artifacts.collect();
        }
    }
};

// –§–∏–∫—Å —Å–º–µ—Ä—Ç–∏ (–°–∏—Å—Ç–µ–º–∞ –©–∏—Ç–∞)
const v11GameOver = GameScene.prototype.gameOver;
GameScene.prototype.gameOver = function() {
    if (this.hasShield) {
        this.hasShield = false;
        this.showLargeNotify("–©–ò–¢ –†–ê–ó–ë–ò–¢!");
        Sound.play(300, 'sawtooth', 0.3);
        return; // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–≥—Ä—É
    }
    v11GameOver.call(this);
};

/**
 * –°–ò–°–¢–ï–ú–ê –†–ï–ü–£–¢–ê–¶–ò–ò (–û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ê–£–†–´)
 */
const v11RenderSnake = GameScene.prototype.renderSnake;
GameScene.prototype.renderSnake = function() {
    v11RenderSnake.call(this);
    
    if (this.snake.length > 0) {
        const head = this.snake[0];
        const graphics = this.graphics;
        
        // –°–∏–Ω—è—è –∞—É—Ä–∞ (–ì–µ—Ä–æ–π)
        if (App.user.reputation >= 100) {
            graphics.lineStyle(3, 0x0000ff, 0.5);
            graphics.strokeCircle(head.x * 20, head.y * 20, 18);
        } 
        // –ö—Ä–∞—Å–Ω–∞—è –∞—É—Ä–∞ (–ó–ª–æ–¥–µ–π)
        else if (App.user.reputation <= -100) {
            graphics.lineStyle(3, 0xff0000, 0.5);
            graphics.strokeCircle(head.x * 20, head.y * 20, 18);
        }
    }
};

/**
 * –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –ê–î–ú–ò–ù–ö–ê: –ü–†–û–í–ï–†–ö–ê –†–ï–ü–£–¢–ê–¶–ò–ò
 */
const v11AdminCreate = AdminScene.prototype.create;
AdminScene.prototype.create = function() {
    v11AdminCreate.call(this);
    const cx = 180;
    
    this.add.text(cx, 440, "–†–ï–ü–£–¢–ê–¶–ò–Ø –ò–ì–†–û–ö–û–í", { fontSize: '14px', fill: '#00ff00' }).setOrigin(0.5);
    
    // –ö–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è Bendi)
    this.btn(cx, 400, "–ò–ó–ú–ï–ù–ò–¢–¨ –†–ï–ü", () => {
        let nick = prompt("–ù–∏–∫ –∏–≥—Ä–æ–∫–∞:");
        let val = prompt("–ó–Ω–∞—á–µ–Ω–∏–µ (+/-):");
        if(nick && val) {
            App.db.ref(`users/${nick}/reputation`).transaction(curr => (curr || 0) + parseInt(val));
            alert("–†–µ–ø—É—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞.");
        }
    });
};

/**
 * –ú–ò–†–û–í–û–ï –°–û–ë–´–¢–ò–ï: –ó–û–õ–û–¢–ê–Ø –õ–ò–•–û–†–ê–î–ö–ê
 */
GameScene.prototype.startGoldRush = function() {
    this.showLargeNotify("–ó–û–õ–û–¢–ê–Ø –õ–ò–•–û–†–ê–î–ö–ê: x5 –ú–û–ù–ï–¢!");
    this.cameras.main.flash(1000, 255, 215, 0);
    const oldFood = App.user.food;
    App.user.food = 'üí∞';
    setTimeout(() => {
        App.user.food = oldFood;
        this.showLargeNotify("–°–û–ë–´–¢–ò–ï –ó–ê–í–ï–†–®–ï–ù–û");
    }, 30000);
};

// –ó–∞–ø—É—Å–∫ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è —Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç
setInterval(() => {
    const scene = game.scene.getScene('GameScene');
    if (scene && scene.scene.isActive()) {
        scene.startGoldRush();
    }
}, 300000);

console.log("%c [WORLD]: –°–∏—Å—Ç–µ–º–∞ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –∏ –°–æ–±—ã—Ç–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–∞.", "color: #00ffff; font-weight: bold;");
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 12: QUEST ENGINE & GIFTING SYSTEM (–°–ò–°–¢–ï–ú–ê –ó–ê–î–ê–ù–ò–ô)
 * –ü–æ–∑–≤–æ–ª—è–µ—Ç Bendi —É–ø—Ä–∞–≤–ª—è—Ç—å –º–∏—Ä–æ–º –∏ –Ω–∞–≥—Ä–∞–∂–¥–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤.
 * ============================================================================
 */

class QuestManager {
    constructor() {
        this.currentQuest = null;
        this.dbRef = App.db.ref('active_quest');
    }

    // –ó–∞–ø—É—Å–∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∫–≤–µ—Å—Ç–∞ (–¢–æ–ª—å–∫–æ –¥–ª—è Bendi)
    startGlobal(goalText, targetValue, reward) {
        if (!App.user.isAdmin) return;
        const quest = {
            text: goalText,
            target: targetValue,
            reward: reward,
            startTime: Date.now(),
            active: true
        };
        this.dbRef.set(quest);
        alert("–ì–ª–æ–±–∞–ª—å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!");
    }

    stop() {
        this.dbRef.remove();
        alert("–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.");
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —É –∏–≥—Ä–æ–∫–∞
    async checkProgress(currentScore, scene) {
        const snap = await this.dbRef.get();
        if (snap.exists()) {
            const q = snap.val();
            if (currentScore >= q.target) {
                // –ï—Å–ª–∏ –∑–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
                App.user.coins += q.reward;
                App.save();
                scene.showLargeNotify(`–ö–í–ï–°–¢ –í–´–ü–û–õ–ù–ï–ù! +${q.reward} üí∞`);
                Sound.play(1200, 'sine', 0.5);
                return true;
            }
        }
        return false;
    }
}

const Quests = new QuestManager();

/**
 * –°–ò–°–¢–ï–ú–ê –ü–û–î–ê–†–ö–û–í (GIFTING)
 */
class GiftingSystem {
    static async sendGift(targetNick, type, value) {
        if (!App.user.isAdmin) return;
        const ref = App.db.ref(`users/${targetNick}`);
        const snap = await ref.get();
        
        if (snap.exists()) {
            if (type === 'coins') {
                await ref.child('coins').transaction(c => (c || 0) + parseInt(value));
            } else if (type === 'skin') {
                let inv = snap.val().inv || [];
                inv.push(value);
                await ref.child('inv').set(inv);
            }
            alert(`–ü–æ–¥–∞—Ä–æ–∫ (${type}) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–≥—Ä–æ–∫—É ${targetNick}!`);
        }
    }
}

/**
 * –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –ö–í–ï–°–¢–û–í –í –ò–ì–†–ï
 */
const v12GameCreate = GameScene.prototype.create;
GameScene.prototype.create = function() {
    v12GameCreate.call(this);
    this.questUI = this.add.text(180, 80, "", { 
        fontSize: '14px', fill: '#ffff00', align: 'center', fontStyle: 'bold',
        backgroundColor: '#000000aa', padding: 5
    }).setOrigin(0.5).setAlpha(0);

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–æ–≤
    App.db.ref('active_quest').on('value', snap => {
        if (snap.exists()) {
            const q = snap.val();
            this.questUI.setText(`–ö–í–ï–°–¢: ${q.text}\n–¶–ï–õ–¨: ${q.target} | –ù–ê–ì–†–ê–î–ê: ${q.reward}üí∞`).setAlpha(1);
        } else {
            this.questUI.setAlpha(0);
        }
    });
};

const v12OnEat = GameScene.prototype.onEat;
GameScene.prototype.onEat = function() {
    v12OnEat.call(this);
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –µ–¥–µ
    Quests.checkProgress(this.score, this);
};

/**
 * –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ì–ï–ô–ú-–ú–ê–°–¢–ï–†–ê (–í –ê–î–ú–ò–ù–ö–ï)
 */
const v12AdminCreate = AdminScene.prototype.create;
AdminScene.prototype.create = function() {
    v12AdminCreate.call(this);
    const cx = 180;

    this.add.text(cx, 680, "--- –ü–ê–ù–ï–õ–¨ –ì–ï–ô–ú-–ú–ê–°–¢–ï–†–ê ---", {fill: '#00ffff'}).setOrigin(0.5);

    // –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–≤–µ—Å—Ç–∞
    this.btn(cx, 720, "–°–û–ó–î–ê–¢–¨ –ö–í–ï–°–¢", () => {
        let text = prompt("–°—É—Ç—å –∑–∞–¥–∞–Ω–∏—è (–Ω–∞–ø—Ä. –°–æ–±—Ä–∞—Ç—å —è–±–ª–æ–∫):");
        let target = prompt("–°–∫–æ–ª—å–∫–æ —à—Ç—É–∫ –Ω—É–∂–Ω–æ?:");
        let reward = prompt("–ù–∞–≥—Ä–∞–¥–∞ (–º–æ–Ω–µ—Ç—ã):");
        if (text && target && reward) Quests.startGlobal(text, parseInt(target), parseInt(reward));
    });

    this.btn(cx, 770, "–°–¢–û–ü –ö–í–ï–°–¢", () => Quests.stop());

    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥–∞—Ä–∫–∞
    this.btn(cx, 820, "–û–¢–ü–†–ê–í–ò–¢–¨ –ü–û–î–ê–†–û–ö", () => {
        let nick = prompt("–ö–æ–º—É (–ù–∏–∫):");
        let val = prompt("–ß—Ç–æ (coins / skin_id):");
        let amt = prompt("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–µ—Å–ª–∏ –º–æ–Ω–µ—Ç—ã):");
        if (nick && val) GiftingSystem.sendGift(nick, amt ? 'coins' : 'skin', amt || val);
    });
};

// –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –≤ –∞–¥–º–∏–Ω–∫–µ (—Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ —Å—Ç–∞–ª–∞ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–æ–π)
AdminScene.prototype.update = function() {
    if (this.input.keyboard.addKey('UP').isDown) this.cameras.main.scrollY -= 5;
    if (this.input.keyboard.addKey('DOWN').isDown) this.cameras.main.scrollY += 5;
};

console.log("%c [GM-SYSTEM]: –ú–æ–¥—É–ª—å –∫–≤–µ—Å—Ç–æ–≤ –∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.", "color: #00ffff; font-weight: bold;");
   /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 13: RPG CORE (–ò–ù–í–ï–ù–¢–ê–†–¨, –ü–†–û–ö–ê–ß–ö–ê, –°–ú–ï–ù–ê –î–ù–Ø –ò –ù–û–ß–ò)
 * ============================================================================
 */

// –†–∞—Å—à–∏—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
App.user.inventory = App.user.inventory || [];
App.user.petLevel = App.user.petLevel || 1;
App.user.petExp = App.user.petExp || 0;
App.user.achievements = App.user.achievements || [];

/**
 * 1. –°–ò–°–¢–ï–ú–ê –ò–ù–í–ï–ù–¢–ê–†–Ø (INVENTORY)
 */
class InventorySystem {
    static addItem(itemId) {
        if (App.user.inventory.length >= 5) return alert("–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø–æ–ª–æ–Ω!");
        App.user.inventory.push(itemId);
        App.save();
    }

    static useItem(index, scene) {
        const item = App.user.inventory[index];
        if (!item) return;

        if (item === 'clock') scene.speed += 50;
        if (item === 'shield') scene.hasShield = true;
        
        App.user.inventory.splice(index, 1);
        App.save();
        Sound.play(1500, 'sine', 0.2);
    }
}

/**
 * 2. –ü–ò–¢–û–ú–¶–´ 2.0 (–ü–†–û–ö–ê–ß–ö–ê)
 */
class PetAdvanced {
    static addExp(amt, scene) {
        App.user.petExp += amt;
        if (App.user.petExp >= App.user.petLevel * 50) {
            App.user.petLevel++;
            App.user.petExp = 0;
            scene.showLargeNotify(`–ü–ï–¢ –ü–û–í–´–°–ò–õ –£–†–û–í–ï–ù–¨: ${App.user.petLevel}!`);
            Sound.play(2000, 'triangle', 0.5);
        }
        App.save();
    }
}

/**
 * 3. –¶–ò–ö–õ –î–ù–Ø –ò –ù–û–ß–ò (DAY/NIGHT)
 */
class DayNightSystem {
    constructor(scene) {
        this.scene = scene;
        this.isNight = false;
        this.overlay = scene.add.rectangle(180, 300, 340, 500, 0x000033, 0);
        this.lightMask = scene.add.graphics();
    }

    update(time, headX, headY) {
        // –°–º–µ–Ω–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∞ (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å)
        const cycle = Math.floor(time / 60000) % 2;
        this.isNight = cycle === 1;

        if (this.isNight) {
            this.overlay.setAlpha(0.7);
            this.renderLight(headX, headY);
        } else {
            this.overlay.setAlpha(0);
            this.lightMask.clear();
        }
    }

    renderLight(x, y) {
        this.lightMask.clear();
        this.lightMask.fillStyle(0xffffff, 0.2);
        this.lightMask.fillCircle(x * 20, y * 20, 80); // –†–∞–¥–∏—É—Å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –Ω–æ—á—å—é
    }
}

/**
 * 4. –°–õ–û–ñ–ù–´–ô –ë–û–°–° (HP & ATTACKS)
 */
class MegaBoss extends ShadowBoss {
    constructor(scene) {
        super(scene);
        this.hp = 5;
    }

    takeDamage() {
        this.hp--;
        this.scene.cameras.main.shake(200, 0.01);
        if (this.hp <= 0) {
            this.active = false;
            this.scene.showLargeNotify("–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù! +500üí∞");
            App.user.coins += 500;
            App.save();
        }
    }
}

/**
 * –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° –ò–ì–†–´ (HUD)
 */
const v13GameCreate = GameScene.prototype.create;
GameScene.prototype.create = function() {
    v13GameCreate.call(this);
    this.dayNight = new DayNightSystem(this);
    
    // –ö–Ω–æ–ø–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    this.invButtons = [];
    for(let i=0; i<5; i++) {
        let btn = this.add.rectangle(50 + i*40, 580, 30, 30, 0xffffff, 0.1).setInteractive().setStrokeStyle(1, 0x888);
        let txt = this.add.text(50 + i*40, 580, "", {fontSize: '10px'}).setOrigin(0.5);
        btn.on('pointerdown', () => InventorySystem.useItem(i, this));
        this.invButtons.push({b: btn, t: txt});
    }
};

const v13GameUpdate = GameScene.prototype.update;
GameScene.prototype.update = function(time) {
    v13GameUpdate.call(this, time);
    
    const head = this.snake[0];
    if (head) {
        this.dayNight.update(time, head.x, head.y);
        
        // –ú–∞–≥–Ω–∏—Ç –ø–µ—Ç–∞ (—É—Ä–æ–≤–µ–Ω—å 10+)
        if (App.user.petLevel >= 10 && this.food) {
            let dist = Phaser.Math.Distance.Between(head.x, head.y, this.food.x, this.food.y);
            if (dist < 3) this.onEat(); // –ê–≤—Ç–æ-–ø–æ–µ–¥–∞–Ω–∏–µ
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–æ–∫ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    App.user.inventory.forEach((item, i) => {
        if (this.invButtons[i]) this.invButtons[i].t.setText(item === 'clock' ? '‚è≥' : 'üõ°Ô∏è');
    });
    for(let i = App.user.inventory.length; i < 5; i++) {
        this.invButtons[i].t.setText("");
    }
};

const v13OnEat = GameScene.prototype.onEat;
GameScene.prototype.onEat = function() {
    v13OnEat.call(this);
    PetAdvanced.addExp(10, this); // –î–∞–µ–º –æ–ø—ã—Ç –ø–µ—Ç—É –∑–∞ –∫–∞–∂–¥–æ–µ —è–±–ª–æ–∫–æ
};

// –ó–∞–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Å–±–æ—Ä–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –Ω–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
ArtifactManager.prototype.collect = function() {
    Sound.play(1000, 'sine', 0.2);
    InventorySystem.addItem(this.current.id);
    this.scene.showLargeNotify("–ü–û–õ–û–ñ–ï–ù–û –í –ò–ù–í–ï–ù–¢–ê–†–¨!");
    this.obj.destroy();
    this.obj = null;
    this.current = null;
};
  /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 14: CREATIVE ENGINE, SKILLS & SOCIAL WARFARE
 * –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∏–≥—Ä—É –≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
 * ============================================================================
 */

App.user.selectedSkill = App.user.selectedSkill || 'dash';
App.user.publishedMaps = App.user.publishedMaps || [];

/**
 * 1. –°–ò–°–¢–ï–ú–ê –°–ü–û–°–û–ë–ù–û–°–¢–ï–ô (SKILLS)
 */
class SkillEngine {
    constructor(scene) {
        this.scene = scene;
        this.cooldown = false;
    }

    activate() {
        if (this.cooldown) return;
        const skill = App.user.selectedSkill;
        
        if (skill === 'dash') {
            // –†—ã–≤–æ–∫: –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –Ω–∞ 3 –∫–ª–µ—Ç–∫–∏ –≤–ø–µ—Ä–µ–¥
            for(let i=0; i<3; i++) this.scene.moveSnake();
            this.scene.showLargeNotify("–†–´–í–û–ö!");
        } else if (skill === 'freeze') {
            // –ó–∞–º–æ—Ä–æ–∑–∫–∞: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã
            this.scene.speed += 200;
            setTimeout(() => this.scene.speed -= 200, 3000);
            this.scene.showLargeNotify("–ó–ê–ú–û–†–û–ó–ö–ê!");
        }

        this.cooldown = true;
        setTimeout(() => this.cooldown = false, 10000); // –ö—É–ª–¥–∞—É–Ω 10 —Å–µ–∫
    }
}

/**
 * 2. –ú–ê–°–¢–ï–†–°–ö–ê–Ø –ö–ê–†–¢ (MAP MAKER PRO)
 */
class MapMaker {
    constructor() {
        this.currentDraft = [];
    }

    saveAndPublish(mapName) {
        if (this.currentDraft.length < 5) return alert("–ö–∞—Ä—Ç–∞ —Å–ª–∏—à–∫–æ–º –ø—É—Å—Ç–∞—è!");
        const mapData = {
            creator: App.user.nick,
            name: mapName,
            blocks: this.currentDraft,
            likes: 0,
            timestamp: Date.now()
        };
        App.db.ref('community_maps').push(mapData);
        alert("–ö–∞—Ä—Ç–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ –≤ –ú–∞—Å—Ç–µ—Ä—Å–∫–æ–π!");
    }

    static async getMapOfDay() {
        const snap = await App.db.ref('community_maps').orderByChild('likes').limitToLast(1).get();
        return snap.val();
    }
}

const Workshop = new MapMaker();

/**
 * 3. –ì–û–õ–û–°–û–í–û–ô –ß–ê–¢ (–ü–†–ï–°–ï–¢–´ –ò –°–ò–ì–ù–ê–õ–´)
 */
class RadioChat {
    static send(type) {
        const messages = {
            help: "–ù–£–ñ–ù–ê –ü–û–ú–û–©–¨! üö©",
            go: "–í–ï–†–ï–î! üöÄ",
            gg: "–•–û–†–û–®–ê–Ø –ò–ì–†–ê! ü§ù"
        };
        App.db.ref('live_radio').set({
            nick: App.user.nick,
            msg: messages[type],
            time: Date.now()
        });
    }
}

/**
 * 4. –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í –ò–ù–¢–ï–†–§–ï–ô–°
 */
const v14GameCreate = GameScene.prototype.create;
GameScene.prototype.create = function() {
    v11GameCreate.call(this); // –í—ã–∑–æ–≤ –±–∞–∑—ã –∏–∑ 11 —á–∞—Å—Ç–∏
    this.skills = new SkillEngine(this);
    
    // –ö–Ω–æ–ø–∫–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (–ü—Ä–æ–±–µ–ª –∏–ª–∏ –ö–Ω–æ–ø–∫–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ)
    this.skillBtn = this.add.circle(320, 520, 25, 0xffa500, 0.5).setInteractive();
    this.add.text(320, 520, "SKILL", {fontSize: '10px'}).setOrigin(0.5);
    this.skillBtn.on('pointerdown', () => this.skills.activate());
    this.input.keyboard.on('keydown-SPACE', () => this.skills.activate());

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –†–∞–¥–∏–æ-—á–∞—Ç–∞
    this.radioText = this.add.text(180, 110, "", {backgroundColor: '#000', padding: 5}).setOrigin(0.5).setAlpha(0);
    App.db.ref('live_radio').on('value', snap => {
        if (snap.exists()) {
            const d = snap.val();
            this.radioText.setText(`${d.nick}: ${d.msg}`).setAlpha(1);
            setTimeout(() => this.radioText.setAlpha(0), 3000);
        }
    });
};

/**
 * 5. –°–¶–ï–ù–ê –ú–ê–°–¢–ï–†–°–ö–û–ô (WORKSHOP SCENE)
 */
class WorkshopScene extends Phaser.Scene {
    constructor() { super('WorkshopScene'); }
    create() {
        const cx = 180;
        this.add.text(cx, 50, "–ú–ê–°–¢–ï–†–°–ö–ê–Ø –ö–ê–†–¢", {fontSize: '22px', fill: '#00ffff'}).setOrigin(0.5);
        
        this.add.text(cx, 100, "1. –ù–∞—Ä–∏—Å—É–π –∫–∞—Ä—Ç—É –≤ –†–µ–¥–∞–∫—Ç–æ—Ä–µ\n2. –ù–∞–∂–º–∏ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å\n3. –°–æ–±–∏—Ä–∞–π –ª–∞–π–∫–∏!", {align: 'center', fontSize: '12px'}).setOrigin(0.5);

        let pubBtn = this.add.rectangle(cx, 200, 200, 40, 0x00ff00, 0.2).setInteractive().setStrokeStyle(1, 0x00ff00);
        this.add.text(cx, 200, "–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –ú–û–Æ –ö–ê–†–¢–£").setOrigin(0.5);
        
        pubBtn.on('pointerdown', () => {
            let name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–≤–æ–µ–π –∫–∞—Ä—Ç—ã:");
            if (name) {
                // –ë–µ—Ä–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –∏–∑ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
                const game = this.scene.get('GameScene');
                Workshop.currentDraft = game.obstacles || [];
                Workshop.saveAndPublish(name);
            }
        });

        // –°–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∫–∞—Ä—Ç
        this.add.text(cx, 280, "–¢–û–ü –ö–ê–†–¢ (–õ–ê–ô–ö–ù–ò –î–õ–Ø –†–ï–ñ–ò–ú–ê –î–ù–Ø):", {fontSize: '14px'}).setOrigin(0.5);
        App.db.ref('community_maps').limitToLast(5).on('value', snap => {
            let offset = 0;
            snap.forEach(child => {
                const map = child.val();
                let mBtn = this.add.text(cx, 320 + offset, `‚ù§Ô∏è ${map.likes} | ${map.name} (by ${map.creator})`, {backgroundColor: '#222', padding: 5})
                    .setOrigin(0.5).setInteractive();
                
                mBtn.on('pointerdown', () => {
                    child.ref.child('likes').transaction(l => (l || 0) + 1);
                    alert("–õ–∞–π–∫ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω!");
                });
                offset += 40;
            });
        });

        let back = this.add.text(cx, 600, "–í–ï–†–ù–£–¢–¨–°–Ø", {fill: '#ffb6c1'}).setOrigin(0.5).setInteractive();
        back.on('pointerdown', () => this.scene.start('MenuScene'));
    }
}

/**
 * –ö–õ–ê–ù–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò (CLAN SETTINGS)
 */
ClanScene.prototype.showSettings = function() {
    // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã –ª–∏–¥–µ—Ä –∫–ª–∞–Ω–∞
    const cx = 180;
    this.add.text(cx, 400, "–ù–ê–°–¢–†–û–ô–ö–ò –ö–õ–ê–ù–ê (–õ–ò–î–ï–†)", {fill: '#ff00ff'}).setOrigin(0.5);
    
    let colorBtn = this.add.text(cx, 440, "–°–ú–ï–ù–ò–¢–¨ –¶–í–ï–¢ –¢–ï–ì–ê", {backgroundColor: '#333'}).setOrigin(0.5).setInteractive();
    colorBtn.on('pointerdown', () => {
        let c = prompt("–í–≤–µ–¥–∏—Ç–µ HEX —Ü–≤–µ—Ç (–Ω–∞–ø—Ä. #ff0000):");
        if (c) App.db.ref(`clans/${App.user.clan}/color`).set(c);
    });
};
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 15: TRADE SYSTEM & WORLD LEADERBOARD
 * –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞–¥–∏—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
 * ============================================================================
 */

/**
 * 1. –°–ò–°–¢–ï–ú–ê –û–ë–ú–ï–ù–ê (TRADE SYSTEM)
 */
class TradeManager {
    constructor() {
        this.currentTrade = null;
    }

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞
    async sendTradeRequest(targetNick, offerType, offerValue) {
        if(targetNick === App.user.nick) return;
        const request = {
            from: App.user.nick,
            type: offerType, // 'coins' –∏–ª–∏ 'item'
            val: offerValue,
            status: 'pending'
        };
        await App.db.ref(`trades/${targetNick}`).set(request);
        alert("–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!");
    }

    // –ü—Ä–∏–Ω—è—Ç—å –æ–±–º–µ–Ω
    async acceptTrade(tradeData) {
        const senderRef = App.db.ref(`users/${tradeData.from}`);
        const receiverRef = App.db.ref(`users/${App.user.nick}`);

        if (tradeData.type === 'coins') {
            await senderRef.child('coins').transaction(c => (c || 0) - parseInt(tradeData.val));
            await receiverRef.child('coins').transaction(c => (c || 0) + parseInt(tradeData.val));
            App.user.coins += parseInt(tradeData.val);
        }
        
        await App.db.ref(`trades/${App.user.nick}`).remove();
        alert("–û–±–º–µ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!");
    }
}

const Trade = new TradeManager();

/**
 * 2. –ú–ò–†–û–í–û–ô –†–ï–ô–¢–ò–ù–ì –ö–õ–ê–ù–û–í
 */
class ClanLeaderboard {
    static async showTop(scene) {
        const snap = await App.db.ref('clans').orderByChild('points').limitToLast(5).get();
        const clans = [];
        snap.forEach(child => {
            clans.push({ name: child.key, points: child.val().points || 0 });
        });
        return clans.reverse();
    }
}

/**
 * 3. –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ 2.0 (DASHBOARD)
 */
const v15AdminCreate = AdminScene.prototype.create;
AdminScene.prototype.create = function() {
    v15AdminCreate.call(this);
    const cx = 180;
    this.add.text(cx, 870, "--- –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ú–ò–†–ê ---", {fill: '#ff00ff'}).setOrigin(0.5);

    // –í—ã–≤–æ–¥ –æ–±—â–µ–π —Å—É–º–º—ã –º–æ–Ω–µ—Ç –≤ –∏–≥—Ä–µ
    App.db.ref('users').on('value', snap => {
        let totalCoins = 0;
        let userCount = 0;
        snap.forEach(u => {
            totalCoins += (u.val().coins || 0);
            userCount++;
        });
        this.add.text(cx, 910, `–ò–≥—Ä–æ–∫–æ–≤: ${userCount} | –ú–æ–Ω–µ—Ç –≤ –º–∏—Ä–µ: ${totalCoins}`, {fontSize: '10px'}).setOrigin(0.5);
    });

    // –ö–Ω–æ–ø–∫–∞ –ì–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ù–∞–ª–æ–≥–∞ (Bendi power)
    let taxBtn = this.add.text(cx, 950, "[ –°–û–ë–†–ê–¢–¨ –ù–ê–õ–û–ì 1% ]", {backgroundColor: '#440000', padding: 5})
        .setOrigin(0.5).setInteractive();
    
    taxBtn.on('pointerdown', () => {
        if(confirm("–ó–∞–±—Ä–∞—Ç—å 1% –º–æ–Ω–µ—Ç —É –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –≤ —Å–≤–æ—é –ø–æ–ª—å–∑—É?")) {
            App.db.ref('users').once('value', snap => {
                snap.forEach(userSnap => {
                    let c = userSnap.val().coins || 0;
                    let tax = Math.floor(c * 0.01);
                    userSnap.ref.child('coins').set(c - tax);
                });
            });
            alert("–ù–∞–ª–æ–≥ —Å–æ–±—Ä–∞–Ω, –≥–æ—Å–ø–æ–∂–∞!");
        }
    });
};

/**
 * 4. –ò–ù–¢–ï–†–§–ï–ô–° –¢–†–ï–ô–î–û–í –í –°–û–¶–ò–ê–õ–ö–ï
 */
const v15SocialCreate = SocialScene.prototype.create;
SocialScene.prototype.create = function() {
    v15SocialCreate.call(this);
    const cx = 180;

    // –û–∫–Ω–æ –≤—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–µ–π–¥–æ–≤
    App.db.ref(`trades/${App.user.nick}`).on('value', snap => {
        if(snap.exists()) {
            const t = snap.val();
            let box = this.add.rectangle(cx, 150, 250, 80, 0x333300).setStrokeStyle(2, 0xffff00);
            let txt = this.add.text(cx, 150, `${t.from} –¥–∞–µ—Ç –≤–∞–º ${t.val} ${t.type === 'coins' ? '–º–æ–Ω–µ—Ç' : '–ø—Ä–µ–¥–º–µ—Ç'}`, 
                {fontSize: '10px', align: 'center'}).setOrigin(0.5);
            
            let acc = this.add.text(cx - 50, 180, "[–ü–†–ò–ù–Ø–¢–¨]", {fill: '#0f0'}).setInteractive();
            acc.on('pointerdown', () => Trade.acceptTrade(t));

            let dec = this.add.text(cx + 50, 180, "[–û–¢–ö–õ–û–ù–ò–¢–¨]", {fill: '#f00'}).setInteractive();
            dec.on('pointerdown', () => snap.ref.remove());
        }
    });

    // –ö–Ω–æ–ø–∫–∞ –¢—Ä–µ–π–¥–∞
    this.btn(cx, 500, "–û–¢–ü–†–ê–í–ò–¢–¨ –ú–û–ù–ï–¢–´", () => {
        let nick = prompt("–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã?:");
        let amt = prompt("–°–∫–æ–ª—å–∫–æ?:");
        if(nick && amt) Trade.sendTradeRequest(nick, 'coins', amt);
    });
};

/**
 * 5. –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–û–õ–ò–†–û–í–ö–ê (SCROLL FIX)
 */
// –î–µ–ª–∞–µ–º –∞–¥–º–∏–Ω–∫—É –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–æ–π, —Ç–∞–∫ –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏–π —Å—Ç–∞–ª–æ –û–ß–ï–ù–¨ –º–Ω–æ–≥–æ
AdminScene.prototype.update = function() {
    const cursors = this.input.keyboard.createCursorKeys();
    if (cursors.up.isDown) this.cameras.main.scrollY -= 8;
    if (cursors.down.isDown) this.cameras.main.scrollY += 8;
};

console.log("%c [SYSTEM]: –ü—Ä–æ–µ–∫—Ç Bendi-Snake v15.0 –£–°–ü–ï–®–ù–û –ó–ê–ì–†–£–ñ–ï–ù.", "color: #00ff00; font-weight: bold;");
console.log("%c –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –≤ –ª–æ–≥–∏–∫–µ: ~2500. –°—Ç–∞—Ç—É—Å: –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ.", "color: #00ff00;");
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 16: CORE ENGINE OVERHAUL & PARTICLE SYSTEM
 * –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∏ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
 * ============================================================================
 */

/**
 * 1. –°–ò–°–¢–ï–ú–ê –ß–ê–°–¢–ò–¶ (VFX ENGINE)
 */
class EffectEmitter {
    constructor(scene) {
        this.scene = scene;
        this.particles = scene.add.particles(0, 0, 'flare', {
            lifespan: 600,
            speed: { min: 50, max: 150 },
            scale: { start: 0.4, end: 0 },
            blendMode: 'ADD',
            emitting: false
        });
    }

    // –í–∑—Ä—ã–≤ —á–∞—Å—Ç–∏—Ü –ø—Ä–∏ –ø–æ–µ–¥–∞–Ω–∏–∏ –∏–ª–∏ —Å–æ–±—ã—Ç–∏–∏
    burst(x, y, color = 0xffffff, count = 20) {
        this.particles.setParticleTintColor(color);
        this.particles.emitParticleAt(x, y, count);
    }

    // –°–ª–µ–¥ –∑–∞ —Ö–≤–æ—Å—Ç–æ–º –ø—Ä–∏ —Ä—ã–≤–∫–µ
    createTrail(x, y, color) {
        this.particles.setParticleTintColor(color);
        this.particles.emitParticleAt(x, y, 1);
    }
}

/**
 * 2. –ú–ê–®–ò–ù–ê –°–û–°–¢–û–Ø–ù–ò–ô –ó–ú–ï–ò (SNAKE STATE MACHINE)
 */
class SnakeStateMachine {
    constructor(snake) {
        this.snake = snake;
        this.currentState = 'NORMAL'; // NORMAL, DASH, GHOST, FROZEN
        this.timers = {};
    }

    setState(state, duration = 0) {
        this.currentState = state;
        console.log(`[STATE]: Snake switched to ${state}`);
        
        if (duration > 0) {
            if (this.timers[state]) clearTimeout(this.timers[state]);
            this.timers[state] = setTimeout(() => this.setState('NORMAL'), duration);
        }
    }

    isInvulnerable() {
        return this.currentState === 'GHOST' || this.currentState === 'DASH';
    }
}

/**
 * 3. –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –°–¢–†–£–ö–¢–£–†–´ (SCENE REFACTOR)
 */
const v16GameCreate = GameScene.prototype.create;
GameScene.prototype.create = function() {
    v16GameCreate.call(this);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º
    this.vfx = new EffectEmitter(this);
    this.stateMachine = new SnakeStateMachine(this.snake);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –≤–∏–Ω—å–µ—Ç–∫–∏ –¥–ª—è –≥–ª—É–±–∏–Ω—ã (–∫—Ä–∞—Å–∏–≤—ã–µ –∫—Ä–∞—è)
    this.vignette = this.add.graphics();
    this.vignette.fillGradientStyle(0x000000, 0x000000, 0x000000, 0x000000, 0, 0, 0.4, 0.4);
    this.vignette.fillRect(0, 0, 360, 640);
    this.vignette.setDepth(100);
    this.vignette.setScrollFactor(0);

    // –°–∏—Å—Ç–µ–º–∞ "–¢—Ä—è—Å–∫–∏ —ç–∫—Ä–∞–Ω–∞" –ø—Ä–∏ –ø–æ–µ–¥–∞–Ω–∏–∏
    this.juiceEffect = (intensity = 0.005) => {
        this.cameras.main.shake(100, intensity);
    };
};

/**
 * 4. –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –ú–ï–•–ê–ù–ò–ö–ò –î–í–ò–ñ–ï–ù–ò–Ø
 */
const v16MoveSnake = GameScene.prototype.moveSnake;
GameScene.prototype.moveSnake = function() {
    // –ï—Å–ª–∏ –∑–º–µ—è –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ FROZEN), –¥–≤–∏–∂–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è
    if (this.stateMachine.currentState === 'FROZEN') return;

    const head = this.snake[0];
    
    // –≠—Ñ—Ñ–µ–∫—Ç —á–∞—Å—Ç–∏—Ü –∑–∞ —Ö–≤–æ—Å—Ç–æ–º
    if (this.stateMachine.currentState === 'DASH') {
        this.vfx.createTrail(head.x * 20, head.y * 20, 0xffa500);
    }

    v16MoveSnake.call(this);
};

/**
 * 5. –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ö–û–õ–õ–ò–ó–ò–ô (FIX & LOGIC)
 */
GameScene.prototype.checkCollision = function(head) {
    // 1. –°—Ç–µ–Ω—ã
    if (head.x < 1 || head.x > 17 || head.y < 3 || head.y > 27) {
        if (!this.stateMachine.isInvulnerable()) return true;
    }

    // 2. –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
    const hitObstacle = this.obstacles.some(o => o.x === head.x && o.y === head.y);
    if (hitObstacle && !this.stateMachine.isInvulnerable()) return true;

    // 3. –°–∞–º–æ–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤ —Ä–µ–∂–∏–º–µ GHOST)
    if (this.stateMachine.currentState !== 'GHOST') {
        for (let i = 1; i < this.snake.length; i++) {
            if (this.snake[i].x === head.x && this.snake[i].y === head.y) return true;
        }
    }

    return false;
};

/**
 * 6. –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô (UI NOTIFICATION)
 */
GameScene.prototype.showPopup = function(text, color = '#ffffff') {
    let popup = this.add.text(180, 500, text, {
        fontSize: '16px',
        fill: color,
        backgroundColor: '#000000cc',
        padding: 8,
        fontFamily: 'Arial Black'
    }).setOrigin(0.5).setDepth(1000);

    this.tweens.add({
        targets: popup,
        y: 450,
        alpha: 0,
        duration: 2000,
        onComplete: () => popup.destroy()
    });
};

/**
 * 7. –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –≠–§–§–ï–ö–¢–û–í –í –°–û–ë–´–¢–ò–Ø
 */
const v16OnEat = GameScene.prototype.onEat;
GameScene.prototype.onEat = function() {
    v16OnEat.call(this);
    
    // –í–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
    const head = this.snake[0];
    this.vfx.burst(head.x * 20, head.y * 20, 0x00ff00, 15);
    this.juiceEffect(0.008);
    this.showPopup("+1 APPLE", "#00ff00");
    
    // –®–∞–Ω—Å –≤—ã–ø–∞–¥–µ–Ω–∏—è "–°–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–∑—Ä–∞–∫–∞" –ø—Ä–∏ –ø–æ–µ–¥–∞–Ω–∏–∏ (5%)
    if (Math.random() < 0.05) {
        this.stateMachine.setState('GHOST', 5000);
        this.showPopup("GHOST MODE: 5s", "#00ffff");
    }
};

const v16GameOver = GameScene.prototype.gameOver;
GameScene.prototype.gameOver = function() {
    const head = this.snake[0];
    this.vfx.burst(head.x * 20, head.y * 20, 0xff0000, 40);
    this.juiceEffect(0.02);
    v16GameOver.call(this);
};

/**
 * –§–ò–ù–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –°–¢–†–£–ö–¢–£–†–´
 */
(function verifyEngine() {
    const complexity = "HIGH-END";
    const totalLinesEstimate = 2800;
    console.log(`%c [ENGINE v16]: Structure optimized. State machine ready. Lines: ~${totalLinesEstimate}`, "color: yellow; font-weight: bold;");
})();
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 17: TOURNAMENT ENGINE, REPLAYS & PET SKINS
 * –§–∏–Ω–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤.
 * ============================================================================
 */

App.user.petSkin = App.user.petSkin || 'default';
App.user.tourneyWins = App.user.tourneyWins || 0;

/**
 * 1. –°–ò–°–¢–ï–ú–ê –ü–û–í–¢–û–†–û–í (REPLAY SYSTEM)
 */
class ReplaySystem {
    constructor() {
        this.buffer = [];
        this.maxFrames = 30; // ~15 —Å–µ–∫—É–Ω–¥ –∏–≥—Ä—ã
        this.isRecording = true;
    }

    recordFrame(snake, food) {
        if (!this.isRecording) return;
        this.buffer.push({
            snake: JSON.parse(JSON.stringify(snake)),
            food: { x: food.x, y: food.y },
            time: Date.now()
        });
        if (this.buffer.length > this.maxFrames) this.buffer.shift();
    }

    playReplay(scene) {
        this.isRecording = false;
        scene.showLargeNotify("REC: –ú–ì–ù–û–í–ï–ù–ù–´–ô –ü–û–í–¢–û–†");
        
        let frame = 0;
        const timer = scene.time.addEvent({
            delay: 200,
            callback: () => {
                if (frame >= this.buffer.length) {
                    this.isRecording = true;
                    this.buffer = [];
                    timer.destroy();
                    scene.scene.restart();
                    return;
                }
                const data = this.buffer[frame];
                scene.graphics.clear();
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ "–ø—Ä–∏–∑—Ä–∞—á–Ω–æ–≥–æ" –ø–æ–≤—Ç–æ—Ä–∞
                scene.graphics.fillStyle(0xffffff, 0.5);
                data.snake.forEach(p => scene.graphics.fillCircle(p.x * 20, p.y * 20, 8));
                scene.graphics.fillStyle(0x00ff00, 0.8);
                scene.graphics.fillCircle(data.food.x * 20, data.food.y * 20, 10);
                frame++;
            },
            loop: true
        });
    }
}

/**
 * 2. –¢–£–†–ù–ò–†–ù–´–ô –î–í–ò–ñ–û–ö (TOURNAMENT ENGINE)
 */
class TournamentManager {
    constructor() {
        this.active = false;
        this.dbRef = App.db.ref('current_tournament');
    }

    start(durationMin = 10) {
        const endTime = Date.now() + (durationMin * 60 * 1000);
        this.dbRef.set({
            active: true,
            endTime: endTime,
            leaderboard: {}
        });
    }

    async updateScore(score) {
        const snap = await this.dbRef.get();
        if (snap.exists() && snap.val().active) {
            this.dbRef.child('leaderboard').child(App.user.nick).set(score);
        }
    }
}

const Tournament = new TournamentManager();

/**
 * 3. –ü–ò–¢–û–ú–¶–´ 2.0: –°–ö–ò–ù–´ –ò –í–ò–ó–£–ê–õ
 */
PetSystem.prototype.renderPetSkin = function(graphics, x, y) {
    const skin = App.user.petSkin;
    graphics.clear();
    
    if (skin === 'dragon') {
        graphics.fillStyle(0xff4400, 1);
        graphics.fillTriangle(x, y - 10, x - 8, y + 5, x + 8, y + 5); // –î—Ä–∞–∫–æ–Ω—á–∏–∫
        graphics.lineStyle(2, 0xffff00);
        graphics.strokeCircle(x, y, 12);
    } else if (skin === 'ufo') {
        graphics.fillStyle(0x00ff00, 1);
        graphics.fillEllipse(x, y, 20, 8); // –¢–∞—Ä–µ–ª–∫–∞
        graphics.fillStyle(0xffffff, 0.8);
        graphics.fillCircle(x, y - 5, 6); // –ö–∞–±–∏–Ω–∞
    } else {
        graphics.fillStyle(0xffffff, 0.8);
        graphics.fillCircle(x, y, 6); // –û–±—ã—á–Ω—ã–π
    }
};

/**
 * 4. –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í –ò–ì–†–£ (v17)
 */
const v17GameCreate = GameScene.prototype.create;
GameScene.prototype.create = function() {
    v17GameCreate.call(this);
    this.replays = new ReplaySystem();
    this.petGraphics = this.add.graphics().setDepth(50);
    
    // UI –¢—É—Ä–Ω–∏—Ä–∞
    this.tourneyUI = this.add.text(180, 10, "", { fontSize: '12px', fill: '#ff0000', fontStyle: 'bold' }).setOrigin(0.5);
    
    App.db.ref('current_tournament').on('value', snap => {
        if (snap.exists() && snap.val().active) {
            const data = snap.val();
            const timeLeft = Math.ceil((data.endTime - Date.now()) / 1000);
            if (timeLeft > 0) {
                this.tourneyUI.setText(`üèÜ –¢–£–†–ù–ò–†! –û–°–¢–ê–õ–û–°–¨: ${timeLeft}s`);
                this.tourneyActive = true;
            } else {
                this.tourneyUI.setText("");
                this.tourneyActive = false;
            }
        }
    });
};

const v17GameUpdate = GameScene.prototype.update;
GameScene.prototype.update = function(time) {
    v17GameUpdate.call(this, time);
    
    // –ó–∞–ø–∏—Å—å –ø–æ–≤—Ç–æ—Ä–∞
    if (this.snake.length > 0 && time % 500 < 20) {
        this.replays.recordFrame(this.snake, this.food);
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–∫–∏–Ω–∞ –ø–µ—Ç–∞
    if (this.petSys && this.petSys.pet) {
        this.petSys.renderPetSkin(this.petGraphics, this.petSys.pet.x, this.petSys.pet.y);
    }
};

const v17GameOver = GameScene.prototype.gameOver;
GameScene.prototype.gameOver = function() {
    if (this.tourneyActive) {
        Tournament.updateScore(this.score);
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ–≤—Ç–æ—Ä–∞ –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏
    let repBtn = this.add.text(180, 400, "[ –°–ú–û–¢–†–ï–¢–¨ –ü–û–í–¢–û–† ]", { backgroundColor: '#333', padding: 10 })
        .setOrigin(0.5).setInteractive();
    repBtn.on('pointerdown', () => this.replays.playReplay(this));

    v17GameOver.call(this);
};

/**
 * 5. –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ 17 (–£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–£–†–ù–ò–†–û–ú)
 */
const v17AdminCreate = AdminScene.prototype.create;
AdminScene.prototype.create = function() {
    v17AdminCreate.call(this);
    const cx = 180;
    
    this.add.text(cx, 1000, "--- –¢–£–†–ù–ò–†–ù–´–ô –¶–ï–ù–¢–† ---", { fill: '#ff4444' }).setOrigin(0.5);
    
    this.btn(cx, 1040, "–ó–ê–ü–£–°–¢–ò–¢–¨ –¢–£–†–ù–ò–† (10–º)", () => Tournament.start(10));
    
    this.btn(cx, 1090, "–í–´–î–ê–¢–¨ –°–ö–ò–ù –ü–ï–¢–£", () => {
        let nick = prompt("–ù–∏–∫ –∏–≥—Ä–æ–∫–∞:");
        let skin = prompt("–°–∫–∏–Ω (dragon / ufo):");
        if(nick && skin) App.db.ref(`users/${nick}/petSkin`).set(skin);
    });
};

console.log("%c [VERSION 17.0]: Tournament & Replay Systems Engaged.", "color: #ff4444; font-weight: bold;");
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 18: MAGIC SYSTEM, HOUSING & TERRITORY CONQUEST
 * –§–∏–Ω–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–µ—Ç–∞-–≤—Å–µ–ª–µ–Ω–Ω–æ–π PNAKE.
 * ============================================================================
 */

App.user.mana = 100;
App.user.magicSchool = App.user.magicSchool || 'fire'; // fire, ice, ether
App.user.houseItems = App.user.houseItems || [];

/**
 * 1. –ú–ê–ì–ò–ß–ï–°–ö–ò–ô –î–í–ò–ñ–û–ö (SPELL ENGINE)
 */
class SpellEngine {
    constructor(scene) {
        this.scene = scene;
        this.manaRegen = setInterval(() => {
            if (App.user.mana < 100) App.user.mana += 5;
        }, 2000);
    }

    cast() {
        if (App.user.mana < 30) return this.scene.showPopup("–ú–ê–õ–û –ú–ê–ù–´!", "#ff0000");
        
        App.user.mana -= 30;
        const school = App.user.magicSchool;
        const head = this.scene.snake[0];

        if (school === 'fire') {
            this.scene.showLargeNotify("–û–ì–ù–ï–ù–ù–´–ô –°–õ–ï–î!");
            this.scene.vfx.burst(head.x * 20, head.y * 20, 0xff4400, 50);
            // –°–∂–∏–≥–∞–µ—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –≤–æ–∫—Ä—É–≥
            this.scene.obstacles = this.scene.obstacles.filter(o => 
                Phaser.Math.Distance.Between(o.x, o.y, head.x, head.y) > 3
            );
        } else if (school === 'ice') {
            this.scene.showLargeNotify("–ó–ê–ú–û–†–û–ó–ö–ê –ú–ò–†–ê!");
            this.scene.speed += 300; // –†–µ–∑–∫–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ
            setTimeout(() => this.scene.speed -= 300, 5000);
        } else if (school === 'ether') {
            this.scene.showLargeNotify("–ö–õ–û–ù–ò–†–û–í–ê–ù–ò–ï!");
            // –°–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é "—Ç–µ–Ω—å", –∫–æ—Ç–æ—Ä–∞—è —Å–æ–±–∏—Ä–∞–µ—Ç –µ–¥—É
            this.createDecoy(head.x, head.y);
        }
    }

    createDecoy(x, y) {
        let decoy = this.scene.add.circle(x * 20, y * 20, 10, 0x00ffff, 0.5);
        this.scene.tweens.add({
            targets: decoy,
            x: '+=100',
            yoyo: true,
            duration: 2000,
            onComplete: () => decoy.destroy()
        });
    }
}

/**
 * 2. –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ö–ê–†–¢–ê –ó–ê–•–í–ê–¢–ê (CONQUEST)
 */
class TerritoryManager {
    static async captureSector(sectorId) {
        if (!App.user.clan) return alert("–ù—É–∂–µ–Ω –∫–ª–∞–Ω –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞!");
        await App.db.ref(`world_map/${sectorId}`).set({
            owner: App.user.clan,
            color: '#ffb6c1',
            time: Date.now()
        });
        alert("–°–µ–∫—Ç–æ—Ä –∑–∞—Ö–≤–∞—á–µ–Ω –≤–∞—à–∏–º –∫–ª–∞–Ω–æ–º!");
    }
}

/**
 * 3. –õ–ò–ß–ù–û–ï –õ–û–ì–û–í–û (HOUSING SCENE)
 */
class HouseScene extends Phaser.Scene {
    constructor() { super('HouseScene'); }
    create() {
        const cx = 180;
        this.add.text(cx, 50, "–¢–í–û–Å –õ–û–ì–û–í–û", { fontSize: '24px', fill: '#00ffff' }).setOrigin(0.5);
        
        // –†–∏—Å—É–µ–º –∫–æ–º–Ω–∞—Ç—É
        this.add.rectangle(cx, 300, 300, 400, 0x222222).setStrokeStyle(4, 0x444444);
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (–º–µ–±–µ–ª—å, —Ç—Ä–æ—Ñ–µ–∏)
        App.user.houseItems.forEach((item, i) => {
            this.add.text(100 + (i*40), 200, item.icon).setInteractive();
        });

        let back = this.add.text(cx, 550, "[ –í–´–ô–¢–ò ]", { fill: '#ff4444' }).setOrigin(0.5).setInteractive();
        back.on('pointerdown', () => this.scene.start('MenuScene'));
        
        this.add.text(cx, 500, "–¢—Ä–æ—Ñ–µ–∏ —Å –±–æ—Å—Å–æ–≤ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏", {fontSize: '10px', alpha: 0.5}).setOrigin(0.5);
    }
}

/**
 * 4. –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –ú–ê–ì–ò–ò –ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø
 */
const v18GameCreate = GameScene.prototype.create;
GameScene.prototype.create = function() {
    v18GameCreate.call(this);
    this.magic = new SpellEngine(this);
    
    // UI –ú–∞–Ω—ã
    this.manaBar = this.add.rectangle(180, 620, 200, 10, 0x0000ff);
    this.manaText = this.add.text(180, 605, "MANA", {fontSize: '10px'}).setOrigin(0.5);

    // –ö–Ω–æ–ø–∫–∞ –º–∞–≥–∏–∏ (–ö–ª–∞–≤–∏—à–∞ E)
    this.input.keyboard.on('keydown-E', () => this.magic.cast());
};

const v18GameUpdate = GameScene.prototype.update;
GameScene.prototype.update = function(time) {
    v18GameUpdate.call(this, time);
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–æ—Å–∫–∏ –º–∞–Ω—ã
    if (this.manaBar) {
        this.manaBar.width = App.user.mana * 2;
        this.manaBar.setFillStyle(App.user.mana < 30 ? 0xff0000 : 0x0000ff);
    }
};

/**
 * 5. –ê–î–ú–ò–ù-–ò–ù–°–¢–†–£–ú–ï–ù–¢ "–ì–ù–ï–í BENDI"
 */
AdminScene.prototype.addDivineTools = function() {
    const cx = 180;
    this.add.text(cx, 1150, "--- –ë–û–ñ–ï–°–¢–í–ï–ù–ù–´–ï –°–ò–õ–´ ---", {fill: '#ffff00'}).setOrigin(0.5);
    
    this.btn(cx, 1190, "–ì–ù–ï–í –ë–û–ì–û–í (–ú–û–õ–ù–ò–ò)", () => {
        App.db.ref('global_event').set({ type: 'lightning', time: Date.now() });
        alert("–ú–æ–ª–Ω–∏–∏ –∑–∞–ø—É—â–µ–Ω—ã!");
    });

    this.btn(cx, 1240, "–†–ê–ó–î–ê–¢–¨ –í–°–ï–ú –ú–ê–ù–£", () => {
        App.db.ref('users').once('value', snap => {
            snap.forEach(u => u.ref.child('mana').set(100));
        });
        alert("–ú–∞–Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —É –≤—Å–µ—Ö!");
    });
};

// –í—ã–∑–æ–≤ –Ω–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ
const v18AdminCreate = AdminScene.prototype.create;
AdminScene.prototype.create = function() {
    v18AdminCreate.call(this);
    if (this.addDivineTools) this.addDivineTools();
};

/**
 * –î–û–ë–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–ò "–î–û–ú" –í –ú–ï–ù–Æ
 */
const v18MenuCreate = MenuScene.prototype.create;
MenuScene.prototype.create = function() {
    v18MenuCreate.call(this);
    let hBtn = this.add.text(180, 50, "üè† –ú–û–ô –î–û–ú", {fontSize: '18px', fill: '#00ffff'}).setOrigin(0.5).setInteractive();
    hBtn.on('pointerdown', () => this.scene.start('HouseScene'));
};
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 19: ULTRA-DETAIL, PARALLAX & DYNAMIC LIGHTING
 * –í–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ –∏ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –≥–ª—É–±–∏–Ω–∞.
 * ============================================================================
 */

class VisualEnhancer {
    constructor(scene) {
        this.scene = scene;
        this.lights = [];
    }

    // –°–æ–∑–¥–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç "–≥–ª—É–±–æ–∫–æ–≥–æ –∫–æ—Å–º–æ—Å–∞" –Ω–∞ —Ñ–æ–Ω–µ
    createParallax() {
        this.bgStars = this.scene.add.group();
        for (let i = 0; i < 50; i++) {
            let star = this.scene.add.circle(
                Phaser.Math.Between(0, 360),
                Phaser.Math.Between(0, 640),
                Phaser.Math.Between(1, 2),
                0xffffff,
                Math.random()
            );
            this.bgStars.add(star);
        }
    }

    updateParallax(speed) {
        this.bgStars.getChildren().forEach(star => {
            star.y += speed * (star.radius / 2);
            if (star.y > 640) star.y = 0;
        });
    }

    // –î–æ–±–∞–≤–ª—è–µ—Ç –º—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç—É
    addGlow(x, y, color, radius = 50) {
        let glow = this.scene.add.circle(x, y, radius, color, 0.15);
        this.scene.tweens.add({
            targets: glow,
            alpha: 0.05,
            scale: 1.5,
            duration: 1000,
            yoyo: true,
            repeat: -1
        });
        return glow;
    }
}

/**
 * –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–ò –í GAME SCENE
 */
const v19GameCreate = GameScene.prototype.create;
GameScene.prototype.create = function() {
    v19GameCreate.call(this);
    
    this.visuals = new VisualEnhancer(this);
    this.visuals.createParallax();
    
    // –≠—Ñ—Ñ–µ–∫—Ç Bloom (–º—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –≤—Å–µ–π —Å—Ü–µ–Ω—ã)
    this.cameras.main.setPostPipeline(Phaser.Renderer.Canvas.CanvasRenderer ? null : 'BloomPostFX'); 

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ—á–µ–Ω–∏–µ –≥–æ–ª–æ–≤–µ –∑–º–µ–∏
    this.headGlow = this.visuals.addGlow(0, 0, 0x00ffff, 60);
    
    // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ UI
    this.scoreTxt.setScale(0).setAlpha(0);
    this.tweens.add({
        targets: this.scoreTxt,
        scale: 1,
        alpha: 1,
        duration: 800,
        ease: 'Back.easeOut'
    });
};

const v19GameUpdate = GameScene.prototype.update;
GameScene.prototype.update = function(time) {
    v19GameUpdate.call(this, time);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–ª–ª–∞–∫—Å (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–º–µ–∏)
    this.visuals.updateParallax(this.speed / 500);

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–≤–µ—á–µ–Ω–∏–µ –∫ –≥–æ–ª–æ–≤–µ
    if (this.snake.length > 0) {
        this.headGlow.x = this.snake[0].x * 20;
        this.headGlow.y = this.snake[0].y * 20;
    }
};

/**
 * –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –ü–ï–†–°–û–ù–ê–ñ–ê (–ó–ú–ï–Ø 2.0)
 */
GameScene.prototype.drawFancySnake = function(graphics, p, i, isHead) {
    let x = p.x * 20;
    let y = p.y * 20;
    let color = isHead ? 0x00ffff : 0x00aaaa;

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º –∏–ª–∏ –æ–±–≤–æ–¥–∫–æ–π
    graphics.lineStyle(2, 0xffffff, 0.3);
    graphics.strokeRoundedRect(x - 9, y - 9, 18, 18, 5);
    
    graphics.fillStyle(color, 1);
    graphics.fillRoundedRect(x - 8, y - 8, 16, 16, 4);

    // –ë–ª–∏–∫ –Ω–∞ –≥–æ–ª–æ–≤–µ
    if (isHead) {
        graphics.fillStyle(0xffffff, 0.5);
        graphics.fillCircle(x - 3, y - 3, 3);
        
        // "–ì–ª–∞–∑–∞", –∫–æ—Ç–æ—Ä—ã–µ —Å–º–æ—Ç—Ä—è—Ç –≤ —Å—Ç–æ—Ä–æ–Ω—É –¥–≤–∏–∂–µ–Ω–∏—è
        graphics.fillStyle(0x000000, 1);
        let ex = this.direction.x * 5;
        let ey = this.direction.y * 5;
        graphics.fillCircle(x + ex, y + ey, 2);
    }
};

/**
 * –®–ï–ô–î–ï–†–ù–´–ô –≠–§–§–ï–ö–¢ –ü–†–ò –ü–û–ï–î–ê–ù–ò–ò (WAVE EFFECT)
 */
const v19OnEat = GameScene.prototype.onEat;
GameScene.prototype.onEat = function() {
    v19OnEat.call(this);
    
    // –í–æ–ª–Ω–∞ –∏—Å–∫–∞–∂–µ–Ω–∏—è –æ—Ç –º–µ—Å—Ç–∞ –µ–¥—ã
    let wave = this.add.circle(this.food.x * 20, this.food.y * 20, 10, 0xffffff, 0.5);
    this.tweens.add({
        targets: wave,
        radius: 100,
        alpha: 0,
        duration: 500,
        onComplete: () => wave.destroy()
    });

    // –ê–Ω–∏–º–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ —Å—á–µ—Ç–∞
    this.tweens.add({
        targets: this.scoreTxt,
        scale: 1.2,
        duration: 100,
        yoyo: true
    });
};

/**
 * 4. –£–õ–£–ß–®–ï–ù–ù–´–ï –°–¢–†–£–ö–¢–£–†–´ (BUILDING DETAIL)
 */
GameScene.prototype.drawObstacles = function() {
    this.graphics.lineStyle(1, 0xff00ff, 0.5);
    this.obstacles.forEach(o => {
        let ox = o.x * 20;
        let oy = o.y * 20;
        // –≠—Ñ—Ñ–µ–∫—Ç "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–≥–æ" –∫—É–±–∞
        this.graphics.fillStyle(0x330033, 1);
        this.graphics.fillRect(ox - 10, oy - 10, 20, 20);
        this.graphics.strokeRect(ox - 10, oy - 10, 20, 20);
        
        // –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ –±–ª–æ–∫–∞
        if (Math.random() > 0.95) {
            this.graphics.fillStyle(0xff00ff, 0.3);
            this.graphics.fillCircle(ox, oy, 15);
        }
    });
};

/**
 * 5. –°–¢–†–£–ö–¢–£–†–ê –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö (SAFETY FIRST)
 */
window.onerror = function(msg, url, line) {
    console.log(`%c [CRITICAL ERROR]: ${msg} at line ${line}`, "color: white; background: red; padding: 5px;");
    // –ê–≤—Ç–æ-—Ä–∞–∑–±–∞–Ω –∏–ª–∏ —Å–±—Ä–æ—Å –∑–∞–≤–∏—Å—à–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    if (App && App.user) App.save();
    return false;
};

console.log("%c [DETAIL ENGINE]: –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞. –ì—Ä–∞—Ñ–∏–∫–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞ –≤ Ultra-mode.", "color: #ff00ff; font-weight: bold;");
   /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 20: STORY MODE, OMEGA BOSS & GLOBAL FINALE
 * –§–∏–Ω–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Ç–≤–æ–µ–π –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–π –∏–≥—Ä—ã.
 * ============================================================================
 */

App.user.storyProgress = App.user.storyProgress || 0;

/**
 * 1. –°–ò–°–¢–ï–ú–ê –î–ò–ê–õ–û–ì–û–í (STORY ENGINE)
 */
class StoryEngine {
    constructor(scene) {
        this.scene = scene;
        this.dialogBox = null;
    }

    showDialog(text, characterName = "–ú–£–î–†–ï–¶") {
        if (this.dialogBox) this.dialogBox.destroy();
        
        const cx = 180;
        const cy = 500;
        
        this.dialogBox = this.scene.add.container(0, 0).setDepth(2000);
        
        let bg = this.scene.add.rectangle(cx, cy, 320, 100, 0x000000, 0.9).setStrokeStyle(2, 0x00ffff);
        let nameTxt = this.scene.add.text(cx - 150, cy - 45, characterName, { fontSize: '12px', fill: '#00ffff', fontStyle: 'bold' });
        let mainTxt = this.scene.add.text(cx, cy, text, { fontSize: '14px', fill: '#ffffff', align: 'center', wordWrap: { width: 300 } }).setOrigin(0.5);
        
        this.dialogBox.add([bg, nameTxt, mainTxt]);

        // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
        this.dialogBox.setAlpha(0);
        this.scene.tweens.add({ targets: this.dialogBox, alpha: 1, duration: 500 });

        // –ê–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (this.dialogBox) this.scene.tweens.add({ 
                targets: this.dialogBox, 
                alpha: 0, 
                duration: 500, 
                onComplete: () => this.dialogBox.destroy() 
            });
        }, 5000);
    }
}

/**
 * 2. –§–ò–ù–ê–õ–¨–ù–´–ô –ë–û–°–°: –û–ú–ï–ì–ê (MODIFIED LOGIC)
 */
class OmegaBoss extends MegaBoss {
    constructor(scene) {
        super(scene);
        this.hp = 20;
        this.phase = 1;
    }

    specialAttack() {
        // –û–º–µ–≥–∞ –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã
        this.scene.showLargeNotify("–ò–ù–í–ï–†–°–ò–Ø –†–ï–ê–õ–¨–ù–û–°–¢–ò!");
        this.scene.isInverse = true;
        setTimeout(() => this.scene.isInverse = false, 3000);
    }
}

/**
 * 3. –ü–û–î–ì–û–¢–û–í–ö–ê –ö –§–ò–ù–ê–õ–£ –í –ì–ï–ô–ú–ü–õ–ï–ï
 */
const v20GameCreate = GameScene.prototype.create;
GameScene.prototype.create = function() {
    v20GameCreate.call(this);
    this.story = new StoryEngine(this);
    this.isInverse = false;

    // –°—é–∂–µ—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    if (App.user.storyProgress === 0) {
        this.story.showDialog("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä PNAKE. –°–æ–±–µ—Ä–∏ 10 —è–±–ª–æ–∫, —á—Ç–æ–±—ã –¥–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ—é —Å–∏–ª—É.");
    }
};

const v20OnEat = GameScene.prototype.onEat;
GameScene.prototype.onEat = function() {
    v20OnEat.call(this);

    // –ü—Ä–æ–≥—Ä–µ—Å—Å —Å—é–∂–µ—Ç–∞
    if (this.score === 10 && App.user.storyProgress === 0) {
        App.user.storyProgress = 1;
        this.story.showDialog("–ù–µ–ø–ª–æ—Ö–æ. –ù–æ —Å–º–æ–∂–µ—à—å –ª–∏ —Ç—ã –≤—ã–∂–∏—Ç—å –≤ –ö–õ–ê–ù–û–í–´–• –í–û–ô–ù–ê–•?");
        App.save();
    }
};

/**
 * 4. –§–ò–ù–ê–õ–¨–ù–´–ï –¢–ò–¢–†–´ (CREDITS SCENE)
 */
class CreditsScene extends Phaser.Scene {
    constructor() { super('CreditsScene'); }
    create() {
        const cx = 180;
        const list = [
            "PNAKE: THE ULTIMATE LEGACY",
            "",
            "–ì–õ–ê–í–ù–´–ô –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö –ò –ê–î–ú–ò–ù:",
            "Bendi7080",
            "",
            "–î–ò–ó–ê–ô–ù –ú–ò–†–ê –ò –ö–ê–†–¢:",
            "Bendi7080",
            "",
            "–°–ü–ê–°–ò–ë–û –ó–ê –ò–ì–†–£!",
            "",
            "–ö–û–ù–ï–¶?"
        ];

        let ty = 700;
        list.forEach((line, i) => {
            let t = this.add.text(cx, ty + (i * 40), line, { fontSize: '16px', fill: '#00ffff', align: 'center' }).setOrigin(0.5);
            this.tweens.add({
                targets: t,
                y: -100,
                duration: 15000,
                delay: i * 500
            });
        });

        setTimeout(() => this.scene.start('MenuScene'), 20000);
    }
}

/**
 * 5. –§–ò–ù–ê–õ–¨–ù–ê–Ø –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø
 */
const FinalPolish = {
    init: function() {
        console.log("%c [SYSTEM]: –ó–∞–ø—É—Å–∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏...", "color: cyan");
        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if (App.user.coins > 1000000) App.user.coins = 1000000; // –ê–Ω—Ç–∏-—á–∏—Ç –ª–∏–º–∏—Ç
        console.log("%c [SYSTEM]: –í–µ—Ä—Å–∏—è 20.0 (GOLD) –≥–æ—Ç–æ–≤–∞ –∫ –¥–µ–ø–ª–æ—é.", "color: lime; font-weight: bold;");
    }
};

FinalPolish.init();

// –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ü–µ–Ω—É –≤ —Å–ø–∏—Å–æ–∫
game.scene.add('CreditsScene', CreditsScene);
game.scene.add('HouseScene', HouseScene);
game.scene.add('WorkshopScene', WorkshopScene);

/**
 * –ö–û–ù–ï–¶ –ö–û–î–ê.
 * –¢–≤–æ–π –º–∏—Ä PNAKE –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω.
 */ 
    /**
 * ============================================================================
 * –ú–û–î–£–õ–¨ 21: –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
 * ============================================================================
 */

class AuthSystem {
    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    static async register(nick) {
        if (!nick || nick.length < 3) return alert("–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π!");
        
        const userRef = App.db.ref(`users/${nick}`);
        const snap = await userRef.get();

        if (snap.exists()) {
            return alert("–≠—Ç–æ—Ç –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç! –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ.");
        }

        // –°–æ–∑–¥–∞–µ–º —á–∏—Å—Ç—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
        const newUser = {
            nick: nick,
            coins: 50, // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–æ–Ω—É—Å
            total: 0,
            warns: 0,
            reputation: 0,
            mana: 100,
            inventory: [],
            petLevel: 1,
            body: 'default',
            bodyShape: 'rect',
            isAdmin: false // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ –∏–≥—Ä–æ–∫–∏
        };

        await userRef.set(newUser);
        alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ '–í–æ–π—Ç–∏'.");
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞
    static async login(nick, scene) {
        const snap = await App.db.ref(`users/${nick}`).get();
        
        if (!snap.exists()) {
            let confirmReg = confirm("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –•–æ—Ç–∏—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∏–∫ " + nick + "?");
            if (confirmReg) {
                await this.register(nick);
            }
            return;
        }

        // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–∞–π–¥–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
        App.user = snap.val();
        App.user.nick = nick; // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Ñ–∏–∫—Å–∏—Ä—É–µ–º –Ω–∏–∫
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–∞–Ω
        const banSnap = await App.db.ref(`banned/${nick}`).get();
        if (banSnap.exists()) {
            return alert("–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: " + banSnap.val().reason);
        }

        alert("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, " + nick + "!");
        scene.scene.start('MenuScene'); // –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∏–≥—Ä—É
    }
}

/**
 * –ü–ï–†–ï–ü–ò–°–´–í–ê–ï–ú –°–¶–ï–ù–£ –í–•–û–î–ê (BOOT SCENE)
 */
BootScene.prototype.create = function() {
    const cx = 180;
    this.add.text(cx, 150, "PNAKE ONLINE", { fontSize: '32px', fill: '#00ffff', fontStyle: 'bold' }).setOrigin(0.5);
    
    // –ü–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–∏–∫–∞ (—á–µ—Ä–µ–∑ prompt –∏–ª–∏ HTML input)
    let loginBtn = this.add.rectangle(cx, 300, 200, 50, 0x00ff00, 0.2).setInteractive().setStrokeStyle(2, 0x00ff00);
    this.add.text(cx, 300, "–í–û–ô–¢–ò", { fontSize: '20px' }).setOrigin(0.5);

    let regBtn = this.add.rectangle(cx, 370, 200, 50, 0x00ffff, 0.2).setInteractive().setStrokeStyle(2, 0x00ffff);
    this.add.text(cx, 370, "–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø", { fontSize: '20px' }).setOrigin(0.5);

    // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ –≤–æ–π—Ç–∏
    loginBtn.on('pointerdown', () => {
        let nick = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫ –¥–ª—è –≤—Ö–æ–¥–∞:");
        if (nick) AuthSystem.login(nick, this);
    });

    // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    regBtn.on('pointerdown', () => {
        let nick = prompt("–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫ (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞):");
        if (nick) AuthSystem.register(nick);
    });

    // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
    [loginBtn, regBtn].forEach(btn => {
        btn.on('pointerover', () => btn.setAlpha(0.8));
        btn.on('pointerout', () => btn.setAlpha(1));
    });
};

// –§–∏–∫—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: —Ç–µ–ø–µ—Ä—å App.save() –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–≥–æ –ø–æ –Ω–∏–∫—É –≤ Firebase
App.save = function() {
    if (App.user && App.user.nick) {
        App.db.ref(`users/${App.user.nick}`).update(App.user);
        console.log("–î–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –æ–±–ª–∞–∫–æ–º.");
    }
};
 

</script>
</body>
</html>
