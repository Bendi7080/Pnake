<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNAKE: LEGENDS | OFFICIAL</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #ff00ff; font-family: 'Courier New', monospace; overflow: hidden; }
        #game-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { border: 3px solid #ff00ff; box-shadow: 0 0 20px #ff00ff; }
        .ui-overlay { position: absolute; top: 10px; left: 10px; pointer-events: none; }
    </style>
</head>
<body>
    <div id="game-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- КОНФИГУРАЦИЯ FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCr28iNiurXgoZwbxOfast8R26ZiwVAR5Y",
            authDomain: "pnake3.firebaseapp.com",
            databaseURL: "https://pnake3-default-rtdb.firebaseio.com",
            projectId: "pnake3",
            storageBucket: "pnake3.firebasestorage.app",
            messagingSenderId: "796701048320",
            appId: "1:796701048320:web:d88d06ada6e6e15a52e2e5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
        window.playerData = { uid: null, nick: '', zmenets: 0, level: 1, xp: 0, role: 'user', skin: 0xff00ff };

        // --- 1. СЦЕНА ЗАГРУЗКИ (BOOT) ---
        class BootScene extends Phaser.Scene {
            constructor() { super('BootScene'); }
            preload() {
                this.add.text(400, 300, "ЗАГРУЗКА НЕОНА...", { fill: '#ff00ff' }).setOrigin(0.5);
            }
            create() { this.scene.start('AuthScene'); }
        }

        // --- 2. СЦЕНА АВТОРИЗАЦИИ (AUTH) ---
        class AuthScene extends Phaser.Scene {
            constructor() { super('AuthScene'); }
            create() {
                this.add.text(400, 150, "PNAKE: LEGENDS", { fontSize: '50px', fill: '#ff00ff', fontStyle: 'bold' }).setOrigin(0.5);
                
                let btn = this.add.rectangle(400, 350, 300, 60, 0xff00ff).setInteractive();
                this.add.text(400, 350, "ВОЙТИ В СЕТЬ", { fontSize: '24px', fill: '#000' }).setOrigin(0.5);

                btn.on('pointerdown', () => this.handleAuth());
            }

            async handleAuth() {
                let nick = prompt("Никнейм:");
                let pass = prompt("Пароль:");
                if (!nick || !pass) return;

                const userRef = ref(db, 'users/' + nick);
                const snap = await get(userRef);

                if (snap.exists()) {
                    let data = snap.val();
                    if (data.pass === pass) {
                        window.playerData = { ...data, uid: nick };
                        this.scene.start('MainMenu');
                    } else { alert("Ошибка пароля!"); }
                } else {
                    let newUser = { nick, pass, zmenets: 100, level: 1, xp: 0, role: (nick === 'Bendi7080' ? 'admin' : 'user') };
                    if (nick === 'Bendi7080' && pass !== 'BestEhsona') return alert("Доступ запрещен!");
                    await set(userRef, newUser);
                    window.playerData = { ...newUser, uid: nick };
                    this.scene.start('MainMenu');
                }
            }
        }

        // --- 3. ГЛАВНОЕ МЕНЮ (MAIN MENU) ---
        class MainMenu extends Phaser.Scene {
            constructor() { super('MainMenu'); }
            create() {
                this.add.text(400, 80, `ПРИВЕТ, ${window.playerData.nick}`, { fontSize: '32px', fill: '#00ffff' }).setOrigin(0.5);
                this.add.text(400, 130, `Зменеты: ${window.playerData.zmenets} | LVL: ${window.playerData.level}`, { fill: '#fff' }).setOrigin(0.5);

                const btns = [
                    { t: 'ИГРАТЬ', s: 'GameScene' },
                    { t: 'МАГАЗИН', s: 'ShopScene' },
                    { t: 'РЕКОРДЫ', s: 'Leaderboard' }
                ];

                btns.forEach((b, i) => {
                    let rect = this.add.rectangle(400, 250 + (i * 70), 250, 50, 0x330033).setStrokeStyle(2, 0xff00ff).setInteractive();
                    this.add.text(400, 250 + (i * 70), b.t, { fontSize: '20px' }).setOrigin(0.5);
                    rect.on('pointerdown', () => this.scene.start(b.s));
                });

                if (window.playerData.role === 'admin') {
                    let adminBtn = this.add.circle(750, 50, 30, 0xff0000).setInteractive();
                    this.add.text(750, 50, "⚙", { fontSize: '30px' }).setOrigin(0.5);
                    adminBtn.on('pointerdown', () => this.scene.start('AdminPanel'));
                }
            }
        }

        // --- 4. ИГРОВОЙ ПРОЦЕСС (GAME SCENE) ---
        class GameScene extends Phaser.Scene {
            constructor() { super('GameScene'); }
            init() {
                this.snake = [];
                this.dir = 'RIGHT';
                this.nextDir = 'RIGHT';
                this.moveTimer = 0;
                this.speed = 150;
                this.score = 0;
                this.applesEaten = 0;
            }

            create() {
                this.bg = this.add.rectangle(400, 300, 800, 600, 0x000000).setOrigin(0.5);
                for(let i=0; i<5; i++) { this.snake.push(this.add.rectangle(100 - (i*20), 100, 18, 18, window.playerData.skin || 0xff00ff).setStrokeStyle(2, 0xffffff)); }
                
                this.spawnFood();
                this.cursors = this.input.keyboard.createCursorKeys();
                this.scoreText = this.add.text(20, 20, `Счет: 0`, { fill: '#00ffff' });

                // Музыка (Синтезатор)
                this.initMusic();
            }

            initMusic() {
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            playBeep(freq) {
                let osc = this.audioCtx.createOscillator();
                let g = this.audioCtx.createGain();
                osc.frequency.value = freq;
                g.gain.value = 0.1;
                osc.connect(g); g.connect(this.audioCtx.destination);
                osc.start(); osc.stop(this.audioCtx.currentTime + 0.1);
            }

            spawnFood() {
                if(this.food) this.food.destroy();
                let x = Phaser.Math.Between(1, 39) * 20;
                let y = Phaser.Math.Between(1, 29) * 20;
                this.food = this.add.circle(x, y, 8, 0xffff00);
                this.add.particles(x, y, 'p', { speed: 50, scale: {start: 0.2, end: 0}, lifespan: 500, duration: 200 });
            }

            update(time) {
                if (this.cursors.left.isDown && this.dir !== 'RIGHT') this.nextDir = 'LEFT';
                else if (this.cursors.right.isDown && this.dir !== 'LEFT') this.nextDir = 'RIGHT';
                else if (this.cursors.up.isDown && this.dir !== 'DOWN') this.nextDir = 'UP';
                else if (this.cursors.down.isDown && this.dir !== 'UP') this.nextDir = 'DOWN';

                if (time > this.moveTimer) {
                    this.moveSnake();
                    this.moveTimer = time + this.speed;
                }
            }

            moveSnake() {
                this.dir = this.nextDir;
                let h = this.snake[0];
                let nx = h.x; let ny = h.y;

                if (this.dir === 'LEFT') nx -= 20;
                else if (this.dir === 'RIGHT') nx += 20;
                else if (this.dir === 'UP') ny -= 20;
                else if (this.dir === 'DOWN') ny += 20;

                if (nx < 0 || nx >= 800 || ny < 0 || ny >= 600) return this.endGame();

                if (nx === this.food.x && ny === this.food.y) {
                    this.score += 10;
                    this.applesEaten++;
                    this.scoreText.setText(`Счет: ${this.score}`);
                    this.playBeep(880);
                    this.cameras.main.shake(100, 0.005);
                    this.spawnFood();
                    if(this.applesEaten % 5 === 0) { this.bg.setFillStyle(Phaser.Display.Color.RandomRGB().color, 0.15); }
                } else {
                    let tail = this.snake.pop();
                    tail.x = nx; tail.y = ny;
                    this.snake.unshift(tail);
                }
            }

            async endGame() {
                alert("КОНЕЦ ИГРЫ! Счет: " + this.score);
                const r = ref(db, 'users/' + window.playerData.uid);
                await update(r, { 
                    zmenets: window.playerData.zmenets + Math.floor(this.score/2),
                    xp: window.playerData.xp + this.score 
                });
                this.scene.start('MainMenu');
            }
        }

        // --- 5. МАГАЗИН (SHOP) ---
        class ShopScene extends Phaser.Scene {
            constructor() { super('ShopScene'); }
            create() {
                this.add.text(400, 50, "НЕОНОВЫЙ ШОП", { fontSize: '32px', fill: '#ff00ff' }).setOrigin(0.5);
                let items = [
                    { n: 'Циан скин', p: 50, c: 0x00ffff },
                    { n: 'Лайм скин', p: 100, c: 0x00ff00 },
                    { n: 'Голд скин', p: 500, c: 0xffff00 }
                ];

                items.forEach((item, i) => {
                    let b = this.add.rectangle(400, 150 + (i*80), 300, 50, 0x222222).setStrokeStyle(2, item.c).setInteractive();
                    this.add.text(400, 150 + (i*80), `${item.n} - ${item.p} ZM`).setOrigin(0.5);
                    b.on('pointerdown', () => this.buy(item));
                });

                this.add.text(400, 500, "НАЗАД", { fill: '#fff' }).setOrigin(0.5).setInteractive().on('pointerdown', () => this.scene.start('MainMenu'));
            }

            async buy(item) {
                if (window.playerData.zmenets >= item.p) {
                    window.playerData.zmenets -= item.p;
                    window.playerData.skin = item.c;
                    await update(ref(db, 'users/' + window.playerData.uid), { zmenets: window.playerData.zmenets, skin: item.c });
                    alert("Успешно куплено!");
                } else { alert("Мало зменетов!"); }
            }
        }

        // --- 6. АДМИН-ПАНЕЛЬ (ADMIN) ---
        class AdminPanel extends Phaser.Scene {
            constructor() { super('AdminPanel'); }
            create() {
                this.add.text(400, 50, "ПАНЕЛЬ BENDI7080", { fontSize: '32px', fill: '#ff0000' }).setOrigin(0.5);
                
                let btn1 = this.add.rectangle(400, 200, 300, 50, 0x440000).setInteractive();
                this.add.text(400, 200, "ДАЙ 5000 ЗМЕНЕТОВ").setOrigin(0.5);
                
                btn1.on('pointerdown', async () => {
                    window.playerData.zmenets += 5000;
                    await update(ref(db, 'users/' + window.playerData.uid), { zmenets: window.playerData.zmenets });
                    alert("Зачислено!");
                });

                let btn2 = this.add.rectangle(400, 300, 300, 50, 0x004400).setInteractive();
                this.add.text(400, 300, "ОТПРАВИТЬ КВЕСТ").setOrigin(0.5);
                btn2.on('pointerdown', () => {
                    let msg = prompt("Текст квеста:");
                    if(msg) set(ref(db, 'global/quest'), { text: msg, date: Date.now() });
                });

                this.add.text(400, 500, "ВЫХОД", { fill: '#fff' }).setOrigin(0.5).setInteractive().on('pointerdown', () => this.scene.start('MainMenu'));
            }
        }

        // --- ЗАПУСК ---
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            scene: [BootScene, AuthScene, MainMenu, GameScene, ShopScene, AdminPanel]
        };
        new Phaser.Game(config);

    </script>
</body>
</html>
